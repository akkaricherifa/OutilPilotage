{% extends 'statistiques/base.html' %}

{% block title %}ARION - Recherche - AppISIS{% endblock %}

{% block extra_css %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap4.min.css">

<style>
    :root {
        /* Couleurs ISIS basées sur la charte graphique */
        --isis-purple-dark: #2f0d73;    /* Violet foncé principal */
        --isis-purple: #7c50de;         /* Violet principal */
        --isis-purple-light: #ac54c7;   /* Violet clair */
        --isis-coral: #f56960;          /* Corail/rouge */
        --isis-coral-light: #ffb43c;    /* Orange/jaune */
        --isis-teal: #3cbebe;           /* Turquoise */
        
        --sidebar-bg: #ffffff;
        --sidebar-hover: rgba(124, 80, 222, 0.1);
        --sidebar-active: linear-gradient(135deg, #7c50de 0%, #f56960 100%);
        --card-shadow: 0 4px 15px rgba(124, 80, 222, 0.15);
        --card-shadow-hover: 0 8px 25px rgba(124, 80, 222, 0.25);
        --transition-speed: 0.3s;
    }

    /* Cards statistiques */
    .stat-card {
        transition: transform 0.2s;
        border-left: 4px solid;
        margin-bottom: 20px;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .stat-card-publications { border-left-color: #2f0d73; }
    .stat-card-projets { border-left-color: #7c50de; }
    .stat-card-collaborations { border-left-color: #ac54c7; }
    .stat-card-budget { border-left-color: #f56960; }
    
    /* Conteneurs de graphiques */
    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        border: 1px solid #e9ecef;
        height: 400px;
        transition: all var(--transition-speed) ease;
    }
    
    .chart-container:hover {
        box-shadow: var(--card-shadow-hover);
        transform: translateY(-5px);
    }
    
    .chart-container h5 {
        color: #2f0d73;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    
    /* En-tête avec dégradé et animation d'arrière-plan */
    .dashboard-header {
        background: linear-gradient(135deg, #2f0d73 0%, #7c50de 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        position: relative;
        overflow: hidden;
    }
    
    /* Animation d'arrière-plan */
    .dashboard-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        bottom: -50%;
        left: -50%;
        background: linear-gradient(
            45deg,
            rgba(124, 80, 222, 0.1) 0%,
            rgba(172, 84, 199, 0.1) 25%,
            rgba(245, 105, 96, 0.1) 50%,
            rgba(255, 180, 60, 0.1) 75%,
            rgba(60, 190, 190, 0.1) 100%
        );
        transform: rotate(15deg);
        z-index: 0;
        animation: gradientMove 15s ease infinite;
    }
    
    @keyframes gradientMove {
        0% {
            transform: rotate(15deg) translateY(-10%);
        }
        50% {
            transform: rotate(10deg) translateY(10%);
        }
        100% {
            transform: rotate(15deg) translateY(-10%);
        }
    }
    
    /* Contenu de l'en-tête */
    .dashboard-header .header-content {
        position: relative;
        z-index: 1;
    }
    
    .dashboard-header h1 {
        margin: 0;
        font-weight: 600;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .dashboard-header p {
        margin-bottom: 0;
    }
    
    /* Grille des statistiques */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    /* Grille des graphiques */
    .chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 30px;
    }
    
    /* Style des modales */
    .modal-header-custom {
        background: linear-gradient(135deg, #2f0d73 0%, #7c50de 100%);
        color: white;
    }
    
    /* Personnalisation des formulaires */
    .form-control:focus {
        border-color: #7c50de;
        box-shadow: 0 0 0 0.2rem rgba(124, 80, 222, 0.25);
    }
    
    /* Boutons personnalisés */
    .btn-primary-custom {
        background: linear-gradient(135deg, #2f0d73 0%, #7c50de 100%);
        border: none;
        color: white;
        transition: all 0.3s ease;
    }
    
    .btn-primary-custom:hover {
        background: linear-gradient(135deg, #7c50de 0%, #ac54c7 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(124, 80, 222, 0.4);
    }

    /* Style pour les canvas de graphiques */
    canvas {
        max-height: 300px;
    }
    
    /* Styles spécifiques à Arion */
    .arion-info-box {
        display: flex;
        flex-direction: column;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    #arionTable {
        font-size: 0.85rem; /* Taille de police réduite */
    }
    
    .arion-info-fields {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
    }
    
    /* Badge pour statut */
    .status-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .status-active {
        background-color: rgba(60, 190, 190, 0.2);
        color: #3cbebe;
    }
    
    .status-inactive {
        background-color: rgba(245, 105, 96, 0.2);
        color: #f56960;
    }
    
    .status-pending {
        background-color: rgba(255, 180, 60, 0.2);
        color: #ffb43c;
    }
    
    /* Styles pour les tableaux de formateurs */
    .nav-tabs .nav-link {
        color: #495057;
        border: 1px solid transparent;
        border-top-left-radius: .25rem;
        border-top-right-radius: .25rem;
        padding: 0.5rem 1rem;
        font-weight: 500;
    }

    .nav-tabs .nav-link.active {
        color: var(--isis-purple);
        background-color: #fff;
        border-color: #dee2e6 #dee2e6 #fff;
        border-bottom: 2px solid var(--isis-purple);
    }

    .nav-tabs .nav-link:hover {
        border-color: #e9ecef #e9ecef #dee2e6;
    }

    .tab-content {
        padding: 1rem;
        border: 1px solid #dee2e6;
        border-top: none;
        border-radius: 0 0 0.25rem 0.25rem;
    }

    .table-sm td, .table-sm th {
        padding: 0.5rem;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(124, 80, 222, 0.05);
    }
    
    /* Style pour la pagination des tableaux */
    .dataTables_wrapper .dataTables_paginate .paginate_button {
        border-radius: 50px;
        padding: 5px 12px;
        margin: 0 3px;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button.current,
    .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {
        background: linear-gradient(135deg, var(--isis-purple-dark) 0%, var(--isis-purple) 100%);
        color: white !important;
        border: 1px solid var(--isis-purple);
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
        background: rgba(124, 80, 222, 0.1);
        color: var(--isis-purple-dark) !important;
        border: 1px solid transparent;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .chart-grid {
            grid-template-columns: 1fr;
        }
        
        .dashboard-header .d-flex {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .action-buttons {
            margin-top: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- En-tête du dashboard avec animation d'arrière-plan -->
<div class="dashboard-header">
    <div class="d-flex justify-content-between align-items-center header-content">
        <div>
            <h1><i class="fas fa-microscope mr-3"></i>ARION - Plateforme de Recherche</h1>
            <p class="mb-0">Gestion des activités et projets de recherche</p>
        </div>
        <div class="action-buttons d-flex flex-wrap">
            <button class="btn btn-light btn-lg mr-2" data-toggle="modal" data-target="#addDataModal">
                <i class="fas fa-plus mr-2"></i>Ajouter des données
            </button>
            <button class="btn btn-success btn-lg" data-toggle="modal" data-target="#uploadCSVModal">
                <i class="fas fa-file-upload mr-2"></i>Importer CSV
            </button>
        </div>
    </div>
</div>

<!-- Contenu principal (sans la sidebar des filtres) -->
<div class="row">
    <div class="col-md-12">

        <!-- Graphiques (optionnels, à adapter selon vos besoins) -->
        <div class="chart-grid">
        
            <!-- Graphique 2: Évolution mensuelle -->
            <div class="chart-container">
               <div class="d-flex justify-content-between align-items-center mb-3">
               <h5><i class="fas fa-chart-line mr-2"></i>Évolution mensuelle</h5>
               <select id="yearFilter" class="form-control" style="width: 150px;">
               <option value="all">Toutes les années</option>
              <!-- Les options seront ajoutées dynamiquement via JavaScript -->
                </select>
             </div>
                  <canvas id="monthlyEvolutionChart"></canvas>
            </div>
            <div class="chart-container">
                <h5><i class="fas fa-users mr-2"></i>Répartition par statut de formateur</h5>
                <canvas id="statusChart"></canvas>
            </div>
        </div>
        <!-- Tableaux des formateurs par statut -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="chart-container" style="height: auto;">
            <h5><i class="fas fa-user-tag mr-2"></i>Formateurs par statut</h5>
            
            <!-- Onglets pour les différents statuts -->
            <ul class="nav nav-tabs" id="formateursTab" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="vacataires-tab" data-toggle="tab" href="#vacataires" role="tab">
                        <i class="fas fa-user-tie mr-1"></i>Vacataires
                        <span class="badge badge-pill badge-danger ml-1" id="count-vacataires">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="enseignants-tab" data-toggle="tab" href="#enseignants" role="tab">
                        <i class="fas fa-chalkboard-teacher mr-1"></i>Enseignants
                        <span class="badge badge-pill badge-primary ml-1" id="count-enseignants">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="personnel-tab" data-toggle="tab" href="#personnel" role="tab">
                        <i class="fas fa-user-cog mr-1"></i>Personnel non enseignant
                        <span class="badge badge-pill badge-warning ml-1" id="count-personnel">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="nonspecifie-tab" data-toggle="tab" href="#nonspecifie" role="tab">
                        <i class="fas fa-question-circle mr-1"></i>Non spécifié
                        <span class="badge badge-pill badge-secondary ml-1" id="count-nonspecifie">0</span>
                    </a>
                </li>
            </ul>
            
            <!-- Contenu des onglets -->
            <div class="tab-content mt-3" id="formateursTabContent">
                <!-- Vacataires -->
                <div class="tab-pane fade show active" id="vacataires" role="tabpanel">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover" id="tableVacataires">
                            <thead class="thead-light">
                                <tr>
                                    <th>Nom du formateur</th>
                                    <th>Nombre d'activités</th>
                                    <th>Heures totales</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="3" class="text-center">Chargement...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Enseignants -->
                <div class="tab-pane fade" id="enseignants" role="tabpanel">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover" id="tableEnseignants">
                            <thead class="thead-light">
                                <tr>
                                    <th>Nom du formateur</th>
                                    <th>Nombre d'activités</th>
                                    <th>Heures totales</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="3" class="text-center">Chargement...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Personnel non enseignant -->
                <div class="tab-pane fade" id="personnel" role="tabpanel">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover" id="tablePersonnel">
                            <thead class="thead-light">
                                <tr>
                                    <th>Nom du formateur</th>
                                    <th>Nombre d'activités</th>
                                    <th>Heures totales</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="3" class="text-center">Chargement...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Non spécifié -->
                <div class="tab-pane fade" id="nonspecifie" role="tabpanel">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover" id="tableNonSpecifie">
                            <thead class="thead-light">
                                <tr>
                                    <th>Nom du formateur</th>
                                    <th>Nombre d'activités</th>
                                    <th>Heures totales</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="3" class="text-center">Chargement...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
    </div>
     <!-- Tableau des données -->
        <div class="chart-container" style="height: auto;">
            <h5><i class="fas fa-table mr-2"></i>Données ARION</h5>
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="arionTable">
                    <thead style="background: linear-gradient(135deg, #2f0d73 0%, #7c50de 100%); color: white;">
                        <tr>
                            <th>Année</th>
                            <th>Formateur</th>
                            <th>Statut</th>
                            <th>Groupe</th>
                            <th>Activité</th>
                            <th>Code Y</th>
                            <th>Niveau</th>
                            <th>Date</th>
                            <th>Durée (h)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                  <tbody>
                        <tr>
                        <td colspan="10" class="text-center">Chargement des données...</td>
                        </tr>
                   </tbody>
                </table>
            </div>
        </div>
</div>

<!-- Modal Ajouter/Modifier des données -->
<div class="modal fade" id="addDataModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title" id="addDataModalTitle">
                    <i class="fas fa-plus-circle mr-2"></i>
                    Ajouter des données ARION
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="dataForm" method="post">
                {% csrf_token %}
                <input type="hidden" name="id" id="arion_id">
                <div class="modal-body">
                    <!-- Première ligne -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Année universitaire <span class="text-danger">*</span></label>
                                <select class="form-control" name="annee" id="annee" required>
                                    <option value="">Sélectionner une année</option>
                                    <option value="2023-2024">2023-2024</option>
                                    <option value="2024-2025">2024-2025</option>
                                    <option value="2025-2026">2025-2026</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Formateur <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="formateur" id="formateur" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Deuxième ligne -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Statut <span class="text-danger">*</span></label>
                                <select class="form-control" name="statut" id="statut" required>
                                    <option value="">Sélectionner un statut</option>
                                    <option value="Enseignant">Enseignants</option>
                                    <option value="Vacataire">Vacataires</option>
                                    <option value="Personnels non enseignant">Personnel non enseignant</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Groupe <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="groupe" id="groupe" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Activité (Séance) <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="activite" id="activite" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Troisième ligne -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Code Y <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="code_y" id="code_y" required>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <label>Information <span class="text-danger">*</span></label>
                            <div class="arion-info-box">
                                <div class="arion-info-fields">
                                    <div class="form-group mb-0">
                                        <label class="small">Niveau</label>
                                        <input type="text" class="form-control" name="niveau" id="niveau" required>
                                    </div>
                                    <div class="form-group mb-0">
                                        <label class="small">Lieu</label>
                                        <input type="text" class="form-control" name="lieu" id="lieu" required>
                                    </div>
                                    <div class="form-group mb-0">
                                        <label class="small">Intervenant</label>
                                        <input type="text" class="form-control" name="intervenant" id="intervenant" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quatrième ligne -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Date <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" name="date" id="date" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Durée en heures <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" name="duree" id="duree" required min="0" step="0.5">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary-custom">
                        <i class="fas fa-save mr-1"></i>Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Upload CSV -->
<div class="modal fade" id="uploadCSVModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title">
                    <i class="fas fa-file-upload mr-2"></i>
                    Importer un fichier CSV
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="uploadForm" method="post" action="" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group">
                        <label>Fichier CSV <span class="text-danger">*</span></label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="csvFile" name="file" accept=".csv" required>
                            <label class="custom-file-label" for="csvFile">Choisir un fichier...</label>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle mr-2"></i>Format attendu du fichier CSV :</h6>
                        <code>annee,formateur,statut,groupe,activite,code_y,niveau,lieu,intervenant,date,duree</code>
                        <hr>
                        <h6>Exemple :</h6>
                        <pre class="mb-0">2024-2025,Dr. Martin,Actif,Groupe A,TP Recherche,Y123,Master 2,Salle B12,Dr. Martin,2025-05-15,4
2024-2025,Dr. Dupont,En attente,Groupe B,Conférence,Y456,Doctorat,Amphithéâtre C,Dr. Dupont,2025-06-20,2</pre>
                    </div>
                    <div class="form-group">
                        <label>Année universitaire</label>
                        <select class="form-control" name="annee_import" required>
                            <option value="">Sélectionner une année</option>
                            <option value="2023-2024">2023-2024</option>
                            <option value="2024-2025">2024-2025</option>
                            <option value="2025-2026">2025-2026</option>
                        </select>
                        <small class="form-text text-muted">Cette année sera utilisée pour les enregistrements qui n'ont pas d'année spécifiée.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload mr-1"></i>Importer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de confirmation de suppression -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-trash mr-2"></i>
                    Confirmer la suppression
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir supprimer cette activité ARION ?</p>
                <p id="deleteDetails" class="font-weight-bold"></p>
                <small class="text-muted">Cette action est irréversible.</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                <form id="deleteForm" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger" id="confirmDelete">
                        <i class="fas fa-trash mr-1"></i>Supprimer
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<!-- DataTables JS -->
<script type="text/javascript" src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap4.min.js"></script>
<script>
    let availableYears = [];
// Définir l'URL de base pour les API
const API_BASE_URL = '/api';

// Initialiser la page au chargement
$(document).ready(function() {
    // Charger les données au démarrage
    loadArionData();
    
    // Charger les statistiques
    loadArionStats();
    loadAvailableYears();
    initCharts();
    // Charger les formateurs par statut
    loadFormateursByStatus(); 
    loadAndUpdateStatusPieChart();
    
    // Gestion du nom de fichier pour l'upload CSV
    $('.custom-file-input').on('change', function() {
        let fileName = $(this).val().split('\\').pop();
        $(this).siblings('.custom-file-label').addClass("selected").html(fileName);
    });
    
    // Écouter la soumission du formulaire d'ajout/modification
    $('#dataForm').on('submit', function(e) {
        e.preventDefault();
        submitFormData($(this));
    });
    
    // Écouter la soumission du formulaire d'import CSV
    $('#uploadForm').on('submit', function(e) {
        e.preventDefault();
        uploadCSV($(this));
    });
    
    // Écouter la soumission du formulaire de suppression
    $('#deleteForm').on('submit', function(e) {
        e.preventDefault();
        deleteArionData($(this));
    });
});

// Fonction pour charger les données ARION
function loadArionStats() {
    $.ajax({
        url: `${API_BASE_URL}/arion/stats`,
        type: 'GET',
        headers: {
            'Authorization': 'Bearer ' + getToken()
        },
        success: function(data) {
            // Mettre à jour les statistiques résumées
            $('#stat-publications').text(data.summary?.total_activites || 0);
            $('#stat-projets').text(data.summary?.formateurs_count || 0);
            $('#stat-collaborations').text(data.summary?.niveaux_count || 0);
            $('#stat-budget').text((data.summary?.total_duree || 0) + 'h');
            
            // Mettre à jour les graphiques
            updateCharts(data.graphiques);
            loadAndUpdateStatusPieChart();
            loadStatusStats();
        },
        error: function(xhr) {
            console.error('Erreur lors du chargement des statistiques:', xhr.responseText);
            showNotification('error', 'Erreur lors du chargement des statistiques ARION');
            loadStatusStats();
        }
    });
}

function loadAndUpdateStatusPieChart() {
    console.log("Chargement du graphique en camembert simplifié");
    
    // Si le graphique en barre existe et a des données, réutilisons-les
    if (window.statusChart && window.statusChart.data && 
        window.statusChart.data.labels && window.statusChart.data.datasets) {
        
        // Récupérer les labels et les valeurs du graphique en barre
        const labels = window.statusChart.data.labels;
        const values = window.statusChart.data.datasets[0].data;
        
        console.log("Données récupérées du graphique en barre:", labels, values);
        
        // Mettre à jour le graphique en camembert avec ces données
        updateStatusPieChartSimple(labels, values);
        return;
    }
}

// Fonction pour mettre à jour le graphique en camembert avec les données de statut
function updateStatusPieChart(labels, values) {
    console.log("Mise à jour simple du graphique en camembert avec:", labels, values);
    
    const yearCtx = document.getElementById('yearDistributionChart');
    if (!yearCtx) {
        console.error("Canvas 'yearDistributionChart' introuvable");
        return;
    }
    
    // Détruire le graphique existant s'il existe
    if (window.yearChart) {
        window.yearChart.destroy();
    }
    
    // Vérifier si nous avons des données valides
    if (!labels || !values || labels.length === 0 || values.length === 0) {
        console.warn("Pas de données pour le camembert");
        window.yearChart = new Chart(yearCtx, {
            type: 'pie',
            data: {
                labels: ['Aucune donnée'],
                datasets: [{
                    data: [1],
                    backgroundColor: ['#cccccc']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
        return;
    }
    
    // Couleurs pour les statuts
    const colors = {
        'Vacataires': '#f56960',
        'Enseignants': '#7c50de',
        'Personnels non enseignant': '#ffb43c',
        'Non spécifié': '#cccccc'
    };
    
    // Préparer les couleurs
    const backgroundColors = labels.map(label => colors[label] || '#3cbebe');
    
    // Calculer les pourcentages
    const total = values.reduce((sum, val) => sum + val, 0);
    const percentages = values.map(val => Math.round((val / total) * 100));
    
    // Labels avec pourcentages
    const labelsWithPercentages = labels.map((label, i) => 
        `${label} (${percentages[i]}%)`
    );
    
    // Créer le graphique
    window.yearChart = new Chart(yearCtx, {
        type: 'pie',
        data: {
            labels: labelsWithPercentages,
            datasets: [{
                data: values,
                backgroundColor: backgroundColors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
    
    console.log("Graphique en camembert créé avec succès!");
}

function loadStatusStats() {
    console.log("Chargement des statistiques par statut...");
    $.ajax({
        url: `${API_BASE_URL}/arion/data`,
        type: 'GET',
        headers: {
            'Authorization': 'Bearer ' + getToken()
        },
        success: function(data) {
            // Créer un dictionnaire pour compter les formateurs uniques par statut
            const formateurParStatut = {
                'Vacataires': new Set(),
                'Enseignants': new Set(),
                'Personnels non enseignant': new Set(),
                'Non spécifié': new Set()
            };
            
            // Parcourir toutes les données
            data.forEach(item => {
                // Récupérer le formateur
                const formateur = item.formateur;
                
                // Traiter seulement si le formateur est valide
                if (formateur && formateur !== "NaN" && formateur !== "null" && formateur !== "undefined") {
                    // Récupérer le statut et le normaliser
                    let statut = item.statut;
                    
                    // Si le statut est NaN ou autre valeur non valide, utiliser "Non spécifié"
                    if (!statut || statut === "NaN" || statut === "null" || statut === "undefined" || statut === "") {
                        formateurParStatut['Non spécifié'].add(formateur);
                    }
                    // Normaliser les noms de statuts
                    else if (statut === "Vacataire" || statut === "Vacataires") {
                        formateurParStatut['Vacataires'].add(formateur);
                    }
                    else if (statut === "Enseignant" || statut === "Enseignants") {
                        formateurParStatut['Enseignants'].add(formateur);
                    }
                    else if (statut === "Personnels non enseignant") {
                        formateurParStatut['Personnels non enseignant'].add(formateur);
                    }
                    // Tout autre statut va dans "Non spécifié"
                    else {
                        formateurParStatut['Non spécifié'].add(formateur);
                    }
                }
            });
            
            // Préparer les données pour le graphique
            const labels = [];
            const values = [];
            
            // Ne garder que les statuts qui ont des formateurs
            Object.keys(formateurParStatut).forEach(statut => {
                if (formateurParStatut[statut].size > 0) {
                    labels.push(statut);
                    values.push(formateurParStatut[statut].size);
                }
            });
            
            // Mettre à jour le graphique
            updateStatusChart({labels, values});
        },
        error: function(xhr) {
            console.error('Erreur lors du chargement des statistiques par statut:', xhr.responseText);
            updateStatusChart(getDefaultStatusData());
        }
    });
}

// Fonction pour charger les années disponibles
function loadAvailableYears() {
    $.ajax({
        url: `${API_BASE_URL}/arion/data`,
        type: 'GET',
        headers: {
            'Authorization': 'Bearer ' + getToken()
        },
        success: function(data) {
            console.log("Données reçues pour extraction des années:", data);
            const years = new Set();
            const academicYears = new Set(); // Pour stocker les années académiques complètes
            
            // Extraire les années de chaque enregistrement
            data.forEach(item => {
                if (item.annee) {
                    // Stocker l'année académique complète (ex: "2023-2024")
                    if (typeof item.annee === 'string' && item.annee.includes('-')) {
                        academicYears.add(item.annee);
                    }
                    
                    // Extraire les années individuelles
                    if (typeof item.annee === 'string') {
                        // Pour le format "2023-2024"
                        if (item.annee.includes('-')) {
                            const parts = item.annee.split('-');
                            if (parts.length === 2) {
                                const startYear = parts[0].trim();
                                const endYear = parts[1].trim();
                                
                                if (!isNaN(startYear) && startYear.length === 4) {
                                    years.add(startYear);
                                }
                                
                                if (!isNaN(endYear) && endYear.length === 4) {
                                    years.add(endYear);
                                }
                            }
                        } else if (!isNaN(item.annee) && item.annee.length === 4) {
                            // Pour les années simples en format string
                            years.add(item.annee);
                        }
                    } else if (typeof item.annee === 'number') {
                        // Pour les années en format nombre
                        years.add(item.annee.toString());
                    }
                }
            });
            
            // Convertir en tableau et trier
            availableYears = Array.from(years).sort();
            console.log("Années individuelles extraites:", availableYears);
            console.log("Années académiques complètes:", Array.from(academicYears));
            
            // Si aucune année trouvée, ajouter des années par défaut
            if (availableYears.length === 0) {
                availableYears = ["2023", "2024", "2025"];
                console.log("Aucune année trouvée, utilisation des années par défaut:", availableYears);
            }
            
            // Peupler la liste déroulante
            populateYearFilter(availableYears);
        },
        error: function(xhr) {
            console.error('Erreur lors du chargement des années:', xhr.responseText);
            // Fallback vers des années par défaut en cas d'erreur
            availableYears = ["2023", "2024", "2025"];
            populateYearFilter(availableYears);
        }
    });
}

// Fonction pour populer la liste déroulante des années
function populateYearFilter(years) {
    const yearFilter = $('#yearFilter');
    
    // Vider d'abord les options existantes sauf la première
    yearFilter.find('option:not(:first)').remove();
    
    // Ajouter les années comme options
    years.forEach(year => {
        yearFilter.append(`<option value="${year}">${year}</option>`);
    });
    
    // Configurer l'événement de changement
    yearFilter.off('change').on('change', function() {
        const selectedYear = $(this).val();
        updateMonthlyChart(selectedYear);
    });
}

// Fonction pour mettre à jour le graphique mensuel en fonction de l'année sélectionnée
function updateMonthlyChart(selectedYear = 'all') {
    $.ajax({
        url: `${API_BASE_URL}/arion/monthly_stats${selectedYear !== 'all' ? '?year=' + selectedYear : ''}`,
        type: 'GET',
        headers: {
            'Authorization': 'Bearer ' + getToken()
        },
        success: function(data) {
            // Mettre à jour le graphique avec les nouvelles données
            renderMonthlyChart(data);
        },
        error: function(xhr) {
            console.error('Erreur lors du chargement des statistiques mensuelles:', xhr.responseText);
            
            // En cas d'erreur, afficher un graphique vide
            renderMonthlyChart({
                labels: ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sep', 'Oct', 'Nov', 'Déc'],
                values: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
            });
        }
    });
}

// Fonction pour rendre le graphique mensuel
function renderMonthlyChart(data) {
    const monthlyCtx = document.getElementById('monthlyEvolutionChart');
    if (!monthlyCtx) return;
    
    // Détruire le graphique existant s'il existe
    if (window.monthlyChart) {
        window.monthlyChart.destroy();
    }
    
    // Vérifier si nous avons des données valides
    const labels = data.labels || ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sep', 'Oct', 'Nov', 'Déc'];
    const values = data.values || [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
    
    // Créer le graphique
    window.monthlyChart = new Chart(monthlyCtx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Nombre d\'activités',
                data: values,
                borderColor: '#7c50de',
                backgroundColor: 'rgba(124, 80, 222, 0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Nombre d\'activités'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Mois'
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Activités: ${context.raw}`;
                        }
                    }
                },
                title: {
                    display: true,
                    text: $('#yearFilter').val() === 'all' ? 'Toutes les années' : `Année: ${$('#yearFilter').val()}`,
                    font: {
                        size: 14
                    }
                }
            }
        }
    });
}

// Fonction pour charger les formateurs par statut
function loadFormateursByStatus() {
    console.log("Chargement des formateurs par statut...");
    
    $.ajax({
        url: `${API_BASE_URL}/arion/data`,
        type: 'GET',
        headers: {
            'Authorization': 'Bearer ' + getToken()
        },
        success: function(data) {
            // Objet pour stocker les formateurs par statut
            const formateursByStatus = {
                'Vacataires': {},
                'Enseignants': {},
                'Personnels non enseignant': {},
                'Non spécifié': {}
            };
            
            // Parcourir toutes les données pour regrouper par statut et formateur
            data.forEach(item => {
                // Récupérer le formateur et ses données
                const formateur = item.formateur;
                const duree = parseFloat(item.duree) || 0;
                
                // Traiter seulement si le formateur est valide
                if (formateur && formateur !== "NaN" && formateur !== "null" && formateur !== "undefined") {
                    // Normaliser le statut
                    let statut = item.statut;
                    
                    // Si le statut est NaN ou autre valeur non valide, utiliser "Non spécifié"
                    if (!statut || statut === "NaN" || statut === "null" || statut === "undefined" || statut === "") {
                        statut = 'Non spécifié';
                    }
                    // Normaliser les noms de statuts
                    else if (statut === "Vacataire" || statut === "Vacataires") {
                        statut = 'Vacataires';
                    }
                    else if (statut === "Enseignant" || statut === "Enseignants") {
                        statut = 'Enseignants';
                    }
                    else if (statut === "Personnels non enseignant") {
                        statut = 'Personnels non enseignant';
                    }
                    // Tout autre statut va dans "Non spécifié"
                    else {
                        statut = 'Non spécifié';
                    }
                    
                    // Initialiser les données pour ce formateur s'il n'existe pas encore
                    if (!formateursByStatus[statut][formateur]) {
                        formateursByStatus[statut][formateur] = {
                            activites: 0,
                            heures: 0
                        };
                    }
                    
                    // Incrémenter les compteurs
                    formateursByStatus[statut][formateur].activites++;
                    formateursByStatus[statut][formateur].heures += duree;
                }
            });
            
            // Mettre à jour les tableaux pour chaque statut
            updateFormateursTable('Vacataires', formateursByStatus['Vacataires'], 'tableVacataires', 'count-vacataires');
            updateFormateursTable('Enseignants', formateursByStatus['Enseignants'], 'tableEnseignants', 'count-enseignants');
            updateFormateursTable('Personnels non enseignant', formateursByStatus['Personnels non enseignant'], 'tablePersonnel', 'count-personnel');
            updateFormateursTable('Non spécifié', formateursByStatus['Non spécifié'], 'tableNonSpecifie', 'count-nonspecifie');
        },
        error: function(xhr) {
            console.error('Erreur lors du chargement des formateurs par statut:', xhr.responseText);
            showNotification('error', 'Erreur lors du chargement des formateurs par statut');
        }
    });
}

// Fonction pour mettre à jour un tableau de formateurs
function updateFormateursTable(statut, formateursData, tableId, countId) {
    const table = document.getElementById(tableId);
    if (!table) {
        console.error(`Table ${tableId} non trouvée`);
        return;
    }
    
    // Récupérer le body du tableau
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';
    
    // Obtenir tous les formateurs pour ce statut
    const formateurs = Object.keys(formateursData);
    
    // Mettre à jour le compteur
    document.getElementById(countId).textContent = formateurs.length;
    
    // Si aucun formateur, afficher un message
    if (formateurs.length === 0) {
        tbody.innerHTML = `<tr><td colspan="3" class="text-center">Aucun formateur ${statut}</td></tr>`;
        return;
    }
    
    // Trier les formateurs par nombre d'heures décroissant
    formateurs.sort((a, b) => formateursData[b].heures - formateursData[a].heures);
    
    // Ajouter chaque formateur au tableau
    formateurs.forEach(formateur => {
        const row = document.createElement('tr');
        
        // Cellule pour le nom du formateur
        const cellNom = document.createElement('td');
        cellNom.textContent = formateur;
        row.appendChild(cellNom);
        
        // Cellule pour le nombre d'activités
        const cellActivites = document.createElement('td');
        cellActivites.textContent = formateursData[formateur].activites;
        row.appendChild(cellActivites);
        
        // Cellule pour les heures totales
        const cellHeures = document.createElement('td');
        cellHeures.textContent = formateursData[formateur].heures.toFixed(1) + ' h';
        row.appendChild(cellHeures);
        
        // Ajouter la ligne au tableau
        tbody.appendChild(row);
    });
    
    // Initialiser DataTable avec pagination si ce n'est pas déjà fait
    if (!$.fn.DataTable.isDataTable('#' + tableId)) {
        $('#' + tableId).DataTable({
            "paging": true,
            "pageLength": 5,
            "lengthMenu": [5, 10, 15, 20],
            "searching": true,
            "ordering": true,
            "info": true,
            "autoWidth": false,
            "responsive": true,
            "language": {
                "emptyTable": "Aucune donnée disponible",
                "info": "Affichage de _START_ à _END_ sur _TOTAL_ formateurs",
                "infoEmpty": "Affichage de 0 à 0 sur 0 formateur",
                "infoFiltered": "(filtré depuis _MAX_ formateurs au total)",
                "lengthMenu": "Afficher _MENU_ formateurs par page",
                "search": "Rechercher :",
                "zeroRecords": "Aucun formateur correspondant trouvé",
                "paginate": {
                    "first": "Premier",
                    "last": "Dernier",
                    "next": "Suivant",
                    "previous": "Précédent"
                }
            }
        });
    } else {
        // Si DataTable existe déjà, simplement rafraîchir les données
        $('#' + tableId).DataTable().clear().draw();
        $('#' + tableId).DataTable().rows.add($(tbody).find('tr')).draw();
    }
}

// Fonction pour mettre à jour le graphique de statut
function updateStatusChart(statusData) {
    const statusCtx = document.getElementById('statusChart');
    if (!statusCtx) {
        console.error("Élément canvas 'statusChart' non trouvé");
        return;
    }
    
    // Détruire le graphique existant s'il existe
    if (window.statusChart && typeof window.statusChart.destroy === 'function') {
        window.statusChart.destroy();
    }

    if (!statusData || !statusData.labels || statusData.labels.length === 0 || !statusData.values) {
        console.warn("Données invalides pour le graphique");
        window.statusChart = new Chart(statusCtx, {
            type: 'bar',
            data: {
                labels: ['Aucune donnée'],
                datasets: [{
                    label: 'Nombre de formateurs',
                    data: [0],
                    backgroundColor: '#cccccc'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
        return;
    }
    
    // Définir des couleurs spécifiques pour chaque statut
    const colorMap = {
        'Vacataires': '#f56960',
        'Enseignants': '#7c50de',
        'Personnels non enseignant': '#ffb43c',
        'Non spécifié': '#cccccc'
    };
    
    // Préparer les couleurs
    const backgroundColors = statusData.labels.map(label => colorMap[label] || '#3cbebe');
    
    // Créer le graphique
    window.statusChart = new Chart(statusCtx, {
        type: 'bar',
        data: {
            labels: statusData.labels,
            datasets: [{
                label: 'Nombre de formateurs',
                data: statusData.values,
                backgroundColor: backgroundColors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Nombre de formateurs'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Statut'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Nombre: ${context.raw}`;
                        }
                    }
                }
            }
        }
    });
}

// Fonction pour charger les données ARION
function loadArionData() {
    // Afficher un indicateur de chargement
    const tableBody = $('#arionTable tbody');
    tableBody.html('<tr><td colspan="10" class="text-center">Chargement des données...</td></tr>');
    
    // Faire la requête AJAX
    $.ajax({
        url: `${API_BASE_URL}/arion/data`,
        type: 'GET',
        headers: {
            'Authorization': 'Bearer ' + getToken()
        },
        success: function(data) {
            console.log("Données reçues:", data); // Pour le débogage
            
            // Détruire le DataTable existant s'il existe
            if ($.fn.DataTable.isDataTable('#arionTable')) {
                $('#arionTable').DataTable().destroy();
            }
            
            // Vider le tableau
            tableBody.empty();
            
            if (!data || data.length === 0) {
                tableBody.html('<tr><td colspan="10" class="text-center">Aucune donnée disponible</td></tr>');
                initDataTable();
                return;
            }
            
            // Remplir le tableau avec les données
            data.forEach(function(item) {
                // Fonction pour vérifier si une valeur est valide (non NaN, non null, non undefined)
                const isValidValue = (val) => {
                    if (val === null || val === undefined) return false;
                    if (typeof val === 'number' && isNaN(val)) return false;
                    if (val === 'NaN' || val === 'null' || val === 'undefined') return false;
                    return true;
                };
                
                // Extraire et nettoyer les valeurs
                const annee = isValidValue(item.annee) ? item.annee : '';
                const formateur = isValidValue(item.formateur) ? item.formateur : '';
                
                // Gestion du statut et de la classe correspondante
                let statusText = isValidValue(item.statut) ? item.statut : 'Non spécifié';
                let statusClass = 'status-active';
                
                if (statusText === 'Vacataire' || statusText === 'Vacataires') {
                    statusClass = 'status-inactive';
                } else if (statusText === 'Personnels non enseignant') {
                    statusClass = 'status-pending';
                }
                
                const groupe = isValidValue(item.groupe) ? item.groupe : '';
                const activite = isValidValue(item.activite) ? item.activite : '';
                const codeY = isValidValue(item.code_y) ? item.code_y : '';
                const niveau = isValidValue(item.niveau) ? item.niveau : '';
                
                // Formatage de la date
                let formattedDate = '';
                if (isValidValue(item.date)) {
                    const dateStr = String(item.date);
                    if (dateStr.includes('-')) {
                        const dateParts = dateStr.split('-');
                        if (dateParts.length === 3) {
                            formattedDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
                        } else {
                            formattedDate = dateStr;
                        }
                    } else {
                        formattedDate = dateStr;
                    }
                }
                
                // Formatage de la durée
                const duree = isValidValue(item.duree) ? parseFloat(item.duree) : 0;
                
                // Création de la ligne HTML
                tableBody.append(`
                    <tr>
                        <td>${annee}</td>
                        <td>${formateur}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${groupe}</td>
                        <td>${activite}</td>
                        <td>${codeY}</td>
                        <td>${niveau}</td>
                        <td>${formattedDate}</td>
                        <td>${duree}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editData('${item.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete('${item.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });
            
            // Initialiser DataTable
            initDataTable();
        },
        error: function(xhr) {
            console.error('Erreur lors du chargement des données:', xhr.responseText);
            tableBody.html('<tr><td colspan="10" class="text-center text-danger">Erreur lors du chargement des données</td></tr>');
            showNotification('error', 'Erreur lors du chargement des données ARION');
        }
    });
}

// Initialiser les graphiques de façon statique temporairement
function initCharts() {
    // Graphique de répartition par année
    const yearCtx = document.getElementById('yearDistributionChart');
    if (yearCtx) {
        window.yearChart = new Chart(yearCtx, {
            type: 'pie',
            data: {
                labels: ['Aucune donnée'],
                datasets: [{
                    data: [1],
                    backgroundColor: ['#cccccc'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
    }
    
    updateMonthlyChart('all');
    
    // Graphique de statut des formateurs
    const statusCtx = document.getElementById('statusChart');
    if (statusCtx) {
        window.statusChart = new Chart(statusCtx, {
            type: 'bar',
            data: {
                labels: ['Aucune donnée'],
                datasets: [{
                    label: 'Nombre de formateurs',
                    data: [0],
                    backgroundColor: '#cccccc',
                    borderColor: '#aaaaaa',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Nombre de formateurs'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Statut'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
}

// Fonction pour initialiser DataTable
function initDataTable() {
    $('#arionTable').DataTable({
        "language": {
            // Traduction directe
            "emptyTable": "Aucune donnée disponible",
            "info": "Affichage de _START_ à _END_ sur _TOTAL_ entrées",
            "infoEmpty": "Affichage de 0 à 0 sur 0 entrées",
            "infoFiltered": "(filtré depuis _MAX_ entrées au total)",
            "lengthMenu": "Afficher _MENU_ entrées",
            "loadingRecords": "Chargement...",
            "processing": "Traitement...",
            "search": "Rechercher :",
            "zeroRecords": "Aucun résultat trouvé",
            "paginate": {
                "first": "Premier",
                "last": "Dernier",
                "next": "Suivant",
                "previous": "Précédent"
            }
        },
        "order": [[0, "desc"], [7, "desc"]],
        "pageLength": 4,
        "responsive": true
    });
}

// Fonction pour mettre à jour les graphiques
function updateCharts(graphiquesData) {
    // Si pas de données, initialiser avec des graphiques vides
    if (!graphiquesData) {
        initCharts();
        return;
    }
    
    // Graphique de répartition par année
    const yearCtx = document.getElementById('yearDistributionChart');
    if (yearCtx && graphiquesData.annees && graphiquesData.annees.labels && graphiquesData.annees.labels.length > 0) {
        // Détruire le graphique existant s'il existe
        if (window.yearChart) {
            window.yearChart.destroy();
        }
        
        window.yearChart = new Chart(yearCtx, {
            type: 'pie',
            data: {
                labels: graphiquesData.annees.labels,
                datasets: [{
                    data: graphiquesData.annees.values,
                    backgroundColor: ['#2f0d73', '#7c50de', '#ac54c7', '#f56960', '#ffb43c', '#3cbebe'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
    } else if (yearCtx && (!window.yearChart || window.yearChart.destroyed)) {
        // Si pas de données, initialiser avec un graphique vide
        window.yearChart = new Chart(yearCtx, {
            type: 'pie',
            data: {
                labels: ['Aucune donnée'],
                datasets: [{
                    data: [1],
                    backgroundColor: ['#cccccc'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
    }
    
    // Graphique d'évolution mensuelle
    const monthlyCtx = document.getElementById('monthlyEvolutionChart');
    if (monthlyCtx && graphiquesData.evolution_mensuelle && graphiquesData.evolution_mensuelle.labels && graphiquesData.evolution_mensuelle.labels.length > 0) {
        // Détruire le graphique existant s'il existe
        if (window.monthlyChart) {
            window.monthlyChart.destroy();
        }
        
        window.monthlyChart = new Chart(monthlyCtx, {
            type: 'line',
            data: {
                labels: graphiquesData.evolution_mensuelle.labels,
                datasets: [{
                    label: 'Activités',
                    data: graphiquesData.evolution_mensuelle.values,
                    borderColor: '#7c50de',
                    backgroundColor: 'rgba(124, 80, 222, 0.1)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Nombre d\'activités'
                        }
                    }
                }
            }
        });
    } else if (monthlyCtx && (!window.monthlyChart || window.monthlyChart.destroyed)) {
        // Si pas de données, initialiser avec un graphique vide
        window.monthlyChart = new Chart(monthlyCtx, {
            type: 'line',
            data: {
                labels: ['Aucune donnée'],
                datasets: [{
                    label: 'Activités',
                    data: [0],
                    borderColor: '#7c50de',
                    backgroundColor: 'rgba(124, 80, 222, 0.1)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Nombre d\'activités'
                        }
                    }
                }
            }
        });
    }
}

// Fonction pour soumettre le formulaire d'ajout/modification
function submitFormData(form) {
    // Valider le formulaire côté client
    if (!validateForm()) {
        return false;
    }
    
    // Afficher un indicateur de chargement
    const submitBtn = form.find('button[type="submit"]');
    const originalBtnText = submitBtn.html();
    submitBtn.html('<i class="fas fa-spinner fa-spin mr-1"></i>Traitement...').prop('disabled', true);
    
    // Préparer les données du formulaire
    const formData = {};
    form.serializeArray().forEach(item => {
        formData[item.name] = item.value;
    });
    
    // Envoyer les données via AJAX
    $.ajax({
        url: `${API_BASE_URL}/arion/add`,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        headers: {
            'Authorization': 'Bearer ' + getToken(),
            'X-CSRFToken': $('input[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            // Fermer la modal
            $('#addDataModal').modal('hide');
            
            // Réinitialiser le formulaire
            form[0].reset();
            
            // Afficher une notification de succès
            showNotification('success', response.message || 'Données enregistrées avec succès !');
            
            // Rafraîchir les données après un court délai
            setTimeout(function() {
                loadArionData();
                loadArionStats();
            }, 500);
        },
        error: function(xhr) {
            // Afficher une notification d'erreur
            try {
                const response = JSON.parse(xhr.responseText);
                showNotification('error', response.error || 'Une erreur est survenue');
            } catch (e) {
                showNotification('error', 'Erreur lors de l\'enregistrement des données');
            }
        },
        complete: function() {
            // Restaurer le bouton
            submitBtn.html(originalBtnText).prop('disabled', false);
        }
    });
}

// Fonction pour télécharger un fichier CSV
function uploadCSV(form) {
    // Valider que le fichier est bien un CSV
    const fileInput = $('#csvFile')[0];
    if (fileInput.files.length === 0) {
        showNotification('error', 'Veuillez sélectionner un fichier CSV');
        return false;
    }
    
    const fileName = fileInput.files[0].name;
    if (!fileName.endsWith('.csv')) {
        showNotification('error', 'Le fichier doit être au format CSV');
        return false;
    }
    
    // Afficher un indicateur de chargement
    const submitBtn = form.find('button[type="submit"]');
    const originalBtnText = submitBtn.html();
    submitBtn.html('<i class="fas fa-spinner fa-spin mr-1"></i>Importation...').prop('disabled', true);
    
    // Créer un objet FormData pour l'upload de fichier
    const formData = new FormData(form[0]);
    
    // Envoyer les données via AJAX
    $.ajax({
        url: `${API_BASE_URL}/arion/upload`,
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'Authorization': 'Bearer ' + getToken(),
            'X-CSRFToken': $('input[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            // Fermer la modal
            $('#uploadCSVModal').modal('hide');
            
            // Afficher une notification de succès
            showNotification('success', `${response.records_inserted} enregistrements importés avec succès !`);
            
            // Rafraîchir les données après un court délai
            setTimeout(function() {
                loadArionData();
                loadArionStats();
            }, 500);
        },
        error: function(xhr) {
            // Afficher une notification d'erreur
            try {
                const response = JSON.parse(xhr.responseText);
                showNotification('error', response.error || 'Une erreur est survenue lors de l\'import');
            } catch (e) {
                showNotification('error', 'Erreur lors de l\'importation du fichier CSV');
            }
        },
        complete: function() {
            // Restaurer le bouton
            submitBtn.html(originalBtnText).prop('disabled', false);
            
            // Réinitialiser le champ de fichier
            form[0].reset();
            $('.custom-file-label').text('Choisir un fichier...');
        }
    });
}

// Fonction pour valider le formulaire
function validateForm() {
    // Vérifier les champs obligatoires
    const requiredFields = [
        'annee', 'formateur', 'statut', 'groupe', 'activite', 
        'code_y', 'niveau', 'date', 'duree'
    ];
    
    let isValid = true;
    
    requiredFields.forEach(field => {
        const value = $(`#${field}`).val();
        if (!value || value.trim() === '') {
            showNotification('error', `Le champ "${field}" est obligatoire`);
            $(`#${field}`).addClass('is-invalid');
            isValid = false;
        } else {
            $(`#${field}`).removeClass('is-invalid');
        }
    });
    
    // Vérifier que la durée est positive
    const duree = parseFloat($('#duree').val());
    if (isNaN(duree) || duree <= 0) {
        showNotification('error', 'La durée doit être un nombre positif');
        $('#duree').addClass('is-invalid');
        isValid = false;
    }
    
    return isValid;
}

// Fonction pour éditer les données existantes
function editData(id) {
    // Réinitialiser le formulaire
    $('#dataForm')[0].reset();
    
    // Mettre à jour le titre de la modal
    $('#addDataModalTitle').html('<i class="fas fa-edit mr-2"></i>Modifier les données ARION');
    
    // Afficher un indicateur de chargement
    showNotification('info', 'Chargement des données...');
    
    // Récupérer les données de l'élément à modifier
    $.ajax({
        url: `${API_BASE_URL}/arion/data`,
        type: 'GET',
        headers: {
            'Authorization': 'Bearer ' + getToken()
        },
        data: { id: id },  // Ajouter l'ID comme paramètre de requête
        success: function(data) {
            console.log("Données reçues pour édition:", data);
            
            // Vérifier que des données ont été trouvées
            if (data && data.length > 0) {
                const item = data[0];
                
                // Remplir le formulaire avec les données
                $('#arion_id').val(item.id);
                $('#annee').val(item.annee || '');
                $('#formateur').val(item.formateur || '');
                $('#statut').val(item.statut || '');
                $('#groupe').val(item.groupe || '');
                $('#activite').val(item.activite || '');
                $('#code_y').val(item.code_y || '');
                $('#niveau').val(item.niveau || '');
                $('#lieu').val(item.lieu || '');
                $('#intervenant').val(item.intervenant || '');
                
                // Formater la date pour l'input date (YYYY-MM-DD)
                if (item.date) {
                    let dateValue = item.date;
                    // Si la date est au format DD/MM/YYYY, la convertir en YYYY-MM-DD
                    if (dateValue.includes('/')) {
                        const parts = dateValue.split('/');
                        dateValue = `${parts[2]}-${parts[1]}-${parts[0]}`;
                    }
                    $('#date').val(dateValue);
                }
                
                $('#duree').val(item.duree || 0);
                
                // Afficher la modal
                $('#addDataModal').modal('show');
            } else {
                showNotification('error', 'Aucune donnée trouvée pour cet identifiant');
            }
        },
        error: function(xhr) {
            showNotification('error', 'Erreur lors de la récupération des données');
            console.error("Erreur lors de la récupération des données:", xhr.responseText);
        }
    });
}

// Fonction pour confirmer la suppression
function confirmDelete(id) {
    console.log("Demande de suppression de l'élément ID:", id);
    
    // Récupérer les informations de l'élément à supprimer pour l'afficher dans la confirmation
    $.ajax({
        url: `${API_BASE_URL}/arion/data`,
        type: 'GET',
        headers: {
            'Authorization': 'Bearer ' + getToken()
        },
        data: { id: id },  // Ajouter l'ID comme paramètre de requête
        success: function(data) {
            if (data && data.length > 0) {
                const item = data[0];
                
                // Mettre à jour le texte de confirmation avec les détails de l'élément
                const details = `${item.activite || 'Activité inconnue'} - ${item.formateur || 'Formateur inconnu'} (${item.date || 'Date inconnue'})`;
                $('#deleteDetails').text(details);
                
                // Stocker l'ID à supprimer dans le formulaire
                $('#deleteForm').data('id', id);
                
                // Afficher la modal de confirmation
                $('#deleteModal').modal('show');
            } else {
                showNotification('error', 'Élément introuvable');
            }
        },
        error: function(xhr) {
            // En cas d'erreur, afficher quand même la confirmation
            $('#deleteDetails').text(`ID: ${id}`);
            $('#deleteForm').data('id', id);
            $('#deleteModal').modal('show');
            
            console.error("Erreur lors de la récupération des détails pour la suppression:", xhr.responseText);
        }
    });
}

// Fonction pour supprimer des données
function deleteArionData(form) {
    const id = form.data('id');
    if (!id) {
        showNotification('error', 'ID manquant pour la suppression');
        return;
    }
    
    console.log("Suppression de l'élément ID:", id);
    
    // Afficher un indicateur de chargement
    const submitBtn = form.find('button[type="submit"]');
    const originalBtnText = submitBtn.html();
    submitBtn.html('<i class="fas fa-spinner fa-spin mr-1"></i>Suppression...').prop('disabled', true);
    
    // Envoyer la requête de suppression
    $.ajax({
        url: `${API_BASE_URL}/arion/delete/${id}`,
        type: 'DELETE',
        headers: {
            'Authorization': 'Bearer ' + getToken(),
            'X-CSRFToken': $('input[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            // Fermer la modal
            $('#deleteModal').modal('hide');
            
            // Afficher une notification de succès
            showNotification('success', response.message || 'Données supprimées avec succès !');
            
            // Rafraîchir les données après un court délai
            setTimeout(function() {
                loadArionData();
                loadArionStats();
            }, 100);
        },
        error: function(xhr) {
            // Afficher une notification d'erreur
            try {
                const response = JSON.parse(xhr.responseText);
                showNotification('error', response.error || 'Une erreur est survenue lors de la suppression');
            } catch (e) {
                showNotification('error', 'Erreur lors de la suppression des données');
            }
            console.error("Erreur lors de la suppression:", xhr.responseText);
        },
        complete: function() {
            // Restaurer le bouton
            submitBtn.html(originalBtnText).prop('disabled', false);
        }
    });
}

// Fonction pour rafraîchir les données - utilisée par la fonction loadAndUpdateStatusPieChart()
function refreshData() {
    // Recharger les données immédiatement
    loadArionData();
    loadArionStats();
    loadStatusStats();
    loadFormateursByStatus();
    loadAndUpdateStatusPieChart();
}

// Fonction pour afficher une notification
function showNotification(type, message) {
    // Déterminer la classe d'alerte en fonction du type
    let alertClass = 'alert-info';
    let icon = 'fa-info-circle';
    
    if (type === 'success') {
        alertClass = 'alert-success';
        icon = 'fa-check-circle';
    } else if (type === 'error') {
        alertClass = 'alert-danger';
        icon = 'fa-exclamation-circle';
    } else if (type === 'warning') {
        alertClass = 'alert-warning';
        icon = 'fa-exclamation-triangle';
    }
    
    // Créer l'élément de notification
    const notification = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert" 
             style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 400px;">
            <i class="fas ${icon} mr-2"></i>
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    `;
    
    // Ajouter la notification au DOM
    $('body').append(notification);
    
    // Supprimer automatiquement après 3 secondes
    setTimeout(function() {
        $('.alert').alert('close');
    }, 3000);
}

// Fonction pour récupérer le token JWT
function getToken() {
    return localStorage.getItem('token') || sessionStorage.getItem('token') || '';
}
</script>
{% endblock %}