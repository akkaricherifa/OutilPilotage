{% extends 'statistiques/base.html' %}
{% load static %}

{% block title %}RSE - Responsabilité Sociétale - AppISIS{% endblock %}

{% block extra_css %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap4.min.css">

<style>
    .stat-card {
        transition: transform 0.2s;
        border-left: 4px solid;
        margin-bottom: 20px;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .stat-card-heures { border-left-color: #2f0d73; }
    .stat-card-activites { border-left-color: #7c50de; }
    .stat-card-promotions { border-left-color: #ac54c7; }
    .stat-card-etudiants { border-left-color: #f56960; }
    
    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        border: 1px solid #e9ecef;
        height: 400px;
    }
    
    .chart-container h5 {
        color: #2f0d73;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    
    .dashboard-header {
        background: linear-gradient(135deg, #2f0d73 0%, #7c50de 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
    }
    
    .dashboard-header h1 {
        margin: 0;
        font-weight: 300;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 30px;
    }
    
    .modal-header-custom {
        background: linear-gradient(135deg, #2f0d73 0%, #7c50de 100%);
        color: white;
    }
    
    .form-control:focus {
        border-color: #7c50de;
        box-shadow: 0 0 0 0.2rem rgba(124, 80, 222, 0.25);
    }
    
    .btn-primary-custom {
        background: linear-gradient(135deg, #2f0d73 0%, #7c50de 100%);
        border: none;
        color: white;
    }
    
    .btn-primary-custom:hover {
        background: linear-gradient(135deg, #7c50de 0%, #ac54c7 100%);
    }

    canvas {
        max-height: 300px;
    }
    
    .sidebar {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .sidebar h5 {
        color: #2f0d73;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    
    .filter-group {
        margin-bottom: 15px;
    }
    
    .filter-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #495057;
    }
    
    @media (max-width: 768px) {
        .chart-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- CORRECTION : Stockage des données plus clair et en JSON -->
<div id="stats-data" style="display: none;">{{ stats|safe }}</div>

<!-- En-tête du dashboard -->
<div class="dashboard-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1><i class="fas fa-leaf mr-3"></i>RSE - Responsabilité Sociétale</h1>
            <p class="mb-0">Gestion des activités et heures dédiées à la Responsabilité Sociétale des Entreprises</p>
        </div>
        <div class="action-buttons d-flex flex-wrap">
            <button class="btn btn-light btn-lg mr-2" data-toggle="modal" data-target="#addDataModal">
                <i class="fas fa-plus mr-2"></i>Ajouter des données
            </button>
            <button class="btn btn-success btn-lg mr-2" data-toggle="modal" data-target="#uploadCSVModal">
                <i class="fas fa-file-upload mr-2"></i>Importer CSV
            </button>
            <button class="btn btn-warning btn-lg" onclick="refreshAllCharts()">
                <i class="fas fa-sync mr-2"></i>Actualiser
            </button>
        </div>
    </div>
</div>

<div class="row">
    <!-- Sidebar filtres -->
    <div class="col-md-3">
        <div class="sidebar">
            <h5><i class="fas fa-filter mr-2"></i>Filtres</h5>
            
            <div class="filter-group">
                <label>Année académique</label>
                <select id="filterAnnee" class="form-control">
                    <option value="">Toutes les années</option>
                    {% if stats.annees_disponibles %}
                        {% for annee in stats.annees_disponibles %}
                            <option value="{{ annee }}">{{ annee }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            
            <div class="filter-group">
                <label>Promotion</label>
                <select id="filterPromotion" class="form-control">
                    <option value="">Toutes les promotions</option>
                    {% if stats.promotions_disponibles %}
                        {% for promotion in stats.promotions_disponibles %}
                            <option value="{{ promotion }}">{{ promotion }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            
            <div class="filter-group">
                <label>Semestre</label>
                <select id="filterSemestre" class="form-control">
                    <option value="">Tous les semestres</option>
                    <option value="S1">S1</option>
                    <option value="S2">S2</option>
                    <option value="S3">S3</option>
                    <option value="S4">S4</option>
                    <option value="S5">S5</option>
                    <option value="S6">S6</option>
                    <option value="S7">S7</option>
                    <option value="S8">S8</option>
                    <option value="S9">S9</option>
                    <option value="S10">S10</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Type d'activité</label>
                <select id="filterTypeActivite" class="form-control">
                    <option value="">Tous les types</option>
                    {% for activite in activites_maquette %}
                        <option value="{{ activite }}">{{ activite }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <button id="applyFilters" class="btn btn-primary-custom w-100 mt-3">
                <i class="fas fa-search mr-2"></i>Appliquer les filtres
            </button>
            
            <button id="resetFilters" class="btn btn-outline-secondary w-100 mt-2">
                <i class="fas fa-undo mr-2"></i>Réinitialiser
            </button>
        </div>
        
        <!-- Statistiques résumées -->
        <div class="sidebar">
            <h5><i class="fas fa-chart-pie mr-2"></i>Résumé</h5>
            
            <div class="text-center mb-3">
                <h2 class="text-primary" id="sidebar-total-heures">
                    {% if stats.total_heures_rse %}
                        {{ stats.total_heures_rse }}
                    {% else %}
                        0
                    {% endif %}
                </h2>
                <p class="mb-0">Heures totales RSE</p>
            </div>
            
            <div class="progress mb-3" style="height: 20px;">
                <div class="progress-bar bg-success" role="progressbar" style="width: 65%;" aria-valuenow="65" aria-valuemin="0" aria-valuemax="100">65% Maquette</div>
            </div>
            
            <div class="progress mb-4" style="height: 20px;">
                <div class="progress-bar bg-info" role="progressbar" style="width: 35%;" aria-valuenow="35" aria-valuemin="0" aria-valuemax="100">35% Hors maquette</div>
            </div>
            
            <div class="small text-muted">
                <p><i class="fas fa-users mr-1"></i> <strong id="sidebar-etudiants">
                    {% if stats.etudiants_impliques %}
                        {{ stats.etudiants_impliques }}
                    {% else %}
                        0
                    {% endif %}
                </strong> étudiants impliqués</p>
            </div>
        </div>
    </div>
    
    <!-- Contenu principal -->
    <div class="col-md-9">
        <!-- Statistiques résumées -->
        <div class="stats-grid">
            <div class="card stat-card stat-card-heures">
                <div class="card-body text-center">
                    <h3 style="color: #2f0d73;" id="stat-heures">
                        {% if stats.total_heures_rse %}
                            {{ stats.total_heures_rse }}
                        {% else %}
                            0
                        {% endif %}
                    </h3>
                    <p class="mb-0">Heures RSE</p>
                </div>
            </div>
            <div class="card stat-card stat-card-activites">
                <div class="card-body text-center">
                    <h3 style="color: #7c50de;" id="stat-activites">
                        {% if stats.total_activites %}
                            {{ stats.total_activites }}
                        {% else %}
                            0
                        {% endif %}
                    </h3>
                    <p class="mb-0">Activités</p>
                </div>
            </div>
            <div class="card stat-card stat-card-promotions">
                <div class="card-body text-center">
                    <h3 style="color: #ac54c7;" id="stat-promotions">
                        {% if stats.promotions_impliquees %}
                            {{ stats.promotions_impliquees }}
                        {% else %}
                            0
                        {% endif %}
                    </h3>
                    <p class="mb-0">Promotions</p>
                </div>
            </div>
            <div class="card stat-card stat-card-etudiants">
                <div class="card-body text-center">
                    <h3 style="color: #f56960;" id="stat-etudiants">
                        {% if stats.etudiants_impliques %}
                            {{ stats.etudiants_impliques }}
                        {% else %}
                            0
                        {% endif %}
                    </h3>
                    <p class="mb-0">Étudiants</p>
                </div>
            </div>
        </div>

        <!-- Graphiques -->
        <div class="chart-grid">
            <!-- Graphique 1: Répartition par promotion -->
            <div class="chart-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5><i class="fas fa-chart-pie mr-2"></i>Répartition des heures RSE par type</h5>
                    <select id="promotionSelector" class="form-control" style="width: 150px;">
                        <option value="all">Toutes les promotions</option>
                        {% if stats.promotions_disponibles %}
                            {% for promotion in stats.promotions_disponibles %}
                                <option value="{{ promotion }}">{{ promotion }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>
                <canvas id="promotionsChart" height="300"></canvas>
            </div>

            <!-- Graphique 2: Évolution des heures RSE -->
            <div class="chart-container">
                <h5><i class="fas fa-chart-line mr-2"></i>Évolution des heures RSE</h5>
                <canvas id="evolutionChart"></canvas>
            </div>

            <!-- Graphique 3: Répartition par type d'activité -->
            <div class="chart-container">
                <h5><i class="fas fa-chart-bar mr-2"></i>Répartition par type d'activité</h5>
                <canvas id="typeActiviteChart" height="300"></canvas>
            </div>

            <!-- Graphique 4: Répartition CM/TD/TP -->
            <div class="chart-container">
                <h5><i class="fas fa-chalkboard mr-2"></i>Répartition CM/TD/TP</h5>
                <canvas id="formatCoursChart" height="300"></canvas>
            </div>
        </div>

        <!-- Tableau des données -->
        <div class="chart-container" style="height: auto;">
            <h5><i class="fas fa-table mr-2"></i>Données détaillées RSE</h5>
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="rseTable">
                    <thead style="background: linear-gradient(135deg, #2f0d73 0%, #7c50de 100%); color: white;">
                        <tr>
                            <th>Année</th>
                            <th>Promotion</th>
                            <th>Semestre</th>
                            <th>Type d'activité</th>
                            <th>CM</th>
                            <th>TD</th>
                            <th>TP</th>
                            <th>Total</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if rse_data %}
                            {% for item in rse_data %}
                                <tr>
                                    <td>{{ item.annee }}</td>
                                    <td>{{ item.promotion }}</td>
                                    <td>{{ item.semestre }}</td>
                                    <td>{{ item.type_activite }}</td>
                                    <td>{{ item.heures_cm }}</td>
                                    <td>{{ item.heures_td }}</td>
                                    <td>{{ item.heures_tp }}</td>
                                    <td>{{ item.total_heures|default:0 }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="editData('{{ item.id }}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete('{{ item.id }}', '{{ item.type_activite }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="9" class="text-center">Aucune donnée disponible</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ajouter/Modifier des données -->
<div class="modal fade" id="addDataModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title" id="addDataModalTitle">
                    <i class="fas fa-plus-circle mr-2"></i>
                    Ajouter des heures et activités RSE
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="dataForm" method="post" action="{% url 'rse_add_data' %}">
                {% csrf_token %}
                <input type="hidden" name="id" id="rse_id">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Année académique <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" name="annee" id="annee" required min="2000" max="2100" value="2025">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Promotion <span class="text-danger">*</span></label>
                                <select class="form-control" name="promotion" id="promotion" required>
                                    <option value="">Choisir une promotion</option>
                                    <option value="FIE1">FIE1</option>
                                    <option value="FIE2">FIE2</option>
                                    <option value="FIE3">FIE3</option>
                                    <option value="FIE4">FIE4</option>
                                    <option value="FIE5">FIE5</option>
                                    <option value="FIA3">FIA3</option>
                                    <option value="FIA4">FIA4</option>
                                    <option value="FIA5">FIA5</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Semestre <span class="text-danger">*</span></label>
                                <select class="form-control" name="semestre" id="semestre" required>
                                    <option value="">Choisir un semestre</option>
                                    <option value="S1">S1</option>
                                    <option value="S2">S2</option>
                                    <option value="S3">S3</option>
                                    <option value="S4">S4</option>
                                    <option value="S5">S5</option>
                                    <option value="S6">S6</option>
                                    <option value="S7">S7</option>
                                    <option value="S8">S8</option>
                                    <option value="S9">S9</option>
                                    <option value="S10">S10</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label>Type d'activité RSE <span class="text-danger">*</span></label>
                                <select class="form-control" name="type_activite" id="type_activite" required onchange="toggleAutreType()">
                                    <option value="">Sélectionner un type d'activité</option>
                                    {% for activite in activites_maquette %}
                                        {% if activite != "Autre" %}
                                            <option value="{{ activite }}">{{ activite }}</option>
                                        {% endif %}
                                    {% endfor %}
                                    <option value="Autre">Autre (préciser)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row" id="autre_type_container" style="display: none;">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label>Précisez le type d'activité <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="autre_type" id="autre_type" placeholder="Précisez le type d'activité">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <h6 class="font-weight-bold mb-3">Répartition des heures <span class="text-danger">*</span></h6>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Heures CM</label>
                                <input type="number" class="form-control" name="heures_cm" id="heures_cm" required min="0" value="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Heures TD</label>
                                <input type="number" class="form-control" name="heures_td" id="heures_td" required min="0" value="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Heures TP</label>
                                <input type="number" class="form-control" name="heures_tp" id="heures_tp" required min="0" value="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label>Description de l'activité</label>
                                <textarea class="form-control" name="description" id="description" rows="3" placeholder="Description de l'activité RSE..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary-custom">
                        <i class="fas fa-save mr-1"></i>Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Upload CSV -->
<div class="modal fade" id="uploadCSVModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title">
                    <i class="fas fa-file-upload mr-2"></i>
                    Importer un fichier CSV
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="uploadForm" method="post" action="{% url 'upload_csv' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="destination" value="rse">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Fichier CSV <span class="text-danger">*</span></label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="csvFile" name="file" accept=".csv" required>
                            <label class="custom-file-label" for="csvFile">Choisir un fichier...</label>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle mr-2"></i>Format attendu du fichier CSV :</h6>
                        <code>annee,promotion,semestre,type_activite,heures_cm,heures_td,heures_tp,description</code>
                        <hr>
                        <h6>Exemple :</h6>
                        <pre class="mb-0">2023,FIE1,S1,Transition écologique et numérique,10,8,6,Initiation au développement durable
2023,FIE2,S3,Numérique responsable,12,10,8,Éthique informatique et environnement</pre>
                    </div>
                    <div class="form-group">
                        <label>Nom du fichier</label>
                        <input type="text" class="form-control" name="name" placeholder="Données RSE 2025" required>
                    </div>
                    <div class="form-group">
                        <label>Description (optionnel)</label>
                        <textarea class="form-control" name="description" rows="3" 
                                  placeholder="Description du fichier importé..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload mr-1"></i>Importer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de confirmation de suppression -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-trash mr-2"></i>
                    Confirmer la suppression
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir supprimer cette activité RSE ?</p>
                <p id="deleteDetails" class="font-weight-bold"></p>
                <small class="text-muted">Cette action est irréversible.</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                <form id="deleteForm" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger" id="confirmDelete">
                        <i class="fas fa-trash mr-1"></i>Supprimer
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<!-- DataTables JS -->
<script type="text/javascript" src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap4.min.js"></script>
<script>
// Script amélioré pour la visualisation des données RSE

// Configuration globale des graphiques
Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
Chart.defaults.color = '#495057';

// Variables globales
let charts = {};
let rseData = [];

$(document).ready(function() {
    // Charger les données
    loadRseData();
    
    // Initialiser les graphiques et autres composants
    initPage();
    
    // Configurer les filtres et autres événements
    setupEventListeners();
});

// Fonction pour charger les données RSE
function loadRseData() {
    try {
        // 1. Essayer de récupérer les données depuis le conteneur caché
        const statsElement = document.getElementById('stats-data');
        if (statsElement && statsElement.textContent.trim()) {
            try {
                // Analyser les données JSON
                const parsedData = JSON.parse(statsElement.textContent.trim());
                console.log("Données chargées avec succès:", parsedData);
                
                // Vérifier si les données sont dans la structure attendue
                if (parsedData.items) {
                    rseData = parsedData.items || [];
                } else if (Array.isArray(parsedData)) {
                    rseData = parsedData;
                } else {
                    rseData = [];
                    console.warn("Format de données inattendu, tableau vide utilisé");
                }
                
                // Extraire la liste complète des promotions
                const allPromotions = new Set();
                rseData.forEach(item => {
                    if (item.promotion) {
                        allPromotions.add(item.promotion);
                    }
                });
                
                // Stocker la liste des promotions pour utilisation ultérieure
                window.availablePromotions = Array.from(allPromotions).sort();
                console.log("Promotions disponibles:", window.availablePromotions);
                
                // Extraire également les statistiques globales
                window.statsGlobals = {
                    total_heures_rse: parsedData.total_heures_rse || rseData.reduce((sum, item) => sum + (parseInt(item.total_heures) || 0), 0),
                    total_activites: parsedData.total_activites || rseData.length,
                    etudiants_impliques: parsedData.etudiants_impliques || 0,
                    promotions_impliquees: parsedData.promotions_impliquees || allPromotions.size
                };
            } catch (e) {
                console.error("Erreur lors du parsing JSON:", e);
                setDemoData();
            }
        } else {
            console.warn("Élément stats-data non trouvé ou vide, utilisation de données de démonstration");
            setDemoData();
        }
    } catch (error) {
        console.error("Erreur lors du chargement des données:", error);
        setDemoData();
    }
    
    // Mettre à jour les statistiques dans l'interface
    updateStatsSummary();
}
// Fonction pour définir des données de démonstration si les données réelles ne sont pas disponibles
function setDemoData() {
    // Données fictives pour la démonstration
    rseData = [
        {
            id: "rse_174947347",
            annee: 2023,
            promotion: "FIE3",
            semestre: "S5",
            heures_cm: 10,
            heures_td: 15,
            heures_tp: 8,
            type_activite: "Numérique responsable",
            total_heures: 33
        },
        {
            id: "rse_174947348",
            annee: 2023,
            promotion: "FIE2",
            semestre: "S3",
            heures_cm: 8,
            heures_td: 10,
            heures_tp: 12,
            type_activite: "Transition écologique",
            total_heures: 30
        },
        {
            id: "rse_174947349",
            annee: 2024,
            promotion: "FIE1",
            semestre: "S1",
            heures_cm: 12,
            heures_td: 8,
            heures_tp: 10,
            type_activite: "Responsabilité sociale",
            total_heures: 30
        },
        {
            id: "rse_174947350",
            annee: 2024,
            promotion: "FIA3",
            semestre: "S9",
            heures_cm: 15,
            heures_td: 15,
            heures_tp: 15,
            type_activite: "Enjeux socio-environnementaux",
            total_heures: 45
        },
        {
            id: "rse_174947351",
            annee: 2025,
            promotion: "FIE2",
            semestre: "S4",
            heures_cm: 10,
            heures_td: 15,
            heures_tp: 5,
            type_activite: "Numérique responsable",
            total_heures: 30
        }
    ];
    
    // Calculer les statistiques globales
    window.statsGlobals = {
        total_heures_rse: rseData.reduce((sum, item) => sum + (item.total_heures || 0), 0),
        total_activites: rseData.length,
        etudiants_impliques: 125,
        promotions_impliquees: new Set(rseData.map(item => item.promotion)).size
    };
}

// Initialiser la page avec les données chargées
function initPage() {
    // Initialiser DataTable
    initDataTable();
    
    // Initialiser les filtres
    populateFilters();
    
    // Initialiser les graphiques
    initCharts();
}

// Initialiser DataTable
function initDataTable() {
    $('#rseTable').DataTable({
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/French.json"
        },
        "order": [[0, "desc"], [1, "asc"], [2, "asc"]],
        "pageLength": 5,  // Afficher 5 lignes par page au lieu de 10
        "lengthMenu": [5, 10, 15, 20, 25, 30, 50],  // Options du menu de longueur
        "responsive": true,
        "pagingType": "full_numbers",  // Type de pagination complet
        "dom": '<"top"lf>rt<"bottom"ip><"clear">'  // Disposition des éléments de contrôle
    });
}

// Populer les filtres avec les valeurs disponibles
function populateFilters() {
    // Extraire les valeurs uniques pour les filtres
    const annees = [...new Set(rseData.map(item => item.annee))].sort((a, b) => b - a);
    const promotions = [...new Set(rseData.map(item => item.promotion))].sort();
    const typesActivite = [...new Set(rseData.map(item => item.type_activite))].filter(Boolean).sort();
    
    // Remplir les sélecteurs
    const anneeFilter = $('#filterAnnee');
    const promotionFilter = $('#filterPromotion');
    const typeActiviteFilter = $('#filterTypeActivite');
    const promotionSelector = $('#promotionSelector');
    
    // Vider les sélecteurs d'abord
    anneeFilter.find('option:not(:first)').remove();
    promotionFilter.find('option:not(:first)').remove();
    typeActiviteFilter.find('option:not(:first)').remove();
    promotionSelector.find('option:not(:first)').remove();
    
    // Ajouter les options
    annees.forEach(annee => {
        anneeFilter.append(`<option value="${annee}">${annee}</option>`);
    });
    
    promotions.forEach(promotion => {
        promotionFilter.append(`<option value="${promotion}">${promotion}</option>`);
        promotionSelector.append(`<option value="${promotion}">${promotion}</option>`);
    });
    
    typesActivite.forEach(type => {
        if (type) {
            typeActiviteFilter.append(`<option value="${type}">${type}</option>`);
        }
    });
}

// Fonction pour mettre à jour le tableau de données
function updateDataTable(data) {
    // Détruire la table DataTable existante
    if ($.fn.DataTable.isDataTable('#rseTable')) {
        $('#rseTable').DataTable().destroy();
    }
    
    // Vider le tableau
    $('#rseTable tbody').empty();
    
    // Ajouter les nouvelles données
    if (data && data.length > 0) {
        data.forEach(item => {
            $('#rseTable tbody').append(`
                <tr>
                    <td>${item.annee}</td>
                    <td>${item.promotion}</td>
                    <td>${item.semestre}</td>
                    <td>${item.type_activite}</td>
                    <td>${item.heures_cm}</td>
                    <td>${item.heures_td}</td>
                    <td>${item.heures_tp}</td>
                    <td>${item.total_heures || 0}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editData('${item.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete('${item.id}', '${item.type_activite}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `);
        });
    } else {
        $('#rseTable tbody').append(`
            <tr>
                <td colspan="9" class="text-center">Aucune donnée disponible</td>
            </tr>
        `);
    }
    
    // Réinitialiser DataTable
    $('#rseTable').DataTable({
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/French.json"
        },
        "order": [[0, "desc"], [1, "asc"], [2, "asc"]],
        "pageLength": 10,
        "responsive": true
    });
}
// Mettre à jour les statistiques affichées
function updateStatsSummary() {
    // Mettre à jour les compteurs statistiques
    $('#stat-heures').text(window.statsGlobals.total_heures_rse || 0);
    $('#stat-activites').text(window.statsGlobals.total_activites || 0);
    $('#stat-promotions').text(window.statsGlobals.promotions_impliquees || 0);
    $('#stat-etudiants').text(window.statsGlobals.etudiants_impliques || 0);
    
    // Mettre à jour le sidebar
    $('#sidebar-total-heures').text(window.statsGlobals.total_heures_rse || 0);
    $('#sidebar-etudiants').text(window.statsGlobals.etudiants_impliques || 0);
}

// Initialiser tous les graphiques
function initCharts() {
    // 1. Graphique de répartition par promotion
    initPromotionChart();
    
    // 2. Graphique d'évolution des heures RSE
    initEvolutionChart();
    
    // 3. Graphique de répartition par type d'activité
    initTypeActiviteChart();
    
    // 4. Graphique de répartition CM/TD/TP
    initFormatCoursChart();
}

// Graphique 1: Répartition par promotion
// Graphique 1: Répartition par promotion
function initPromotionChart(selectedPromotion = 'all') {
    console.log("Initialisation du graphique de promotions avec sélection:", selectedPromotion);
    
    const ctx = document.getElementById('promotionsChart');
    if (!ctx) {
        console.error("Canvas 'promotionsChart' non trouvé");
        return;
    }
    
    // Détruire le graphique existant s'il existe
    if (charts.promotions) {
        charts.promotions.destroy();
    }
    
    // Préparer les données
    let filteredData = rseData;
    
    // Filtrer par promotion si nécessaire
    if (selectedPromotion !== 'all') {
        filteredData = rseData.filter(item => item.promotion === selectedPromotion);
        console.log(`Données filtrées pour ${selectedPromotion}:`, filteredData.length, "enregistrements");
    }
    
    // Vérifier qu'il y a des données à afficher
    if (filteredData.length === 0) {
        console.warn("Aucune donnée disponible pour le graphique des promotions");
        // Créer un graphique vide ou afficher un message
        ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
        ctx.getContext('2d').font = '14px Arial';
        ctx.getContext('2d').fillText('Aucune donnée disponible pour cette sélection', 50, 100);
        return;
    }
    
    // Calculer les totaux pour chaque type d'enseignement
    const totalCM = filteredData.reduce((sum, item) => sum + (parseInt(item.heures_cm) || 0), 0);
    const totalTD = filteredData.reduce((sum, item) => sum + (parseInt(item.heures_td) || 0), 0);
    const totalTP = filteredData.reduce((sum, item) => sum + (parseInt(item.heures_tp) || 0), 0);
    
    console.log("Totaux calculés:", { CM: totalCM, TD: totalTD, TP: totalTP });
    
    // Titre du graphique
    const title = selectedPromotion === 'all' ? 'Toutes les promotions' : selectedPromotion;
    
    // Créer le graphique
    charts.promotions = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['CM', 'TD', 'TP'],
            datasets: [{
                data: [totalCM, totalTD, totalTP],
                backgroundColor: ['#2f0d73', '#ac54c7', '#ffb43c'],
                borderWidth: 1,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                },
                title: {
                    display: true,
                    text: title,
                    font: {
                        size: 16
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw;
                            const total = totalCM + totalTD + totalTP;
                            const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                            return `${label}: ${value} heures (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    
    console.log("Graphique de promotions initialisé avec succès");
}

// Graphique 2: Évolution des heures RSE par année
function initEvolutionChart() {
    const ctx = document.getElementById('evolutionChart');
    if (!ctx) return;
    
    // Détruire le graphique existant s'il existe
    if (charts.evolution) {
        charts.evolution.destroy();
    }
    
    // Préparer les données par année
    const annees = [...new Set(rseData.map(item => item.annee))].sort();
    
    // Calculer les heures totales par année
    const dataByYear = {};
    annees.forEach(annee => {
        dataByYear[annee] = {
            total: 0,
            cm: 0,
            td: 0,
            tp: 0
        };
    });
    
    rseData.forEach(item => {
        if (dataByYear[item.annee]) {
            dataByYear[item.annee].total += (parseInt(item.total_heures) || 0);
            dataByYear[item.annee].cm += (parseInt(item.heures_cm) || 0);
            dataByYear[item.annee].td += (parseInt(item.heures_td) || 0);
            dataByYear[item.annee].tp += (parseInt(item.heures_tp) || 0);
        }
    });
    
    // Créer le graphique
    charts.evolution = new Chart(ctx, {
        type: 'line',
        data: {
            labels: annees,
            datasets: [
                {
                    label: 'Total',
                    data: annees.map(annee => dataByYear[annee].total),
                    borderColor: '#7c50de',
                    backgroundColor: 'rgba(124, 80, 222, 0.1)',
                    tension: 0.3,
                    fill: true,
                    borderWidth: 2
                },
                {
                    label: 'CM',
                    data: annees.map(annee => dataByYear[annee].cm),
                    borderColor: '#2f0d73',
                    borderDash: [5, 5],
                    tension: 0.3,
                    borderWidth: 2
                },
                {
                    label: 'TD',
                    data: annees.map(annee => dataByYear[annee].td),
                    borderColor: '#ac54c7',
                    borderDash: [5, 5],
                    tension: 0.3,
                    borderWidth: 2
                },
                {
                    label: 'TP',
                    data: annees.map(annee => dataByYear[annee].tp),
                    borderColor: '#ffb43c',
                    borderDash: [5, 5],
                    tension: 0.3,
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Nombre d\'heures'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Année'
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.raw} heures`;
                        }
                    }
                }
            }
        }
    });
}

// Graphique 3: Répartition par type d'activité
function initTypeActiviteChart() {
    const ctx = document.getElementById('typeActiviteChart');
    if (!ctx) return;
    
    // Détruire le graphique existant s'il existe
    if (charts.typeActivite) {
        charts.typeActivite.destroy();
    }
    
    // Regrouper par type d'activité
    const typeData = {};
    rseData.forEach(item => {
        const type = item.type_activite || 'Non spécifié';
        if (!typeData[type]) {
            typeData[type] = 0;
        }
        typeData[type] += (parseInt(item.total_heures) || 0);
    });
    
    // Trier par valeur décroissante
    const sortedTypes = Object.entries(typeData)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8); // Limiter à 8 types pour la lisibilité
    
    const types = sortedTypes.map(item => item[0]);
    const values = sortedTypes.map(item => item[1]);
    
    // Créer le graphique
    charts.typeActivite = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: types,
            datasets: [{
                label: 'Heures par type d\'activité',
                data: values,
                backgroundColor: generateColors(types.length),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: types.length > 4 ? 'y' : 'x', // Utiliser un graphique horizontal si beaucoup de types
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: types.length <= 4,
                        text: 'Nombre d\'heures'
                    }
                },
                x: {
                    title: {
                        display: types.length > 4,
                        text: 'Nombre d\'heures'
                    },
                    ticks: {
                        autoSkip: false,
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

// Graphique 4: Répartition CM/TD/TP
function initFormatCoursChart() {
    const ctx = document.getElementById('formatCoursChart');
    if (!ctx) return;
    
    // Détruire le graphique existant s'il existe
    if (charts.formatCours) {
        charts.formatCours.destroy();
    }
    
    // Calculer les totaux
    const totalCM = rseData.reduce((sum, item) => sum + (parseInt(item.heures_cm) || 0), 0);
    const totalTD = rseData.reduce((sum, item) => sum + (parseInt(item.heures_td) || 0), 0);
    const totalTP = rseData.reduce((sum, item) => sum + (parseInt(item.heures_tp) || 0), 0);
    
    // Créer le graphique
    charts.formatCours = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['CM', 'TD', 'TP'],
            datasets: [{
                data: [totalCM, totalTD, totalTP],
                backgroundColor: ['#2f0d73', '#ac54c7', '#ffb43c'],
                borderWidth: 1,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '50%',
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw;
                            const total = totalCM + totalTD + totalTP;
                            const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                            return `${label}: ${value} heures (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Configurer les événements de l'interface
function setupEventListeners() {
    // Sélecteur de promotion pour le graphique 1
    $('#promotionSelector').on('change', function() {
        const selectedPromotion = $(this).val();
        initPromotionChart(selectedPromotion);
    });
    
    // Appliquer les filtres au tableau
    $('#applyFilters').on('click', function() {
        filterTable();
    });
    
    // Réinitialiser les filtres
    $('#resetFilters').on('click', function() {
        $('#filterAnnee, #filterPromotion, #filterSemestre, #filterTypeActivite').val('');
        filterTable();
    });
    
    // Gestion du formulaire d'ajout/édition
    $('#dataForm').on('submit', function(e) {
    e.preventDefault();
    
    $.ajax({
        url: $(this).attr('action'),
        type: 'POST',
        data: $(this).serialize(),
        headers: {
            'X-CSRFToken': $('input[name=csrfmiddlewaretoken]').val(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            // Fermer la modal
            $('#addDataModal').modal('hide');
            
            // Afficher la notification de succès
            showNotification('success', response.message || 'Données enregistrées avec succès!');
            
            // Actualiser les données sans recharger toute la page
            refreshDataAndCharts();
        },
        error: function(xhr) {
            // Gestion d'erreur...
        }
    });
});
    
    // Gestion du nom de fichier pour l'upload CSV
    $('.custom-file-input').on('change', function() {
        let fileName = $(this).val().split('\\').pop();
        $(this).siblings('.custom-file-label').addClass("selected").html(fileName);
    });
    
    // Gestion du type d'activité "Autre"
    $('#type_activite').on('change', function() {
        toggleAutreType();
    });
}

// Fonction pour actualiser les données
function refreshDataAndCharts() {
    // Afficher un indicateur de chargement
    const loadingOverlay = $('<div class="loading-overlay"><div class="spinner-border text-primary" role="status"><span class="sr-only">Chargement...</span></div></div>');
    $('body').append(loadingOverlay);
    
    // Requête AJAX pour récupérer les données actualisées
    $.ajax({
        url: window.location.pathname,
        type: 'GET',
        dataType: 'json',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(data) {
            // Mettre à jour les données et les graphiques
            if (data && data.rse_data) {
                // Mettre à jour les données RSE
                rseData = data.rse_data;
                
                // Mettre à jour les statistiques globales
                window.statsGlobals = {
                    total_heures_rse: rseData.reduce((sum, item) => sum + (parseInt(item.total_heures) || 0), 0),
                    total_activites: rseData.length,
                    etudiants_impliques: 342, // Valeur par défaut, à adapter
                    promotions_impliquees: new Set(rseData.map(item => item.promotion)).size
                };
                
                // Mettre à jour les statistiques affichées
                updateStatsSummary();
                
                // Mettre à jour le tableau de données
                updateDataTable(rseData);
                
                // Réinitialiser et mettre à jour les graphiques
                initCharts();
            }
        },
        complete: function() {
            // Supprimer l'indicateur de chargement
            loadingOverlay.remove();
        }
    });
}

// Valider le formulaire avant envoi
function validateForm() {
    // Vérifier les champs obligatoires
    const annee = $('#annee').val();
    const promotion = $('#promotion').val();
    const semestre = $('#semestre').val();
    const typeActivite = $('#type_activite').val();
    const heuresCM = parseInt($('#heures_cm').val()) || 0;
    const heuresTD = parseInt($('#heures_td').val()) || 0;
    const heuresTP = parseInt($('#heures_tp').val()) || 0;
    
    if (!annee || !promotion || !semestre) {
        showNotification('error', 'Les champs Année, Promotion et Semestre sont obligatoires.');
        return false;
    }
    
    if (typeActivite === 'Autre' && !$('#autre_type').val()) {
        showNotification('error', 'Veuillez préciser le type d\'activité.');
        return false;
    }
    
    if (heuresCM === 0 && heuresTD === 0 && heuresTP === 0) {
        showNotification('error', 'Veuillez saisir au moins une valeur pour les heures (CM, TD ou TP).');
        return false;
    }
    
    return true;
}

// Envoyer les données du formulaire via AJAX
function sendFormData(form) {
    $.ajax({
        url: form.attr('action'),
        type: 'POST',
        data: form.serialize(),
        headers: {
            'X-CSRFToken': $('input[name=csrfmiddlewaretoken]').val(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        beforeSend: function() {
            // Désactiver le bouton et montrer un indicateur de chargement
            form.find('button[type="submit"]').prop('disabled', true)
                .html('<i class="fas fa-spinner fa-spin mr-1"></i>Traitement...');
        },
        success: function(response) {
            $('#addDataModal').modal('hide');
            showNotification('success', response.message || 'Données enregistrées avec succès!');
            setTimeout(() => window.location.reload(), 1500);
        },
        error: function(xhr) {
            try {
                const response = JSON.parse(xhr.responseText);
                showNotification('error', response.error || 'Erreur lors de l\'enregistrement');
            } catch (e) {
                showNotification('error', 'Erreur lors de l\'enregistrement des données');
            }
        },
        complete: function() {
            // Réactiver le bouton
            form.find('button[type="submit"]').prop('disabled', false)
                .html('<i class="fas fa-save mr-1"></i>Enregistrer');
        }
    });
}

// Filtrer le tableau selon les critères sélectionnés
function filterTable() {
    const annee = $('#filterAnnee').val();
    const promotion = $('#filterPromotion').val();
    const semestre = $('#filterSemestre').val();
    const typeActivite = $('#filterTypeActivite').val();
    
    const table = $('#rseTable').DataTable();
    
    // Réinitialiser d'abord
    table.search('').columns().search('').draw();
    
    // Appliquer les filtres
    if (annee) {
        table.column(0).search(annee).draw();
    }
    if (promotion) {
        table.column(1).search(promotion).draw();
    }
    if (semestre) {
        table.column(2).search(semestre).draw();
    }
    if (typeActivite) {
        table.column(3).search(typeActivite).draw();
    }
}

// Fonction pour afficher/masquer le champ "autre type"
function toggleAutreType() {
    const typeSelect = document.getElementById('type_activite');
    const autreContainer = document.getElementById('autre_type_container');
    
    if (!typeSelect || !autreContainer) return;
    
    if (typeSelect.value === 'Autre') {
        autreContainer.style.display = 'block';
        document.getElementById('autre_type').setAttribute('required', 'required');
    } else {
        autreContainer.style.display = 'none';
        document.getElementById('autre_type').removeAttribute('required');
    }
}

// Fonction pour éditer les données
function editData(id) {
    if (!id) return;
    
    // Rechercher l'élément dans les données
    const item = rseData.find(item => item.id === id);
    
    if (item) {
        // Remplir le formulaire avec les données existantes
        $('#rse_id').val(id);
        $('#annee').val(item.annee);
        $('#promotion').val(item.promotion);
        $('#semestre').val(item.semestre);
        $('#heures_cm').val(item.heures_cm || 0);
        $('#heures_td').val(item.heures_td || 0);
        $('#heures_tp').val(item.heures_tp || 0);
        $('#description').val(item.description || '');
        
        // Gérer le type d'activité
        const typeActivite = item.type_activite;
        const typeSelect = document.getElementById('type_activite');
        
        let found = false;
        if (typeSelect) {
            // Parcourir les options pour trouver si le type existe
            for (let i = 0; i < typeSelect.options.length; i++) {
                if (typeSelect.options[i].value === typeActivite) {
                    typeSelect.selectedIndex = i;
                    found = true;
                    break;
                }
            }
            
            // Si le type n'existe pas dans la liste, utiliser "Autre"
            if (!found && typeActivite) {
                // Trouver l'option "Autre"
                for (let i = 0; i < typeSelect.options.length; i++) {
                    if (typeSelect.options[i].value === 'Autre') {
                        typeSelect.selectedIndex = i;
                        $('#autre_type').val(typeActivite);
                        $('#autre_type_container').show();
                        break;
                    }
                }
            }
        }
        
        // Mettre à jour le titre de la modal
        $('#addDataModalTitle').html('<i class="fas fa-edit mr-2"></i>Modifier les données RSE');
        
        // Afficher la modal
        $('#addDataModal').modal('show');
    } else {
        console.error(`Élément avec ID ${id} non trouvé dans les données`);
        showNotification('error', 'Impossible de trouver les données à éditer');
    }
}

// Fonction pour confirmer la suppression
function confirmDelete(id, type) {
    if (!id) return;
    
    const deleteDetails = document.getElementById('deleteDetails');
    if (deleteDetails) {
        deleteDetails.textContent = type || id;
    }
    
    // Configurer le formulaire de suppression
    const deleteForm = document.getElementById('deleteForm');
    if (deleteForm) {
        deleteForm.action = `/rse/delete/${id}/`;
    }
    
    // Afficher la modal
    $('#deleteModal').modal('show');
}

// Fonction pour actualiser tous les graphiques
function refreshAllCharts() {
    // Afficher un indicateur de chargement
    const originalBtn = $('.btn-warning').html();
    $('.btn-warning').html('<i class="fas fa-spinner fa-spin mr-2"></i>Actualisation...').prop('disabled', true);
    
    // Actualiser les données depuis le serveur
    $.ajax({
        url: window.location.href,
        type: 'GET',
        dataType: 'html',
        success: function(response) {
            // Extraire les nouvelles données des stats du HTML reçu
            const parser = new DOMParser();
            const doc = parser.parseFromString(response, 'text/html');
            const statsElement = doc.getElementById('stats-data');
            
            if (statsElement && statsElement.textContent) {
                try {
                    const parsedData = JSON.parse(statsElement.textContent);
                    rseData = parsedData.items || [];
                    
                    // Mettre à jour les statistiques globales
                    window.statsGlobals = {
                        total_heures_rse: parsedData.total_heures_rse || 0,
                        total_activites: parsedData.total_activites || 0,
                        etudiants_impliques: parsedData.etudiants_impliques || 0,
                        promotions_impliquees: parsedData.promotions_impliquees || 0
                    };
                    
                    // Mettre à jour les statistiques affichées
                    updateStatsSummary();
                    
                    // Mettre à jour les graphiques
                    initCharts();
                    
                    // Mettre à jour les filtres
                    populateFilters();
                    
                    showNotification('success', 'Données actualisées avec succès !');
                } catch (e) {
                    console.error("Erreur lors du parsing des données actualisées:", e);
                    showNotification('error', 'Erreur lors de l\'actualisation des données');
                }
            } else {
                console.warn("Aucune donnée stat trouvée dans la réponse");
                showNotification('warning', 'Aucune nouvelle donnée disponible');
            }
        },
        error: function() {
            showNotification('error', 'Erreur lors de la communication avec le serveur');
        },
        complete: function() {
            // Restaurer le bouton
            $('.btn-warning').html(originalBtn).prop('disabled', false);
        }
    });
}

// Fonction pour générer des couleurs pour les graphiques
function generateColors(count) {
    const baseColors = [
        '#2f0d73', '#7c50de', '#ac54c7', '#f56960', '#ffb43c', '#3cbebe',
        '#8b5fbf', '#ff6b6b', '#4dabf7', '#20c997', '#ff922b', '#5f3dc4'
    ];
    
    if (count <= baseColors.length) {
        return baseColors.slice(0, count);
    }
    
    const colors = [...baseColors];
    
    // Générer des couleurs supplémentaires si nécessaire
    for (let i = baseColors.length; i < count; i++) {
        const r = Math.floor(Math.random() * 200) + 55; // Éviter les couleurs trop sombres
        const g = Math.floor(Math.random() * 200) + 55;
        const b = Math.floor(Math.random() * 200) + 55;
        colors.push(`rgb(${r}, ${g}, ${b})`);
    }
    
    return colors;
}
// Fonction pour afficher une notification visuelle
function showNotification(type, message) {
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'warning' ? 'alert-warning' : 'alert-danger';
    const iconClass = type === 'success' ? 'fa-check-circle' : 
                     type === 'warning' ? 'fa-exclamation-circle' : 'fa-exclamation-triangle';
    
    const notification = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;">
            <i class="fas ${iconClass} mr-2"></i>
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    `;
    
    $('body').append(notification);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        $('.alert').fadeOut('slow', function() {
            $(this).remove();
        });
    }, 3000);
}
</script>
{% endblock %}