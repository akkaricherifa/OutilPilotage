{% extends 'statistiques/base.html' %}
{% load static %}

{% block title %}RSE - Responsabilité Sociétale - AppISIS{% endblock %}

{% block extra_css %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap4.min.css">

<style>
    .stat-card {
        transition: transform 0.2s;
        border-left: 4px solid;
        margin-bottom: 20px;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .stat-card-heures { border-left-color: #2f0d73; }
    .stat-card-activites { border-left-color: #7c50de; }
    .stat-card-promotions { border-left-color: #ac54c7; }
    .stat-card-etudiants { border-left-color: #f56960; }
    
    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        border: 1px solid #e9ecef;
        height: 400px;
    }
    
    .chart-container h5 {
        color: #2f0d73;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    
    .dashboard-header {
        background: linear-gradient(135deg, #2f0d73 0%, #7c50de 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
    }
    
    .dashboard-header h1 {
        margin: 0;
        font-weight: 300;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 30px;
    }
    
    .modal-header-custom {
        background: linear-gradient(135deg, #2f0d73 0%, #7c50de 100%);
        color: white;
    }
    
    .form-control:focus {
        border-color: #7c50de;
        box-shadow: 0 0 0 0.2rem rgba(124, 80, 222, 0.25);
    }
    
    .btn-primary-custom {
        background: linear-gradient(135deg, #2f0d73 0%, #7c50de 100%);
        border: none;
        color: white;
    }
    
    .btn-primary-custom:hover {
        background: linear-gradient(135deg, #7c50de 0%, #ac54c7 100%);
    }

    canvas {
        max-height: 300px;
    }
    
    .sidebar {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .sidebar h5 {
        color: #2f0d73;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    
    .filter-group {
        margin-bottom: 15px;
    }
    
    .filter-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #495057;
    }
    
    @media (max-width: 768px) {
        .chart-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Store stats data in a hidden div for JavaScript access -->
<div id="stats-data-container" style="display: none;">{{ stats|json_script:"stats-data" }}</div>

<!-- En-tête du dashboard -->
<div class="dashboard-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1><i class="fas fa-leaf mr-3"></i>RSE - Responsabilité Sociétale</h1>
            <p class="mb-0">Gestion des activités et heures dédiées à la Responsabilité Sociétale des Entreprises</p>
        </div>
        <div class="action-buttons d-flex flex-wrap">
            <button class="btn btn-light btn-lg mr-2" data-toggle="modal" data-target="#addDataModal">
                <i class="fas fa-plus mr-2"></i>Ajouter des données
            </button>
            <button class="btn btn-success btn-lg mr-2" data-toggle="modal" data-target="#uploadCSVModal">
                <i class="fas fa-file-upload mr-2"></i>Importer CSV
            </button>
            <button class="btn btn-warning btn-lg" onclick="refreshAllCharts()">
                <i class="fas fa-sync mr-2"></i>Actualiser
            </button>
        </div>
    </div>
</div>

<div class="row">
    <!-- Sidebar filtres -->
    <div class="col-md-3">
        <div class="sidebar">
            <h5><i class="fas fa-filter mr-2"></i>Filtres</h5>
            
            <div class="filter-group">
                <label>Année académique</label>
                <select id="filterAnnee" class="form-control">
                    <option value="">Toutes les années</option>
                    {% if stats.annees_disponibles %}
                        {% for annee in stats.annees_disponibles %}
                            <option value="{{ annee }}">{{ annee }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            
            <div class="filter-group">
                <label>Promotion</label>
                <select id="filterPromotion" class="form-control">
                    <option value="">Toutes les promotions</option>
                    {% if stats.promotions_disponibles %}
                        {% for promotion in stats.promotions_disponibles %}
                            <option value="{{ promotion }}">{{ promotion }}</option>
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            
            <div class="filter-group">
                <label>Semestre</label>
                <select id="filterSemestre" class="form-control">
                    <option value="">Tous les semestres</option>
                    <option value="S1">S1</option>
                    <option value="S2">S2</option>
                    <option value="S3">S3</option>
                    <option value="S4">S4</option>
                    <option value="S5">S5</option>
                    <option value="S6">S6</option>
                    <option value="S7">S7</option>
                    <option value="S8">S8</option>
                    <option value="S9">S9</option>
                    <option value="S10">S10</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Type d'activité</label>
                <select id="filterTypeActivite" class="form-control">
                    <option value="">Tous les types</option>
                    {% for activite in activites_maquette %}
                        <option value="{{ activite }}">{{ activite }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <button id="applyFilters" class="btn btn-primary-custom w-100 mt-3">
                <i class="fas fa-search mr-2"></i>Appliquer les filtres
            </button>
            
            <button id="resetFilters" class="btn btn-outline-secondary w-100 mt-2">
                <i class="fas fa-undo mr-2"></i>Réinitialiser
            </button>
        </div>
        
        <!-- Statistiques résumées -->
        <div class="sidebar">
            <h5><i class="fas fa-chart-pie mr-2"></i>Résumé</h5>
            
            <div class="text-center mb-3">
                <h2 class="text-primary" id="sidebar-total-heures">
                    {% if stats.total_heures_rse %}
                        {{ stats.total_heures_rse }}
                    {% else %}
                        0
                    {% endif %}
                </h2>
                <p class="mb-0">Heures totales RSE</p>
            </div>
            
            <div class="progress mb-3" style="height: 20px;">
                <div class="progress-bar bg-success" role="progressbar" style="width: 65%;" aria-valuenow="65" aria-valuemin="0" aria-valuemax="100">65% Maquette</div>
            </div>
            
            <div class="progress mb-4" style="height: 20px;">
                <div class="progress-bar bg-info" role="progressbar" style="width: 35%;" aria-valuenow="35" aria-valuemin="0" aria-valuemax="100">35% Hors maquette</div>
            </div>
            
            <div class="small text-muted">
                <p><i class="fas fa-users mr-1"></i> <strong id="sidebar-etudiants">
                    {% if stats.etudiants_impliques %}
                        {{ stats.etudiants_impliques }}
                    {% else %}
                        0
                    {% endif %}
                </strong> étudiants impliqués</p>
            </div>
        </div>
    </div>
    
    <!-- Contenu principal -->
    <div class="col-md-9">
        <!-- Statistiques résumées -->
        <div class="stats-grid">
            <div class="card stat-card stat-card-heures">
                <div class="card-body text-center">
                    <h3 style="color: #2f0d73;" id="stat-heures">
                        {% if stats.total_heures_rse %}
                            {{ stats.total_heures_rse }}
                        {% else %}
                            0
                        {% endif %}
                    </h3>
                    <p class="mb-0">Heures RSE</p>
                </div>
            </div>
            <div class="card stat-card stat-card-activites">
                <div class="card-body text-center">
                    <h3 style="color: #7c50de;" id="stat-activites">
                        {% if stats.total_activites %}
                            {{ stats.total_activites }}
                        {% else %}
                            0
                        {% endif %}
                    </h3>
                    <p class="mb-0">Activités</p>
                </div>
            </div>
            <div class="card stat-card stat-card-promotions">
                <div class="card-body text-center">
                    <h3 style="color: #ac54c7;" id="stat-promotions">
                        {% if stats.promotions_impliquees %}
                            {{ stats.promotions_impliquees }}
                        {% else %}
                            0
                        {% endif %}
                    </h3>
                    <p class="mb-0">Promotions</p>
                </div>
            </div>
            <div class="card stat-card stat-card-etudiants">
                <div class="card-body text-center">
                    <h3 style="color: #f56960;" id="stat-etudiants">
                        {% if stats.etudiants_impliques %}
                            {{ stats.etudiants_impliques }}
                        {% else %}
                            0
                        {% endif %}
                    </h3>
                    <p class="mb-0">Étudiants</p>
                </div>
            </div>
        </div>

        <!-- Graphiques -->
        <div class="chart-grid">
            <!-- Graphique 1: Répartition par promotion -->
            <div class="chart-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5><i class="fas fa-chart-pie mr-2"></i>Répartition des heures RSE par type</h5>
                    <select id="promotionSelector" class="form-control" style="width: 150px;">
                        <option value="all">Toutes les promotions</option>
                        {% if stats.promotions_disponibles %}
                            {% for promotion in stats.promotions_disponibles %}
                                <option value="{{ promotion }}">{{ promotion }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>
                <canvas id="promotionsChart" height="300"></canvas>
            </div>

            <!-- Graphique 2: Évolution des heures RSE -->
            <div class="chart-container">
                <h5><i class="fas fa-chart-line mr-2"></i>Évolution des heures RSE</h5>
                <canvas id="evolutionChart"></canvas>
            </div>

            <!-- Graphique 3: Répartition par type d'activité -->
            <div class="chart-container">
                <h5><i class="fas fa-chart-bar mr-2"></i>Répartition par type d'activité</h5>
                <canvas id="typeActiviteChart" height="300"></canvas>
            </div>

            <!-- Graphique 4: Répartition CM/TD/TP -->
            <div class="chart-container">
                <h5><i class="fas fa-chalkboard mr-2"></i>Répartition CM/TD/TP</h5>
                <canvas id="formatCoursChart" height="300"></canvas>
            </div>
        </div>

        <!-- Tableau des données -->
        <div class="chart-container" style="height: auto;">
            <h5><i class="fas fa-table mr-2"></i>Données détaillées RSE</h5>
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="rseTable">
                    <thead style="background: linear-gradient(135deg, #2f0d73 0%, #7c50de 100%); color: white;">
                        <tr>
                            <th>Année</th>
                            <th>Promotion</th>
                            <th>Semestre</th>
                            <th>Type d'activité</th>
                            <th>CM</th>
                            <th>TD</th>
                            <th>TP</th>
                            <th>Total</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if rse_data %}
                            {% for item in rse_data %}
                                <tr>
                                    <td>{{ item.annee }}</td>
                                    <td>{{ item.promotion }}</td>
                                    <td>{{ item.semestre }}</td>
                                    <td>{{ item.type_activite }}</td>
                                    <td>{{ item.heures_cm }}</td>
                                    <td>{{ item.heures_td }}</td>
                                    <td>{{ item.heures_tp }}</td>
                                    <td>{{ item.total_heures|default:0 }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="editData('{{ item.id }}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete('{{ item.id }}', '{{ item.type_activite }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="9" class="text-center">Aucune donnée disponible</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ajouter/Modifier des données -->
<div class="modal fade" id="addDataModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title" id="addDataModalTitle">
                    <i class="fas fa-plus-circle mr-2"></i>
                    Ajouter des heures et activités RSE
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="dataForm" method="post" action="{% url 'rse_add_data' %}">
                {% csrf_token %}
                <input type="hidden" name="id" id="rse_id">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Année académique <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" name="annee" id="annee" required min="2000" max="2100" value="2025">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Promotion <span class="text-danger">*</span></label>
                                <select class="form-control" name="promotion" id="promotion" required>
                                    <option value="">Choisir une promotion</option>
                                    <option value="FIE1">FIE1</option>
                                    <option value="FIE2">FIE2</option>
                                    <option value="FIE3">FIE3</option>
                                    <option value="FIE4">FIE4</option>
                                    <option value="FIE5">FIE5</option>
                                    <option value="FIA3">FIA3</option>
                                    <option value="FIA4">FIA4</option>
                                    <option value="FIA5">FIA5</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Semestre <span class="text-danger">*</span></label>
                                <select class="form-control" name="semestre" id="semestre" required>
                                    <option value="">Choisir un semestre</option>
                                    <option value="S1">S1</option>
                                    <option value="S2">S2</option>
                                    <option value="S3">S3</option>
                                    <option value="S4">S4</option>
                                    <option value="S5">S5</option>
                                    <option value="S6">S6</option>
                                    <option value="S7">S7</option>
                                    <option value="S8">S8</option>
                                    <option value="S9">S9</option>
                                    <option value="S10">S10</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label>Type d'activité RSE <span class="text-danger">*</span></label>
                                <select class="form-control" name="type_activite" id="type_activite" required onchange="toggleAutreType()">
                                    <option value="">Sélectionner un type d'activité</option>
                                    {% for activite in activites_maquette %}
                                        {% if activite != "Autre" %}
                                            <option value="{{ activite }}">{{ activite }}</option>
                                        {% endif %}
                                    {% endfor %}
                                    <option value="Autre">Autre (préciser)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row" id="autre_type_container" style="display: none;">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label>Précisez le type d'activité <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="autre_type" id="autre_type" placeholder="Précisez le type d'activité">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <h6 class="font-weight-bold mb-3">Répartition des heures <span class="text-danger">*</span></h6>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Heures CM</label>
                                <input type="number" class="form-control" name="heures_cm" id="heures_cm" required min="0" value="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Heures TD</label>
                                <input type="number" class="form-control" name="heures_td" id="heures_td" required min="0" value="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Heures TP</label>
                                <input type="number" class="form-control" name="heures_tp" id="heures_tp" required min="0" value="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label>Description de l'activité</label>
                                <textarea class="form-control" name="description" id="description" rows="3" placeholder="Description de l'activité RSE..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary-custom">
                        <i class="fas fa-save mr-1"></i>Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Upload CSV -->
<div class="modal fade" id="uploadCSVModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title">
                    <i class="fas fa-file-upload mr-2"></i>
                    Importer un fichier CSV
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="uploadForm" method="post" action="{% url 'upload_csv' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="destination" value="rse">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Fichier CSV <span class="text-danger">*</span></label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="csvFile" name="file" accept=".csv" required>
                            <label class="custom-file-label" for="csvFile">Choisir un fichier...</label>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle mr-2"></i>Format attendu du fichier CSV :</h6>
                        <code>annee,promotion,semestre,type_activite,heures_cm,heures_td,heures_tp,description</code>
                        <hr>
                        <h6>Exemple :</h6>
                        <pre class="mb-0">2023,FIE1,S1,Transition écologique et numérique,10,8,6,Initiation au développement durable
2023,FIE2,S3,Numérique responsable,12,10,8,Éthique informatique et environnement</pre>
                    </div>
                    <div class="form-group">
                        <label>Nom du fichier</label>
                        <input type="text" class="form-control" name="name" placeholder="Données RSE 2025" required>
                    </div>
                    <div class="form-group">
                        <label>Description (optionnel)</label>
                        <textarea class="form-control" name="description" rows="3" 
                                  placeholder="Description du fichier importé..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload mr-1"></i>Importer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de confirmation de suppression -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-trash mr-2"></i>
                    Confirmer la suppression
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir supprimer cette activité RSE ?</p>
                <p id="deleteDetails" class="font-weight-bold"></p>
                <small class="text-muted">Cette action est irréversible.</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                <form id="deleteForm" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger" id="confirmDelete">
                        <i class="fas fa-trash mr-1"></i>Supprimer
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<!-- DataTables JS -->
<script type="text/javascript" src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap4.min.js"></script>
<script>
// Variables globales
// Variables globales
let charts = {};

$(document).ready(function() {
    // Initialiser la page
    initPage();
});

function initPage() {
    // Initialiser DataTable
    $('#rseTable').DataTable({
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/French.json"
        },
        "order": [[0, "desc"], [1, "asc"], [2, "asc"]],
        "pageLength": 10,
        "responsive": true
    });
    
    // Initialiser les graphiques avec les données existantes
    initChartsWithData();
    
    // Initialiser les événements
    initEvents();
}

// Fonction pour initialiser les graphiques avec les données disponibles
function initChartsWithData() {
    // Utiliser les données déjà chargées dans le template
    const statsElement = document.getElementById('stats-data');
    
    if (statsElement) {
        try {
            const stats = JSON.parse(statsElement.textContent);
            console.log("Données stats chargées:", stats);
            
            // Initialiser les graphiques
            initCharts(stats);
        } catch (e) {
            console.error('Erreur lors du parsing des données stats:', e);
        }
    } else {
        console.log('Aucun élément avec ID stats-data trouvé.');
    }
}

// Fonction pour initialiser les graphiques
function initCharts(stats) {
    if (!stats) {
        console.error("Aucune donnée de statistiques disponible.");
        return;
    }
    
    console.log("Initialisation des graphiques avec les données:", stats);
    
    // Graphique 1: Répartition par promotion (camembert)
    initPromotionChart(stats);
    
    // Graphique 2: Évolution des heures RSE (ligne)
    initEvolutionChart(stats);
    
    // Graphique 3: Répartition par type d'activité (barres)
    initTypeActiviteChart(stats);
    
    // Graphique 4: Répartition CM/TD/TP (donut)
    initFormatCoursChart(stats);
}

// Graphique 1: Répartition par promotion
function initPromotionChart(stats) {
    const ctx = document.getElementById('promotionsChart');
    if (!ctx) {
        console.error("Élément canvas 'promotionsChart' non trouvé");
        return;
    }
    
    // Vérifier si les données nécessaires existent
    if (!stats.repartition_par_promotion) {
        console.error("Données repartition_par_promotion manquantes");
        return;
    }
    
    // Préparer les données pour toutes les promotions
    const promotionLabels = [];
    const promotionValues = [];
    
    Object.entries(stats.repartition_par_promotion).forEach(([promotion, data]) => {
        promotionLabels.push(promotion);
        promotionValues.push(data.total_heures || 0);
    });
    
    // Créer le graphique
    charts.promotions = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: promotionLabels,
            datasets: [{
                data: promotionValues,
                backgroundColor: generateColors(promotionLabels.length)
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw;
                            const total = context.dataset.data.reduce((acc, val) => acc + val, 0);
                            const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                            return `${label}: ${value} heures (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    
    console.log("Graphique promotions créé avec les données:", promotionLabels, promotionValues);
}

// Graphique 2: Évolution des heures RSE
function initEvolutionChart(stats) {
    const ctx = document.getElementById('evolutionChart');
    if (!ctx) {
        console.error("Élément canvas 'evolutionChart' non trouvé");
        return;
    }
    
    // Vérifier si les données nécessaires existent
    if (!stats.evolution_annuelle) {
        console.error("Données evolution_annuelle manquantes");
        return;
    }
    
    // Préparer les données d'évolution
    const annees = [];
    const valeurs = [];
    
    Object.entries(stats.evolution_annuelle).forEach(([annee, data]) => {
        annees.push(annee);
        valeurs.push(data.total_heures || 0);
    });
    
    // Créer le graphique
    charts.evolution = new Chart(ctx, {
        type: 'line',
        data: {
            labels: annees,
            datasets: [{
                label: 'Heures RSE',
                data: valeurs,
                borderColor: '#7c50de',
                backgroundColor: 'rgba(124, 80, 222, 0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Nombre d\'heures'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Année'
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.raw} heures`;
                        }
                    }
                }
            }
        }
    });
    
    console.log("Graphique évolution créé avec les données:", annees, valeurs);
}

// Graphique 3: Répartition par type d'activité
function initTypeActiviteChart(stats) {
    const ctx = document.getElementById('typeActiviteChart');
    if (!ctx) {
        console.error("Élément canvas 'typeActiviteChart' non trouvé");
        return;
    }
    
    // Vérifier si les données nécessaires existent
    if (!stats.repartition_par_type) {
        console.error("Données repartition_par_type manquantes");
        return;
    }
    
    // Préparer les données par type d'activité
    const types = [];
    const valeurs = [];
    
    Object.entries(stats.repartition_par_type).forEach(([type, data]) => {
        types.push(type);
        valeurs.push(data.total_heures || 0);
    });
    
    // Créer le graphique
    charts.typeActivite = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: types,
            datasets: [{
                label: 'Heures par type d\'activité',
                data: valeurs,
                backgroundColor: generateColors(types.length)
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Nombre d\'heures'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Type d\'activité'
                    },
                    ticks: {
                        autoSkip: false,
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            }
        }
    });
    
    console.log("Graphique types d'activité créé avec les données:", types, valeurs);
}

// Graphique 4: Répartition CM/TD/TP
function initFormatCoursChart(stats) {
    const ctx = document.getElementById('formatCoursChart');
    if (!ctx) {
        console.error("Élément canvas 'formatCoursChart' non trouvé");
        return;
    }
    
    // Calculer les totaux pour CM/TD/TP
    let heuresCM = 0;
    let heuresTD = 0;
    let heuresTP = 0;
    
    // Vérifier quelle source de données est disponible
    if (stats.donnees_par_element && stats.donnees_par_element.length > 0) {
        // Utiliser donnees_par_element si disponible
        stats.donnees_par_element.forEach(item => {
            heuresCM += parseInt(item.heures_cm) || 0;
            heuresTD += parseInt(item.heures_td) || 0;
            heuresTP += parseInt(item.heures_tp) || 0;
        });
    } else if (stats.format_cours_pourcentage) {
        // Sinon, utiliser les pourcentages si disponibles et un total fictif de 100
        const total = 100;
        heuresCM = stats.format_cours_pourcentage.CM * total / 100;
        heuresTD = stats.format_cours_pourcentage.TD * total / 100;
        heuresTP = stats.format_cours_pourcentage.TP * total / 100;
    }
    
    // Créer le graphique
    charts.formatCours = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['CM', 'TD', 'TP'],
            datasets: [{
                data: [heuresCM, heuresTD, heuresTP],
                backgroundColor: ['#2f0d73', '#ac54c7', '#ffb43c']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '50%',
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw;
                            const total = context.dataset.data.reduce((acc, val) => acc + val, 0);
                            const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                            return `${label}: ${value} heures (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    
    console.log("Graphique répartition CM/TD/TP créé avec les données:", [heuresCM, heuresTD, heuresTP]);
}

// Fonction pour générer des couleurs pour les graphiques
function generateColors(count) {
    const baseColors = [
        '#2f0d73', '#7c50de', '#ac54c7', '#f56960', '#ffb43c', '#3cbebe',
        '#8b5fbf', '#ff6b6b', '#4dabf7', '#20c997', '#ff922b', '#5f3dc4'
    ];
    
    if (count <= baseColors.length) {
        return baseColors.slice(0, count);
    }
    
    const colors = [...baseColors];
    
    // Générer des couleurs supplémentaires si nécessaire
    for (let i = baseColors.length; i < count; i++) {
        const r = Math.floor(Math.random() * 200) + 55; // Éviter les couleurs trop sombres
        const g = Math.floor(Math.random() * 200) + 55;
        const b = Math.floor(Math.random() * 200) + 55;
        colors.push(`rgb(${r}, ${g}, ${b})`);
    }
    
    return colors;
}

// Fonction pour actualiser tous les graphiques
function refreshAllCharts() {
    // Détruire les graphiques existants
    Object.values(charts).forEach(chart => {
        if (chart && typeof chart.destroy === 'function') {
            chart.destroy();
        }
    });
    
    // Vider l'objet charts
    charts = {};
    
    // Afficher un indicateur de chargement
    const originalBtn = $('.btn-warning').html();
    $('.btn-warning').html('<i class="fas fa-spinner fa-spin mr-2"></i>Actualisation...').prop('disabled', true);
    
    // Recharger la page
    setTimeout(() => {
        window.location.reload();
    }, 1000);
}

// Initialiser les événements
function initEvents() {
    // Gérer le changement du sélecteur de promotion
    $('#promotionSelector').on('change', function() {
        updatePromotionChart($(this).val());
    });

    // Gestion du nom de fichier pour l'upload
    $('.custom-file-input').on('change', function() {
        let fileName = $(this).val().split('\\').pop();
        $(this).siblings('.custom-file-label').addClass("selected").html(fileName);
    });

    // Filtres
    $('#applyFilters').click(function() {
        filterTable();
    });

    $('#resetFilters').click(function() {
        $('#filterAnnee').val('');
        $('#filterPromotion').val('');
        $('#filterSemestre').val('');
        $('#filterTypeActivite').val('');
        filterTable();
    });
}

// Fonction pour mettre à jour le graphique en fonction de la promotion sélectionnée
function updatePromotionChart(selectedPromotion) {
    // Détruire le graphique existant s'il existe
    if (charts.promotions) {
        charts.promotions.destroy();
    }
    
    // Récupérer les données du template
    const statsElement = document.getElementById('stats-data');
    
    if (!statsElement) {
        console.error('Données stats RSE non disponibles');
        return;
    }
    
    try {
        const stats = JSON.parse(statsElement.textContent);
        
        // Données par défaut (toutes promotions)
        let cmTotal = 0;
        let tdTotal = 0;
        let tpTotal = 0;
        let title = 'Toutes les promotions';
        
        if (stats.donnees_par_element && stats.donnees_par_element.length > 0) {
            const filteredData = selectedPromotion === 'all' 
                ? stats.donnees_par_element 
                : stats.donnees_par_element.filter(item => item.promotion === selectedPromotion);
            
            // Calculer les totaux
            filteredData.forEach(item => {
                cmTotal += parseInt(item.heures_cm) || 0;
                tdTotal += parseInt(item.heures_td) || 0;
                tpTotal += parseInt(item.heures_tp) || 0;
            });
            
            if (selectedPromotion !== 'all') {
                title = selectedPromotion;
            }
        }
        
        // Créer le graphique
        const ctx = document.getElementById('promotionsChart').getContext('2d');
        charts.promotions = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['CM', 'TD', 'TP'],
                datasets: [{
                    data: [cmTotal, tdTotal, tpTotal],
                    backgroundColor: ['#2f0d73', '#ac54c7', '#ffb43c']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    },
                    title: {
                        display: true,
                        text: title,
                        font: {
                            size: 16
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw;
                                const total = cmTotal + tdTotal + tpTotal;
                                const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                return `${label}: ${value} heures (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
        
    } catch (e) {
        console.error('Erreur lors de la mise à jour du graphique promotion:', e);
    }
}

// Fonction pour filtrer le tableau
function filterTable() {
    const annee = $('#filterAnnee').val();
    const promotion = $('#filterPromotion').val();
    const semestre = $('#filterSemestre').val();
    const typeActivite = $('#filterTypeActivite').val();
    
    const table = $('#rseTable').DataTable();
    
    // Réinitialiser d'abord
    table.search('').columns().search('').draw();
    
    // Appliquer les filtres
    if (annee) {
        table.column(0).search(annee).draw();
    }
    if (promotion) {
        table.column(1).search(promotion).draw();
    }
    if (semestre) {
        table.column(2).search(semestre).draw();
    }
    if (typeActivite) {
        table.column(3).search(typeActivite).draw();
    }
}

// Fonction pour afficher/masquer le champ "autre type"
function toggleAutreType() {
    const typeSelect = document.getElementById('type_activite');
    const autreContainer = document.getElementById('autre_type_container');
    
    if (!typeSelect || !autreContainer) return;
    
    if (typeSelect.value === 'Autre') {
        autreContainer.style.display = 'block';
        document.getElementById('autre_type').setAttribute('required', 'required');
    } else {
        autreContainer.style.display = 'none';
        document.getElementById('autre_type').removeAttribute('required');
    }
}

// Confirmer la suppression
function confirmDelete(id, type) {
    if (!id) return;
    
    const deleteDetails = document.getElementById('deleteDetails');
    if (deleteDetails) {
        deleteDetails.textContent = type || id;
    }
    
    // Configurer le formulaire de suppression
    const deleteForm = document.getElementById('deleteForm');
    if (deleteForm) {
        deleteForm.action = `/api/rse/delete/${id}`;
    }
    
    // Afficher la modal
    $('#deleteModal').modal('show');
}

// Éditer les données
function editData(id) {
    if (!id) return;
    
    // Trouver la ligne dans le tableau
    const row = $(`#rseTable tr button[onclick*="${id}"]`).closest('tr');
    if (row.length) {
        const cells = row.find('td');
        
        // Remplir le formulaire avec les données existantes
        $('#rse_id').val(id);
        $('#annee').val(cells.eq(0).text().trim());
        $('#promotion').val(cells.eq(1).text().trim());
        $('#semestre').val(cells.eq(2).text().trim());
        
        // Gérer le type d'activité
        const typeActivite = cells.eq(3).text().trim();
        const typeSelect = document.getElementById('type_activite');
        
        let found = false;
        if (typeSelect) {
            // Parcourir les options pour trouver si le type existe
            for (let i = 0; i < typeSelect.options.length; i++) {
                if (typeSelect.options[i].value === typeActivite) {
                    typeSelect.selectedIndex = i;
                    found = true;
                    break;
                }
            }
            
            // Si le type n'existe pas dans la liste, utiliser "Autre"
            if (!found) {
                // Trouver l'option "Autre"
                for (let i = 0; i < typeSelect.options.length; i++) {
                    if (typeSelect.options[i].value === 'Autre') {
                        typeSelect.selectedIndex = i;
                        $('#autre_type').val(typeActivite);
                        $('#autre_type_container').show();
                        break;
                    }
                }
            }
        }
        
        // Remplir les heures
        $('#heures_cm').val(cells.eq(4).text().trim());
        $('#heures_td').val(cells.eq(5).text().trim());
        $('#heures_tp').val(cells.eq(6).text().trim());
        
        // Mettre à jour le titre de la modal
        $('#addDataModalTitle').html('<i class="fas fa-edit mr-2"></i>Modifier les données RSE');
        
        // Afficher la modal
        $('#addDataModal').modal('show');
    } else {
        console.error(`Ligne avec ID ${id} non trouvée dans le tableau`);
    }
}

// Afficher une notification
function showNotification(type, message) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const iconClass = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
    
    const notification = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;">
            <i class="fas ${iconClass} mr-2"></i>
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    `;
    
    $('body').append(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        $('.alert').fadeOut('slow', function() {
            $(this).remove();
        });
    }, 3000);
}
{% endblock %}
