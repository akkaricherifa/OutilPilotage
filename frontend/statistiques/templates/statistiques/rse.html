{% extends 'statistiques/base.html' %}
{% load static %}

{% block title %}RSE - Responsabilité Sociétale - AppISIS{% endblock %}

{% block extra_css %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap4.min.css">

<style>
   .stat-card {
    transition: transform 0.2s;
    border-left: 4px solid;
    margin-bottom: 20px;
    }
     .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
     .stat-card-heures { border-left-color: #2f0d73; }
    .stat-card-activites { border-left-color: #7c50de; }
    .stat-card-promotions { border-left-color: #ac54c7; }
    .stat-card-etudiants { border-left-color: #f56960; }

     .chart-container {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    margin-bottom: 30px;
    border: 1px solid #e9ecef;
    height: 450px;
    }

     .chart-container h5 {
    color: #2f0d73;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 10px;
    margin-bottom: 20px;
    }

     .dashboard-header {
    background: linear-gradient(135deg, #6a4c93 0%, #8b5cf6 50%, #a855f7 100%);
    color: white;
    padding: 40px 30px;
    border-radius: 20px;
    margin-bottom: 30px;
    position: relative;
    overflow: hidden;
     }

     .dashboard-header::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
    animation: shimmer 3s infinite ease-in-out;
     }

    @keyframes shimmer {
    0%, 100% { transform: rotate(0deg); }
    50% { transform: rotate(180deg); }
     }

    .dashboard-header .header-content {
    position: relative;
    z-index: 2;
    }

    .dashboard-header h1 {
    margin: 0 0 10px 0;
    font-weight: 600;
    font-size: 2.5rem;
    display: flex;
    align-items: center;
    gap: 15px;
    }

    .dashboard-header h1 i {
    font-size: 2.2rem;
    opacity: 0.9;
    }

    .dashboard-header p {
    margin: 0;
    font-size: 1.1rem;
    opacity: 0.9;
    font-weight: 300;
     }

    .action-buttons {
    display: flex !important;
    flex-wrap: nowrap !important;
    align-items: center;
     }

      /* NOUVEAUX STYLES POUR LES BOUTONS */
     .action-button {
    padding: 12px 25px;
    font-size: 1rem;
    font-weight: 600;
    border-radius: 50px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    white-space: nowrap;
     }

    .btn-add {
    background: white;
    color: #7c50de;
    border: 2px solid #7c50de;
    }

    .btn-add:hover {
    background: #7c50de;
    color: white;
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(124, 80, 222, 0.3);
    }

    .btn-import {
    background: #20c997;
    color: white;
    border: none;
     }

    .btn-import:hover {
    background: #16a085;
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(32, 201, 151, 0.3);
    }  

    /* NOUVEAU STYLE POUR LE RÉSUMÉ */
    .rse-summary-box {
    background: white;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    margin-top: 20px;
    margin-bottom: 30px;
    display: flex;
    align-items: center;
    }

    .rse-summary-item {
    text-align: center;
    padding: 0 20px;
    flex: 1;
     }

    .rse-summary-item h2 {
    font-size: 2.5rem;
    font-weight: 700;
    color: #7c50de;
    margin-bottom: 5px;
     }

    .rse-summary-item p {
    margin: 0;
    color: #6c757d;
     } 

    .rse-summary-divider {
    width: 1px;
    height: 60px;
    background: #e9ecef;
     }

    .progress-container {
    flex: 2;
    padding: 0 20px;
     }

    .progress-label {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
    font-weight: 600;
    font-size: 0.9rem;
     }

    .progress-bar-success {
    background-color: #20c997;
     }

    .progress-bar-info {
    background-color: #7c50de;
     }

    /* Autres styles existants conservés */
    .custom-file {
    position: relative;
    display: inline-block;
    width: 100%;
    height: calc(1.5em + 0.75rem + 2px);
    margin-bottom: 0;
     }

    .custom-file-input {
    position: relative;
    z-index: 2;
    width: 100%;
    height: calc(1.5em + 0.75rem + 2px);
    margin: 0;
    opacity: 0;
     }

    .custom-file-label {
    position: absolute;
    top: 0;
    right: 0;
    left: 0;
    z-index: 1;
    height: calc(1.5em + 0.75rem + 2px);
    padding: 0.375rem 0.75rem;
    font-weight: 400;
    line-height: 1.5;
    color: #495057;
    background-color: #fff;
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    transition: all 0.3s ease;
    cursor: pointer;
     }

    .custom-file-label::after {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    z-index: 3;
    display: block;
    height: calc(1.5em + 0.75rem);
    padding: 0.375rem 0.75rem;
    line-height: 1.5;
    color: #495057;
    content: "Browse";
    background-color: #e9ecef;
    border-left: inherit;
    border-radius: 0 0.25rem 0.25rem 0;
     }

    .custom-file-label.selected {
    color: #495057;
    background-color: #fff;
     }

    .custom-file-input:focus ~ .custom-file-label {
    border-color: #7c50de;
    box-shadow: 0 0 0 0.2rem rgba(124, 80, 222, 0.25);
     }

    .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
     }

    .chart-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 30px;
      }

     .modal-header-custom {
    background: linear-gradient(135deg, #2f0d73 0%, #7c50de 100%);
    color: white;
     }

    .form-control:focus {
    border-color: #7c50de;
    box-shadow: 0 0 0 0.2rem rgba(124, 80, 222, 0.25);
     }

     .btn-primary-custom {
    background: linear-gradient(135deg, #2f0d73 0%, #7c50de 100%);
    border: none;
    color: white;
      }

    .btn-primary-custom:hover {
    background: linear-gradient(135deg, #7c50de 0%, #ac54c7 100%);
    }

     canvas {
    max-height: 300px;
     }

     /* Style pour agrandir le tableau et optimiser l'espace */
     .table-container {
    height: calc(100vh - 350px);
    min-height: 400px;
    overflow-y: auto;
    }

     @media (max-width: 768px) {
    .chart-grid {
        grid-template-columns: 1fr;
    }
    
    .rse-summary-box {
        flex-direction: column;
        padding: 15px;
    }
    
    .rse-summary-item {
        margin-bottom: 15px;
    }
    
    .rse-summary-divider {
        width: 80%;
        height: 1px;
        margin: 10px 0;
    }
    
    .action-button {
        margin-bottom: 10px;
        width: 100%;
    }
   }
</style>
{% endblock %}

{% block content %}
<!-- CORRECTION : Stockage des données plus clair et en JSON -->
<div id="stats-data" style="display: none;">{{ stats|safe }}</div>

<!-- En-tête du dashboard -->
<div class="dashboard-header">
    <div class="header-content">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1>
                    <i class="fas fa-leaf"></i>
                    RSE - Responsabilité Sociétale
                </h1>
                <p>Pilotage des actions RSE et gestion des heures dédiées à la responsabilité sociétale de l'école</p>
            </div>
            <div class="action-buttons d-flex flex-wrap">
                <button class="action-button btn-add mr-2" data-toggle="modal" data-target="#addDataModal">
                    <i class="fas fa-plus mr-2"></i>Ajouter des données
                </button>
                <button class="action-button btn-import" data-toggle="modal" data-target="#uploadCSVModal">
                    <i class="fas fa-file-upload mr-2"></i>Importer CSV
                </button>
                
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Sidebar filtres -->
    <!-- Contenu principal -->
    <div class="col-md-12">
        <!-- Statistiques résumées -->
        <div class="stats-grid">
            <div class="card stat-card stat-card-heures">
                <div class="card-body text-center">
                    <h3 style="color: #2f0d73;" id="stat-heures">
                        {% if stats.total_heures_rse %}
                            {{ stats.total_heures_rse }}
                        {% else %}
                            0
                        {% endif %}
                    </h3>
                    <p class="mb-0">Résumé : Heures Totales RSE</p>
                </div>
            </div>
        </div>

        <!-- Graphiques -->
        <div class="chart-grid">
            <!-- Graphique 1: Répartition par promotion -->
            <div class="chart-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5><i class="fas fa-chart-pie mr-2"></i>Répartition des heures RSE par type</h5>
                    <select id="promotionSelector" class="form-control" style="width: 150px;">
                        <option value="all">Toutes les promotions</option>
                        {% if stats.promotions_disponibles %}
                            {% for promotion in stats.promotions_disponibles %}
                                <option value="{{ promotion }}">{{ promotion }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>
                <div class="chart-wrapper" style="position: relative; height: 350px; width: 100%; margin: 0 auto;">
        <canvas id="promotionsChart"></canvas>
    </div>
            </div>

            <!-- Graphique 2: Évolution des heures RSE -->
            <div class="chart-container">
                <h5><i class="fas fa-chart-line mr-2"></i>Nombre des heures RSE Totales par Promotion</h5>
                <canvas id="promotionHoursChart"></canvas>
            </div>

            <!-- Graphique 3: Répartition par type d'activité -->
            <div class="chart-container">
                <h5><i class="fas fa-chart-bar mr-2"></i>Répartition par type d'activité</h5>
                <canvas id="typeActiviteChart" height="300"></canvas>
            </div>

            <!-- Graphique 4: Répartition CM/TD/TP -->
            <div class="chart-container">
                <h5><i class="fas fa-chalkboard mr-2"></i>Répartition CM/TD/TP</h5>
                <canvas id="formatCoursChart" height="300"></canvas>
            </div>
        </div>

        <!-- Tableau des données (maintenant en pleine largeur et plus grand) -->
        <div class="chart-container" style="height: auto; margin-bottom: 30px;">
            <h5><i class="fas fa-table mr-2"></i>Données détaillées RSE</h5>
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="rseTable">
                    <thead style="background: linear-gradient(135deg, #2f0d73 0%, #7c50de 100%); color: white;">
                        <tr>
                            <th>Année</th>
                            <th>Promotion</th>
                            <th>Semestre</th>
                            <th>Type d'activité</th>
                            <th>CM</th>
                            <th>TD</th>
                            <th>TP</th>
                            <th>Total</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if rse_data %}
                            {% for item in rse_data %}
                                <tr>
                                    <td>{{ item.annee }}</td>
                                    <td>{{ item.promotion }}</td>
                                    <td>{{ item.semestre }}</td>
                                    <td>{{ item.type_activite }}</td>
                                    <td>{{ item.heures_cm }}</td>
                                    <td>{{ item.heures_td }}</td>
                                    <td>{{ item.heures_tp }}</td>
                                    <td>{{ item.total_heures|default:0 }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="editData('{{ item.id }}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete('{{ item.id }}', '{{ item.type_activite }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="9" class="text-center">Aucune donnée disponible</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<!-- Modal Ajouter/Modifier des données -->
<div class="modal fade" id="addDataModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title" id="addDataModalTitle">
                    <i class="fas fa-plus-circle mr-2"></i>
                    Ajouter des heures et activités RSE
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="dataForm" method="post" action="{% url 'rse_add_data' %}">
                {% csrf_token %}
                <input type="hidden" name="id" id="rse_id">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Année académique <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" name="annee" id="annee" required min="2000" max="2100" value="2025">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Promotion <span class="text-danger">*</span></label>
                                <select class="form-control" name="promotion" id="promotion" required>
                                    <option value="">Choisir une promotion</option>
                                    <option value="FIE1">FIE1</option>
                                    <option value="FIE2">FIE2</option>
                                    <option value="FIE3">FIE3</option>
                                    <option value="FIE4">FIE4</option>
                                    <option value="FIE5">FIE5</option>
                                    <option value="FIA3">FIA3</option>
                                    <option value="FIA4">FIA4</option>
                                    <option value="FIA5">FIA5</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Semestre <span class="text-danger">*</span></label>
                                <select class="form-control" name="semestre" id="semestre" required>
                                    <option value="">Choisir un semestre</option>
                                    <option value="S1">S1</option>
                                    <option value="S2">S2</option>
                                    <option value="S3">S3</option>
                                    <option value="S4">S4</option>
                                    <option value="S5">S5</option>
                                    <option value="S6">S6</option>
                                    <option value="S7">S7</option>
                                    <option value="S8">S8</option>
                                    <option value="S9">S9</option>
                                    <option value="S10">S10</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label>Type d'activité RSE <span class="text-danger">*</span></label>
                                <select class="form-control" name="type_activite" id="type_activite" required onchange="toggleAutreType()">
                                    <option value="">Sélectionner un type d'activité</option>
                                    {% for activite in activites_maquette %}
                                        {% if activite != "Autre" %}
                                            <option value="{{ activite }}">{{ activite }}</option>
                                        {% endif %}
                                    {% endfor %}
                                    <option value="Autre">Autre (préciser)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row" id="autre_type_container" style="display: none;">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label>Précisez le type d'activité <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="autre_type" id="autre_type" placeholder="Précisez le type d'activité">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <h6 class="font-weight-bold mb-3">Répartition des heures <span class="text-danger">*</span></h6>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Heures CM</label>
                                <input type="number" class="form-control" name="heures_cm" id="heures_cm" required min="0" value="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Heures TD</label>
                                <input type="number" class="form-control" name="heures_td" id="heures_td" required min="0" value="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Heures TP</label>
                                <input type="number" class="form-control" name="heures_tp" id="heures_tp" required min="0" value="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label>Description de l'activité</label>
                                <textarea class="form-control" name="description" id="description" rows="3" placeholder="Description de l'activité RSE..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary-custom">
                        <i class="fas fa-save mr-1"></i>Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Upload CSV -->
<div class="modal fade" id="uploadCSVModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title">
                    <i class="fas fa-file-upload mr-2"></i>
                    Importer un fichier CSV
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="uploadForm" method="post" action="{% url 'rse_upload_csv' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" name="destination" value="rse">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Fichier CSV <span class="text-danger">*</span></label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="csvFile" name="file" accept=".csv" required>
                            <label class="custom-file-label" for="csvFile">Choisir un fichier...</label>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle mr-2"></i>Format attendu du fichier CSV :</h6>
                        <code>annee,promotion,semestre,type_activite,heures_cm,heures_td,heures_tp,description</code>
                        <hr>
                        <h6>Exemple :</h6>
                        <pre class="mb-0">2023,FIE1,S1,Transition écologique et numérique,10,8,6,Initiation au développement durable
2023,FIE2,S3,Numérique responsable,12,10,8,Éthique informatique et environnement</pre>
                    </div>
                    <div class="form-group">
                        <label>Nom du fichier</label>
                        <input type="text" class="form-control" name="name" placeholder="Données RSE 2025" required>
                    </div>
                    <div class="form-group">
                        <label>Description (optionnel)</label>
                        <textarea class="form-control" name="description" rows="3" 
                                  placeholder="Description du fichier importé..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload mr-1"></i>Importer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de confirmation de suppression -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-trash mr-2"></i>
                    Confirmer la suppression
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir supprimer cette activité RSE ?</p>
                <p id="deleteDetails" class="font-weight-bold"></p>
                <small class="text-muted">Cette action est irréversible.</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                <form id="deleteForm" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger" id="confirmDelete">
                        <i class="fas fa-trash mr-1"></i>Supprimer
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<!-- DataTables JS -->
<script type="text/javascript" src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap4.min.js"></script>
<script>
// Configuration globale des graphiques
Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
Chart.defaults.color = '#495057';
// Variables globales
let charts = {};
let rseData = [];
$(document).ready(function() {
    // Initialiser DataTable
    initDataTable();
    // Initialiser les graphiques vides
    initEmptyCharts();
    // Charger les données pour chaque graphique
    loadRseDataFromAPI();
    loadRseEvolutionData();
    loadRseActivityTypesData();
    loadRseFormatCoursData();
    loadRseHoursByPromotionData();
    // Configurer les événements
    setupEventListeners();
    loadAndPopulatePromotions();
    
    // Gestion du formulaire d'upload CSV
    $('#uploadForm').on('submit', function(e) {
        e.preventDefault();
        
        // Afficher un indicateur de chargement
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.html('<i class="fas fa-spinner fa-spin mr-1"></i>Importation...').prop('disabled', true);
        
        let formData = new FormData(this);
        
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                $('#uploadCSVModal').modal('hide');
                showNotification('success', 'Fichier CSV importé avec succès !');
                
                // Redirection vers la même page après un court délai
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            },
            error: function(xhr) {
                console.error("Erreur AJAX:", xhr.responseText);
                try {
                    const response = JSON.parse(xhr.responseText);
                    showNotification('error', response.message || response.error || 'Erreur lors de l\'importation du fichier CSV.');
                } catch (e) {
                    showNotification('error', 'Erreur lors de l\'importation du fichier CSV.');
                }
            },
            complete: function() {
                // Restaurer le bouton
                submitBtn.html(originalText).prop('disabled', false);
            }
        });
    });
    $('.custom-file-input').on('change', function() {
    let fileName = $(this).val().split('\\').pop();
    $(this).siblings('.custom-file-label').addClass("selected").html(fileName || "Choisir un fichier...");
    });
    
    // Gestion du formulaire d'ajout/édition
    $('#dataForm').on('submit', function(e) {
        e.preventDefault();
        
        // Vérifier la validité du formulaire
        if (!validateForm()) {
            return;
        }
        
        // Afficher un indicateur de chargement
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.html('<i class="fas fa-spinner fa-spin mr-1"></i>Enregistrement...').prop('disabled', true);
        
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: $(this).serialize(),
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                $('#addDataModal').modal('hide');
                showNotification('success', response.message || 'Données enregistrées avec succès !');
                
                // Redirection vers la même page après un court délai
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            },
            error: function(xhr) {
                console.error("Erreur AJAX:", xhr.responseText);
                try {
                    const response = JSON.parse(xhr.responseText);
                    showNotification('error', response.message || response.error || 'Erreur lors de l\'enregistrement des données.');
                } catch (e) {
                    showNotification('error', 'Erreur lors de l\'enregistrement des données.');
                }
            },
            complete: function() {
                // Restaurer le bouton
                submitBtn.html(originalText).prop('disabled', false);
            }
        });
    });
});

// Initialiser DataTable
function initDataTable() {
    $('#rseTable').DataTable({
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/French.json"
        },
        "order": [[0, "desc"], [1, "asc"], [2, "asc"]],
        "pageLength": 4,
        "lengthMenu": [5, 10, 15, 20, 25],
        "responsive": true,
        "pagingType": "full_numbers",
        "dom": '<"top"lf>rt<"bottom"ip><"clear">'
    });
}

// Initialiser des graphiques vides
function initEmptyCharts() {
    // Graphique 1: Répartition par promotion
    const ctx1 = document.getElementById('promotionsChart');
    if (ctx1) {
        charts.promotions = new Chart(ctx1, {
            type: 'pie',
            data: {
                labels: ['Chargement...'],
                datasets: [{
                    data: [1],
                    backgroundColor: ['#cccccc'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }
    
    // Graphique 2: Évolution des heures RSE
    const ctx5 = document.getElementById('promotionHoursChart');
if (ctx5) {
    charts.promotionHours = new Chart(ctx5, {
        type: 'bar',
        data: {
            labels: ['Chargement...'],
            datasets: [{
                label: 'Chargement...',
                data: [0],
                backgroundColor: ['#cccccc']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}
    
    // Graphique 3: Répartition par type d'activité
    const ctx3 = document.getElementById('typeActiviteChart');
    if (ctx3) {
        charts.typeActivite = new Chart(ctx3, {
            type: 'bar',
            data: {
                labels: ['Chargement...'],
                datasets: [{
                    label: 'Chargement...',
                    data: [0],
                    backgroundColor: ['#cccccc']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }
    
    // Graphique 4: Répartition CM/TD/TP
    const ctx4 = document.getElementById('formatCoursChart');
    if (ctx4) {
        charts.formatCours = new Chart(ctx4, {
            type: 'doughnut',
            data: {
                labels: ['Chargement...'],
                datasets: [{
                    data: [1],
                    backgroundColor: ['#cccccc']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }
}

// Configurer les événements
function setupEventListeners() {
    // Sélecteur de promotion pour le graphique 1
    $('#promotionSelector').on('change', function() {
        const selectedPromotion = $(this).val();
        loadRseDataFromAPI(selectedPromotion);
    });
    
    // Bouton d'actualisation
    $('.btn-warning').on('click', function() {
        refreshAllCharts();
    });
    
    // Appliquer les filtres au tableau
    $('#applyFilters').on('click', function() {
        filterTable();
    });
    
    // Réinitialiser les filtres
    $('#resetFilters').on('click', function() {
        $('#filterAnnee, #filterPromotion, #filterSemestre, #filterTypeActivite').val('');
        filterTable();
    });
    
    // Gestion du type d'activité "Autre"
    $('#type_activite').on('change', function() {
        toggleAutreType();
    });
}

// Fonction pour charger les données RSE depuis l'API
function loadRseDataFromAPI(selectedPromotion = 'all') {
    // Afficher un indicateur de chargement
    $('#promotionsChart').css('opacity', '0.5');
    
    // Faire la requête AJAX vers l'API
    $.ajax({
        url: '/api/rse-data/',
        type: 'GET',
        data: {
            promotion: selectedPromotion
        },
        success: function(response) {
            // Mettre à jour le graphique avec les nouvelles données
            updatePromotionChart(response.data, selectedPromotion);
            
            // Si c'est la première fois, initialiser également le sélecteur de promotions
            if (selectedPromotion === 'all' && response.promotions) {
                populatePromotionSelector(response.promotions);
            }
            
            // Mettre à jour d'autres éléments de l'interface si nécessaire
            updateStatsSummary(response.data);
        },
        error: function(xhr) {
            console.error('Erreur lors du chargement des données:', xhr.responseText);
            showNotification('error', 'Erreur lors du chargement des données RSE');
        },
        complete: function() {
            // Restaurer l'opacité du graphique
            $('#promotionsChart').css('opacity', '1');
        }
    });
}

// Fonction pour mettre à jour le graphique de répartition par promotion
function updatePromotionChart(data, selectedPromotion) {
    const ctx = document.getElementById('promotionsChart');
    if (!ctx) {
        console.error("Canvas 'promotionsChart' non trouvé");
        return;
    }
    
    // Détruire le graphique existant s'il existe
    if (charts.promotions) {
        charts.promotions.destroy();
    }
    
    // Extraire les données
    const totalCM = data.heures_cm || 0;
    const totalTD = data.heures_td || 0;
    const totalTP = data.heures_tp || 0;
    
    // Préparer les labels et données pour les heures additionnelles
    const additionalLabels = [];
    const additionalData = [];
    const additionalColors = ['#F08080', '#4682B4', '#9ACD32', '#FFD700']; // Couleurs pour heures additionnelles
    
    // Extraire les heures additionnelles si présentes
    let index = 0;
    for (const key in data) {
        if (['heures_cm', 'heures_td', 'heures_tp'].includes(key)) continue;
        if (key.startsWith('heure') && !isNaN(parseInt(data[key]))) {
            additionalLabels.push(key.charAt(0).toUpperCase() + key.slice(1));
            additionalData.push(data[key]);
            index++;
        }
    }
    
    // Combiner les données standard et additionnelles
    const allLabels = ['CM', 'TD', 'TP', ...additionalLabels];
    const allData = [totalCM, totalTD, totalTP, ...additionalData];
    const allColors = ['#2f0d73', '#ac54c7', '#ffb43c', ...additionalColors.slice(0, additionalLabels.length)];
    
    console.log("Données pour le graphique:", { CM: totalCM, TD: totalTD, TP: totalTP, additionalHours: additionalData });
    
    // Titre du graphique
    const title = selectedPromotion === 'all' ? 'Toutes les promotions' : selectedPromotion;
    
    // Créer le graphique
    charts.promotions = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: allLabels,
            datasets: [{
                data: allData,
                backgroundColor: allColors,
                borderWidth: 1,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                },
                title: {
                    display: true,
                    text: title,
                    font: {
                        size: 16
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw;
                            const total = allData.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                            return `${label}: ${value} heures (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    
    console.log("Graphique de promotions mis à jour avec succès");
}

// Fonction pour peupler le sélecteur de promotions
function populatePromotionSelector(promotions) {
    const selector = $('#promotionSelector');
    
    // Vider le sélecteur sauf l'option "Toutes les promotions"
    selector.find('option:not(:first)').remove();
    
    // Ajouter les promotions disponibles
    promotions.forEach(promotion => {
        selector.append(`<option value="${promotion}">${promotion}</option>`);
    });
}

// Fonction pour charger les données d'évolution RSE
function loadRseEvolutionData() {
    // Afficher un indicateur de chargement
    $('#evolutionChart').css('opacity', '0.5');
    
    // Faire la requête AJAX vers l'API
    $.ajax({
        url: '/api/rse-evolution/',
        type: 'GET',
        success: function(response) {
            // Mettre à jour le graphique avec les nouvelles données
            updateEvolutionChart(response.evolution_data);
        },
        error: function(xhr) {
            console.error('Erreur lors du chargement des données d\'évolution:', xhr.responseText);
            showNotification('error', 'Erreur lors du chargement des données d\'évolution RSE');
        },
        complete: function() {
            // Restaurer l'opacité du graphique
            $('#evolutionChart').css('opacity', '1');
        }
    });
}

// Fonction pour mettre à jour le graphique d'évolution
function updateEvolutionChart(evolutionData) {
    const ctx = document.getElementById('evolutionChart');
    if (!ctx) {
        console.error("Canvas 'evolutionChart' non trouvé");
        return;
    }
    
    // Détruire le graphique existant s'il existe
    if (charts.evolution) {
        charts.evolution.destroy();
    }
    
    // Extraire les années et les données
    const annees = evolutionData.map(item => item.annee);
    const totalValues = evolutionData.map(item => item.total);
    const cmValues = evolutionData.map(item => item.cm);
    const tdValues = evolutionData.map(item => item.td);
    const tpValues = evolutionData.map(item => item.tp);
    
    // Créer le graphique
    charts.evolution = new Chart(ctx, {
        type: 'line',
        data: {
            labels: annees,
            datasets: [
                {
                    label: 'Total',
                    data: totalValues,
                    borderColor: '#7c50de',
                    backgroundColor: 'rgba(124, 80, 222, 0.1)',
                    tension: 0.3,
                    fill: true,
                    borderWidth: 2
                },
                {
                    label: 'CM',
                    data: cmValues,
                    borderColor: '#2f0d73',
                    borderDash: [5, 5],
                    tension: 0.3,
                    borderWidth: 2
                },
                {
                    label: 'TD',
                    data: tdValues,
                    borderColor: '#ac54c7',
                    borderDash: [5, 5],
                    tension: 0.3,
                    borderWidth: 2
                },
                {
                    label: 'TP',
                    data: tpValues,
                    borderColor: '#ffb43c',
                    borderDash: [5, 5],
                    tension: 0.3,
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Nombre d\'heures'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Année'
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.raw} heures`;
                        }
                    }
                }
            }
        }
    });
    
    console.log("Graphique d'évolution mis à jour avec succès");
}

// Fonction pour charger les données de types d'activités
function loadRseActivityTypesData() {
    // Afficher un indicateur de chargement
    $('#typeActiviteChart').css('opacity', '0.5');
    
    // Faire la requête AJAX vers l'API
    $.ajax({
        url: '/api/rse-activity-types/',
    type: 'GET',
    success: function(response) {
        // Mettre à jour le graphique avec les nouvelles données
        updateTypeActiviteChart(response.types_data);
    },
    error: function(xhr) {
        console.error('Erreur lors du chargement des données de types d\'activités:', xhr.responseText);
        showNotification('error', 'Erreur lors du chargement des données de types d\'activités');
    },
    complete: function() {
        // Restaurer l'opacité du graphique
        $('#typeActiviteChart').css('opacity', '1');
    }
});
}

// Fonction pour mettre à jour le graphique de types d'activités
function updateTypeActiviteChart(typesData) {
const ctx = document.getElementById('typeActiviteChart');
if (!ctx) {
    console.error("Canvas 'typeActiviteChart' non trouvé");
    return;
}

// Détruire le graphique existant s'il existe
if (charts.typeActivite) {
    charts.typeActivite.destroy();
}

// Extraire les labels et les données
const labels = typesData.map(item => item.type_activite);
const values = typesData.map(item => item.total_heures);

// Générer des couleurs
const colors = generateColors(labels.length);

// Déterminer si le graphique doit être horizontal ou vertical
const isHorizontal = labels.length > 4;

// Créer le graphique
charts.typeActivite = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: labels,
        datasets: [{
            label: 'Heures par type d\'activité',
            data: values,
            backgroundColor: colors,
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: isHorizontal ? 'y' : 'x',
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: !isHorizontal,
                    text: 'Nombre d\'heures'
                }
            },
            x: {
                title: {
                    display: isHorizontal,
                    text: 'Nombre d\'heures'
                },
                ticks: {
                    autoSkip: false,
                    maxRotation: 45,
                    minRotation: 45
                }
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

console.log("Graphique de types d'activités mis à jour avec succès");
}

// Fonction pour charger les données de format de cours
function loadRseFormatCoursData() {
// Afficher un indicateur de chargement
$('#formatCoursChart').css('opacity', '0.5');

// Faire la requête AJAX vers l'API
$.ajax({
    url: '/api/rse-format-cours/',
    type: 'GET',
    success: function(response) {
        // Mettre à jour le graphique avec les nouvelles données
        updateFormatCoursChart(response);
    },
    error: function(xhr) {
        console.error('Erreur lors du chargement des données de format de cours:', xhr.responseText);
        showNotification('error', 'Erreur lors du chargement des données de format de cours');
    },
    complete: function() {
        // Restaurer l'opacité du graphique
        $('#formatCoursChart').css('opacity', '1');
    }
});
}
// Fonction pour charger et remplir le sélecteur de promotions
function loadAndPopulatePromotions() {
    $.ajax({
        url: '/api/rse-hours-by-promotion/',
        type: 'GET',
        success: function(response) {
            if (response.promotions_data && response.promotions_data.length > 0) {
                // Récupérer les promotions
                const promotions = response.promotions_data.map(item => item.promotion);
                
                // Vider le sélecteur sauf l'option "Toutes les promotions"
                const selector = $('#filterPromotion');
                selector.find('option:not(:first)').remove();
                
                // Ajouter les promotions
                promotions.forEach(promotion => {
                    selector.append(`<option value="${promotion}">${promotion}</option>`);
                });
                
                console.log(`Sélecteur de promotions rempli avec ${promotions.length} promotions`);
            }
        },
        error: function(xhr) {
            console.error('Erreur lors du chargement des promotions:', xhr.responseText);
        }
    });
}
// Fonction pour mettre à jour le graphique de format de cours
function updateFormatCoursChart(data) {
const ctx = document.getElementById('formatCoursChart');
if (!ctx) {
    console.error("Canvas 'formatCoursChart' non trouvé");
    return;
}

// Détruire le graphique existant s'il existe
if (charts.formatCours) {
    charts.formatCours.destroy();
}

// Extraire les données
const totalCM = data.total_cm || 0;
const totalTD = data.total_td || 0;
const totalTP = data.total_tp || 0;

// Créer le graphique
charts.formatCours = new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: [
            `CM (${data.percent_cm}%)`, 
            `TD (${data.percent_td}%)`, 
            `TP (${data.percent_tp}%)`
        ],
        datasets: [{
            data: [totalCM, totalTD, totalTP],
            backgroundColor: ['#2f0d73', '#ac54c7', '#ffb43c'],
            borderWidth: 1,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '50%',
        plugins: {
            legend: {
                position: 'bottom'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const label = context.label || '';
                        const value = context.raw;
                        return `${value} heures`;
                    }
                }
            }
        }
    }
});

console.log("Graphique de format de cours mis à jour avec succès");
}

// Fonction pour mettre à jour les statistiques affichées
function updateStatsSummary(data) {
// Calculer le total des heures
const totalHeures = (data.heures_cm || 0) + (data.heures_td || 0) + (data.heures_tp || 0) + 
                   Object.keys(data)
                       .filter(key => key.startsWith('heure') && !['heures_cm', 'heures_td', 'heures_tp'].includes(key))
                       .reduce((sum, key) => sum + (parseInt(data[key]) || 0), 0);

// Mettre à jour l'affichage
$('#stat-heures').text(totalHeures);
$('#sidebar-total-heures').text(totalHeures);
}

// Fonction pour rafraîchir tous les graphiques
function refreshAllCharts() {
// Afficher un indicateur de chargement
const originalBtn = $('.btn-warning').html();
$('.btn-warning').html('<i class="fas fa-spinner fa-spin mr-2"></i>Actualisation...').prop('disabled', true);

// Ajouter un overlay de chargement global
const loadingOverlay = $('<div class="loading-overlay"></div>').css({
    position: 'fixed',
    top: 0,
    left: 0,
    width: '100%',
    height: '100%',
    background: 'rgba(255, 255, 255, 0.7)',
    zIndex: 9999,
    display: 'flex',
    justifyContent: 'center',
    alignItems: 'center'
});

const spinner = $('<div class="spinner-border text-primary" role="status"></div>');
const loadingText = $('<div class="ml-2">Actualisation des données...</div>').css({
    color: '#7c50de',
    fontWeight: 'bold'
});

const spinnerContainer = $('<div></div>').css({
    display: 'flex',
    alignItems: 'center',
    padding: '20px',
    background: 'white',
    borderRadius: '10px',
    boxShadow: '0 4px 15px rgba(0,0,0,0.1)'
}).append(spinner).append(loadingText);

loadingOverlay.append(spinnerContainer);
$('body').append(loadingOverlay);

// Créer un tableau de promesses pour toutes les requêtes AJAX
const promises = [
    // Promesse pour les données de répartition
    new Promise((resolve, reject) => {
        $.ajax({
            url: '/api/rse-data/',
            type: 'GET',
            data: {
                promotion: $('#promotionSelector').val()
            },
            success: resolve,
            error: reject
        });
    }),
    
    // Promesse pour les données d'évolution
    new Promise((resolve, reject) => {
        $.ajax({
            url: '/api/rse-evolution/',
            type: 'GET',
            success: resolve,
            error: reject
        });
    }),
    
    // Promesse pour les données de types d'activités
    new Promise((resolve, reject) => {
        $.ajax({
            url: '/api/rse-activity-types/',
            type: 'GET',
            success: resolve,
            error: reject
        });
    }),
    
    // Promesse pour les données de format de cours
    new Promise((resolve, reject) => {
        $.ajax({
            url: '/api/rse-format-cours/',
            type: 'GET',
            success: resolve,
            error: reject
        });
    })
];

// Exécuter toutes les promesses en parallèle
Promise.all(promises)
    .then(results => {
        // Mettre à jour tous les graphiques avec les données fraîches
        if (results[0]) updatePromotionChart(results[0].data, $('#promotionSelector').val());
        if (results[1]) updateEvolutionChart(results[1].evolution_data);
        if (results[2]) updateTypeActiviteChart(results[2].types_data);
        if (results[3]) updateFormatCoursChart(results[3]);
        
        // Mettre à jour les statistiques globales
        if (results[0]) {
            updateStatsSummary(results[0].data);
        }
        
        // Afficher un message de succès
        showNotification('success', 'Tous les graphiques ont été actualisés avec succès !');
    })
    .catch(error => {
        console.error('Erreur lors de l\'actualisation des graphiques:', error);
        showNotification('error', 'Une erreur est survenue lors de l\'actualisation des graphiques');
    })
    .finally(() => {
        // Restaurer le bouton original
        $('.btn-warning').html(originalBtn).prop('disabled', false);
        
        // Supprimer l'overlay de chargement
        loadingOverlay.fadeOut(300, function() {
            $(this).remove();
        });
    });
}
// Fonction pour charger les données d'heures par promotion
function loadRseHoursByPromotionData() {
    // Afficher un indicateur de chargement
    $('#promotionHoursChart').css('opacity', '0.5');
    
    // Faire la requête AJAX vers l'API
    $.ajax({
        url: '/api/rse-hours-by-promotion/',
        type: 'GET',
        success: function(response) {
            // Mettre à jour le graphique avec les nouvelles données
            updatePromotionHoursChart(response.promotions_data);
        },
        error: function(xhr) {
            console.error('Erreur lors du chargement des données d\'heures par promotion:', xhr.responseText);
            showNotification('error', 'Erreur lors du chargement des données d\'heures par promotion');
        },
        complete: function() {
            // Restaurer l'opacité du graphique
            $('#promotionHoursChart').css('opacity', '1');
        }
    });
}

// Fonction pour mettre à jour le graphique d'heures par promotion
function updatePromotionHoursChart(promotionsData) {
    const ctx = document.getElementById('promotionHoursChart');
    if (!ctx) {
        console.error("Canvas 'promotionHoursChart' non trouvé");
        return;
    }
    
    // Détruire le graphique existant s'il existe
    if (charts.promotionHours) {
        charts.promotionHours.destroy();
    }
    
    // Extraire les labels et les données
    const promotions = promotionsData.map(item => item.promotion);
    const hours = promotionsData.map(item => item.total_heures);
    
    // Générer des couleurs graduées
    const gradientColors = promotions.map((_, index) => {
        // Créer un dégradé de couleurs du violet au corail
        const ratio = index / (promotions.length - 1);
        const r = Math.round(124 + ratio * (255 - 124));
        const g = Math.round(80 + ratio * (107 - 80));
        const b = Math.round(222 + ratio * (107 - 222));
        return `rgb(${r}, ${g}, ${b})`;
    });
    
    // Créer le graphique
    charts.promotionHours = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: promotions,
            datasets: [{
                label: 'Heures totales',
                data: hours,
                backgroundColor: gradientColors,
                borderColor: 'rgba(0, 0, 0, 0.1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Nombre d\'heures'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Promotion'
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.raw} heures`;
                        }
                    }
                },
                legend: {
                    display: false
                }
            }
        }
    });
    
    console.log("Graphique d'heures par promotion mis à jour avec succès");
}
// Filtrer le tableau selon les critères sélectionnés
function filterTable() {
const annee = $('#filterAnnee').val();
const promotion = $('#filterPromotion').val();
const semestre = $('#filterSemestre').val();
const typeActivite = $('#filterTypeActivite').val();

const table = $('#rseTable').DataTable();

// Réinitialiser d'abord
table.search('').columns().search('').draw();

// Appliquer les filtres
if (annee) {
    table.column(0).search(annee).draw();
}
if (promotion) {
    table.column(1).search(promotion).draw();
}
if (semestre) {
    table.column(2).search(semestre).draw();
}
if (typeActivite) {
    table.column(3).search(typeActivite).draw();
}
}

// Fonction pour afficher/masquer le champ "autre type"
function toggleAutreType() {
const typeSelect = document.getElementById('type_activite');
const autreContainer = document.getElementById('autre_type_container');

if (!typeSelect || !autreContainer) return;

if (typeSelect.value === 'Autre') {
    autreContainer.style.display = 'block';
    document.getElementById('autre_type').setAttribute('required', 'required');
} else {
    autreContainer.style.display = 'none';
    document.getElementById('autre_type').removeAttribute('required');
}
}

// Fonction pour générer des couleurs pour les graphiques
function generateColors(count) {
const baseColors = [
    '#2f0d73', '#7c50de', '#ac54c7', '#f56960', '#ffb43c', '#3cbebe',
    '#8b5fbf', '#ff6b6b', '#4dabf7', '#20c997', '#ff922b', '#5f3dc4'
];

if (count <= baseColors.length) {
    return baseColors.slice(0, count);
}

const colors = [...baseColors];

// Générer des couleurs supplémentaires si nécessaire
for (let i = baseColors.length; i < count; i++) {
    const r = Math.floor(Math.random() * 200) + 55; // Éviter les couleurs trop sombres
    const g = Math.floor(Math.random() * 200) + 55;
    const b = Math.floor(Math.random() * 200) + 55;
    colors.push(`rgb(${r}, ${g}, ${b})`);
}

return colors;
}

// Fonction pour valider le formulaire
function validateForm() {
// Vérifier les champs obligatoires
const requiredFields = [
    { id: 'annee', name: 'Année' },
    { id: 'promotion', name: 'Promotion' },
    { id: 'semestre', name: 'Semestre' },
    { id: 'type_activite', name: 'Type d\'activité' }
];

let isValid = true;

// Vérifier chaque champ obligatoire
requiredFields.forEach(field => {
    const input = $(`#${field.id}`);
    if (!input.val()) {
        showNotification('error', `Le champ "${field.name}" est obligatoire.`);
        input.addClass('is-invalid');
        isValid = false;
    } else {
        input.removeClass('is-invalid');
    }
});

// Vérifier le cas spécial de "Autre type"
if ($('#type_activite').val() === 'Autre' && !$('#autre_type').val()) {
    showNotification('error', 'Veuillez préciser le type d\'activité.');
    $('#autre_type').addClass('is-invalid');
    isValid = false;
} else {
    $('#autre_type').removeClass('is-invalid');
}

// Vérifier qu'au moins un type d'heures est spécifié
const heuresCM = parseInt($('#heures_cm').val()) || 0;
const heuresTD = parseInt($('#heures_td').val()) || 0;
const heuresTP = parseInt($('#heures_tp').val()) || 0;

if (heuresCM === 0 && heuresTD === 0 && heuresTP === 0) {
    showNotification('error', 'Veuillez spécifier au moins un type d\'heures (CM, TD ou TP).');
    $('#heures_cm, #heures_td, #heures_tp').addClass('is-invalid');
    isValid = false;
} else {
    $('#heures_cm, #heures_td, #heures_tp').removeClass('is-invalid');
}

return isValid;
}

// Fonction pour afficher une notification
function showNotification(type, message) {
const alertClass = type === 'success' ? 'alert-success' : 
                  type === 'warning' ? 'alert-warning' : 'alert-danger';
const iconClass = type === 'success' ? 'fa-check-circle' : 
                 type === 'warning' ? 'fa-exclamation-circle' : 'fa-exclamation-triangle';

const notification = `
    <div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;">
        <i class="fas ${iconClass} mr-2"></i>
        ${message}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
`;

$('body').append(notification);

// Auto-remove after 3 seconds
setTimeout(() => {
    $('.alert').fadeOut('slow', function() {
        $(this).remove();
    });
}, 3000);
}
</script>
{% endblock %}