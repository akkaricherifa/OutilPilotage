{% extends 'statistiques/base.html' %}

{% block title %}Heures d'Enseignement - AppISIS{% endblock %}

{% block extra_css %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap4.min.css">

<style>
    :root {
        /* Couleurs ISIS basées sur la charte graphique */
        --isis-purple-dark: #2f0d73;    /* Violet foncé principal */
        --isis-purple: #7c50de;         /* Violet principal */
        --isis-purple-light: #ac54c7;   /* Violet clair */
        --isis-coral: #f56960;          /* Corail/rouge */
        --isis-coral-light: #ffb43c;    /* Orange/jaune */
        --isis-teal: #3cbebe;           /* Turquoise */
    }
    
    .stat-card {
        transition: transform 0.2s;
        border-left: 4px solid;
        margin-bottom: 20px;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .stat-card-cm { border-left-color: var(--isis-purple-dark); }
    .stat-card-td { border-left-color: var(--isis-purple); }
    .stat-card-tp { border-left-color: var(--isis-purple-light); }
    .stat-card-ue { border-left-color: var(--isis-coral); }
    .stat-card-matieres { border-left-color: var(--isis-coral-light); }
    .stat-card-intervenants { border-left-color: var(--isis-teal); }
    
    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        border: 1px solid #e9ecef;
        height: 400px;
    }
    
    .chart-container h5 {
        color: var(--isis-purple-dark);
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    
    .dashboard-header {
        background: linear-gradient(135deg, var(--isis-purple-dark) 0%, var(--isis-purple) 100%);
        position: relative;
        overflow: hidden;
        color: white;
        padding: 35px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 8px 24px rgba(47, 13, 115, 0.2);
        transition: all 0.3s ease;
    }
    
    <!-- CSS à ajouter dans la section <style> de votre fichier heures_enseignement.html -->
    /* Style amélioré pour l'en-tête du dashboard */
    .dashboard-header {
        background: linear-gradient(135deg, var(--isis-purple-dark) 0%, var(--isis-purple) 100%);
        position: relative;
        overflow: hidden;
        color: white;
        padding: 35px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 8px 24px rgba(47, 13, 115, 0.2);
        transition: all 0.3s ease;
    }
    
    /* Animation d'arrière-plan */
    .dashboard-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        bottom: -50%;
        left: -50%;
        background: linear-gradient(
            45deg,
            rgba(124, 80, 222, 0.1) 0%,
            rgba(172, 84, 199, 0.1) 25%,
            rgba(245, 105, 96, 0.1) 50%,
            rgba(255, 180, 60, 0.1) 75%,
            rgba(60, 190, 190, 0.1) 100%
        );
        transform: rotate(15deg);
        z-index: 0;
        animation: gradientMove 15s ease infinite;
    }
    
    @keyframes gradientMove {
        0% {
            transform: rotate(15deg) translateY(-10%);
        }
        50% {
            transform: rotate(10deg) translateY(10%);
        }
        100% {
            transform: rotate(15deg) translateY(-10%);
        }
    }
    
    /* Contenu de l'en-tête */
    .dashboard-header .header-content {
        position: relative;
        z-index: 1;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .dashboard-header h1 {
        margin: 0;
        font-weight: 700;
        font-size: 2.5rem;
        letter-spacing: -0.5px;
        text-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    
    .dashboard-header p {
        margin-top: 8px;
        margin-bottom: 0;
        font-size: 1.1rem;
        opacity: 0.9;
        max-width: 600px;
    }
    
    /* Icône d'horloge améliorée */
    .dashboard-header .clock-icon {
        font-size: 2.5rem;
        margin-right: 20px;
        background: rgba(255, 255, 255, 0.15);
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    /* Titre et sous-titre */
    .dashboard-header .title-container {
        display: flex;
        align-items: center;
    }
    
    .dashboard-header .text-container {
        display: flex;
        flex-direction: column;
    }
    
    /* Boutons d'action améliorés */
    .action-buttons {
        display: flex;
        gap: 15px;
    }
    
    .btn-dashboard {
        padding: 12px 22px;
        font-weight: 600;
        border-radius: 12px;
        display: flex;
        align-items: center;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
        border: none;
    }
    
    .btn-dashboard:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }
    
    .btn-dashboard i {
        margin-right: 10px;
        font-size: 1.1rem;
    }
    
    .btn-add {
        background-color: white;
        color: var(--isis-purple-dark);
    }
    
    .btn-add:hover {
        background-color: #f8f9fa;
    }
    
    .btn-import {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }
    
    .btn-import:hover {
        background: linear-gradient(135deg, #2fd155 0%, #26dba6 100%);
    }
    
    /* Animation pour les boutons */
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(255, 255, 255, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(255, 255, 255, 0);
        }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .dashboard-header {
            padding: 25px;
        }
        
        .dashboard-header .header-content {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .action-buttons {
            margin-top: 20px;
            width: 100%;
            justify-content: center;
        }
        
        .dashboard-header h1 {
            font-size: 1.8rem;
        }
        
        .dashboard-header p {
            font-size: 1rem;
        }
        
        .dashboard-header .clock-icon {
            width: 50px;
            height: 50px;
            font-size: 1.8rem;
        }
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 30px;
    }
    
    .modal-header-custom {
        background: linear-gradient(135deg, var(--isis-purple-dark) 0%, var(--isis-purple) 100%);
        color: white;
    }
    
    .form-control:focus {
        border-color: var(--isis-purple);
        box-shadow: 0 0 0 0.2rem rgba(124, 80, 222, 0.25);
    }
    
    .btn-primary-custom {
        background: linear-gradient(135deg, var(--isis-purple-dark) 0%, var(--isis-purple) 100%);
        border: none;
        color: white;
    }
    
    .btn-primary-custom:hover {
        background: linear-gradient(135deg, var(--isis-purple) 0%, var(--isis-purple-light) 100%);
    }

    canvas {
        max-height: 300px;
    }
    
    .filter-container {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        border: 1px solid #e9ecef;
    }
    
    .filter-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: var(--isis-purple-dark);
    }
    
    .filter-form .form-group {
        margin-bottom: 0;
    }
    
    .filter-form .form-control {
        border-radius: 10px;
    }
    
    .filter-form .btn {
        border-radius: 10px;
    }

    .heures-table th {
        background: linear-gradient(135deg, var(--isis-purple-dark) 0%, var(--isis-purple) 100%);
        color: white;
    }
    
    @media (max-width: 768px) {
        .chart-grid {
            grid-template-columns: 1fr;
        }
        
        .filter-container {
            padding: 15px;
        }
        
        .filter-form .form-group {
            margin-bottom: 10px;
        }
        .dataTables_wrapper {
        font-size: 14px; /* Réduire la taille de la police */
        }
    
    /* Ajuster la hauteur des lignes */
    .heures-table tr {
        line-height: 1.2; /* Réduit l'espacement vertical */
    }
    }
    #heuresTable {
    font-size: 0.85rem; /* Taille réduite pour tout le tableau */
    }
    #heuresTable thead th {
    font-size: 0.9rem;
    font-weight: 600;
    white-space: nowrap; /* Évite le retour à la ligne dans les en-têtes */
     }

     /* Pour améliorer la structure et l'apparence */
      #heuresTable td {
    padding: 0.5rem 0.75rem; /* Padding réduit */
    vertical-align: middle;
     }
</style>
{% endblock %}

{% block content %}
<!-- En-tête du dashboard -->
<div class="dashboard-header">
    <div class="header-content">
        <div class="title-container">
            <div class="clock-icon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="text-container">
                <h1>Heures d'Enseignement</h1>
                <p>Analyse détaillée des heures d'enseignement par catégorie</p>
            </div>
        </div>
        <div class="action-buttons">
            <button class="btn btn-dashboard btn-add" data-toggle="modal" data-target="#addDataModal">
                <i class="fas fa-plus"></i>Ajouter des données
            </button>
            <button class="btn btn-dashboard btn-import" data-toggle="modal" data-target="#uploadCSVModal">
                <i class="fas fa-file-upload"></i>Importer CSV/Excel
            </button>
        </div>
    </div>
</div>

<!-- Filtres -->
<div class="filter-container">
    <div class="filter-title">
        <i class="fas fa-filter mr-2"></i>Filtres
    </div>
    <form class="filter-form row" id="filterForm">
        <div class="form-group col-md-3">
            <label for="anneesFilter">Année académique</label>
            <select class="form-control" id="anneesFilter">
                <option value="">Toutes les années</option>
                <option value="2024-2025">2024-2025</option>
                <option value="2023-2024">2023-2024</option>
                <option value="2022-2023">2022-2023</option>
                <option value="2021-2022">2021-2022</option>
                <option value="2020-2021">2020-2021</option>
            </select>
        </div>
        <div class="form-group col-md-3">
            <label for="niveauFilter">Niveau</label>
            <select class="form-control" id="niveauFilter">
                <option value="">Tous les niveaux</option>
                <option value="FIE1">FIE1</option>
                <option value="FIE2">FIE2</option>
                <option value="FIE3">FIE3</option>
                <option value="FIE4">FIE4</option>
                <option value="FIE5">FIE5</option>
                <option value="FIA3">FIA3</option>
                <option value="FIA5">FIA5</option>
            </select>
        </div>
        <div class="form-group col-md-3">
            <label for="semestreFilter">Semestre</label>
            <select class="form-control" id="semestreFilter">
                <option value="">Tous les semestres</option>
                <option value="S1">S1</option>
                <option value="S2">S2</option>
                <option value="S3">S3</option>
                <option value="S4">S4</option>
                <option value="S5">S5</option>
                <option value="S6">S6</option>
                <option value="S7">S7</option>
                <option value="S8">S8</option>
                <option value="S9">S9</option>
                <option value="S10">S10</option>
            </select>
        </div>
        <div class="form-group col-md-3 d-flex align-items-end">
            <button type="button" class="btn btn-primary-custom w-100" id="applyFilters">
                <i class="fas fa-search mr-2"></i>Appliquer les filtres
            </button>
        </div>
    </form>
</div>

<!-- Statistiques résumées -->
<div class="stats-grid">
    <div class="card stat-card stat-card-cm">
        <div class="card-body text-center">
            <h3 style="color: var(--isis-purple-dark);" id="statCM">0</h3>
            <p class="mb-0">Heures CM</p>
        </div>
    </div>
    <div class="card stat-card stat-card-td">
        <div class="card-body text-center">
            <h3 style="color: var(--isis-purple);" id="statTD">0</h3>
            <p class="mb-0">Heures TD</p>
        </div>
    </div>
    <div class="card stat-card stat-card-tp">
        <div class="card-body text-center">
            <h3 style="color: var(--isis-purple-light);" id="statTP">0</h3>
            <p class="mb-0">Heures TP</p>
        </div>
    </div>
    <div class="card stat-card stat-card-ue">
        <div class="card-body text-center">
            <h3 style="color: var(--isis-coral);" id="statUE">0</h3>
            <p class="mb-0">Unités d'Enseignement</p>
        </div>
    </div>
    <div class="card stat-card stat-card-intervenants">
        <div class="card-body text-center">
            <h3 style="color: var(--isis-teal);" id="statIntervenants">0</h3>
            <p class="mb-0">Intervenants</p>
        </div>
    </div>
</div>

<!-- Graphiques -->
<div class="chart-grid">
    <!-- Graphique 1: Répartition des heures par type (Camembert) -->
    <div class="chart-container">
        <h5><i class="fas fa-chart-pie mr-2"></i>Répartition des Heures par Type</h5>
        <canvas id="typesHeuresChart"></canvas>
    </div>

    <!-- Graphique 2: Évolution des heures par année académique (Courbe) -->
    <div class="chart-container">
        <h5><i class="fas fa-chart-line mr-2"></i>Évolution des Heures par Année</h5>
        <canvas id="evolutionHeuresChart"></canvas>
    </div>

    <!-- Graphique 3: Répartition des heures par niveau (Histogramme) -->
    <div class="chart-container">
        <h5><i class="fas fa-chart-bar mr-2"></i>Répartition des Heures par Niveau</h5>
        <canvas id="heuresNiveauChart"></canvas>
    </div>

    <!-- Graphique 4: Types d'heures par semestre (Barres groupées) -->
    <div class="chart-container">
        <h5><i class="fas fa-bars mr-2"></i>Types d'Heures par Semestre</h5>
        <canvas id="heuresSemestreChart"></canvas>
    </div>
</div>

<!-- Tableau des données -->
<div class="chart-container" style="height: auto;">
    <h5><i class="fas fa-table mr-2"></i>Données Détaillées des Heures d'Enseignement</h5>
    <div class="table-responsive">
     <!-- Filtre par niveau -->
        <table class="table table-striped table-hover heures-table" id="heuresTable">
            <thead>
                <tr>
                    <th>Année</th>
                    <th>Niveau</th>
                    <th>Semestre</th>
                    <th>UE</th>
                    <th>Intervenant</th>
                    <th>CM</th>
                    <th>TD</th>
                    <th>TP</th>
                    <th>Total</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="heuresTableBody">
                <!-- Les données seront chargées dynamiquement via JavaScript -->
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Ajouter des données -->
<div class="modal fade" id="addDataModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title" id="addDataModalTitle">Ajouter des heures d'enseignement</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="heuresForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Année de début <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" name="annee_debut" id="annee_debut" required min="2000" max="2030" value="2024">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Année de fin <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" name="annee_fin" id="annee_fin" required min="2000" max="2030" value="2025">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Niveau <span class="text-danger">*</span></label>
                                <select class="form-control" name="niveau" id="niveau" required>
                                    <option value="">Sélectionnez un niveau</option>
                                    <option value="FIE1">FIE1</option>
                                    <option value="FIE2">FIE2</option>
                                    <option value="FIE3">FIE3</option>
                                    <option value="FIE4">FIE4</option>
                                    <option value="FIE5">FIE5</option>
                                    <option value="FIA3">FIA3</option>
                                    <option value="FIA5">FIA5</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Semestre <span class="text-danger">*</span></label>
                                <select class="form-control" name="semestre" id="semestre" required>
                                    <option value="">Sélectionnez un semestre</option>
                                    <option value="S1">S1</option>
                                    <option value="S2">S2</option>
                                    <option value="S3">S3</option>
                                    <option value="S4">S4</option>
                                    <option value="S5">S5</option>
                                    <option value="S6">S6</option>
                                    <option value="S7">S7</option>
                                    <option value="S8">S8</option>
                                    <option value="S9">S9</option>
                                    <option value="S10">S10</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="form-group">
                                <label>Unité d'Enseignement (UE) <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">Code</span>
                                    </div>
                                    <input type="text" class="form-control" name="ue_code" id="ue_code" placeholder="Ex: E1-INFO" required>
                                    <div class="input-group-prepend ml-2">
                                        <span class="input-group-text">Nom</span>
                                    </div>
                                    <input type="text" class="form-control" name="ue_nom" id="ue_nom" placeholder="Ex: Informatique Fondamentale" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>
                    <h6 class="text-primary"><i class="fas fa-book mr-2"></i>Informations Matière</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Nom de la matière <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="matiere_nom" id="matiere_nom" placeholder="Ex: Programmation Objet" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>ECTS</label>
                                <input type="number" class="form-control" name="ects" id="ects" min="0" max="30" step="0.5" value="3">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>Intervenant</label>
                                <input type="text" class="form-control" name="intervenant" id="intervenant" placeholder="Nom de l'intervenant">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Heures CM</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" title="Heures Maquette">HM</span>
                                    </div>
                                    <input type="number" class="form-control" name="cm_hm" id="cm_hm" min="0" step="0.5" value="0">
                                </div>
                                <div class="input-group mt-2">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" title="Heures Programmées">HP</span>
                                    </div>
                                    <input type="number" class="form-control" name="cm_hp" id="cm_hp" min="0" step="0.5" value="0">
                                </div>
                                <div class="input-group mt-2">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" title="Heures Réalisées">HR</span>
                                    </div>
                                    <input type="number" class="form-control" name="cm_hr" id="cm_hr" min="0" step="0.5" value="0">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Heures TD</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" title="Heures Maquette">HM</span>
                                    </div>
                                    <input type="number" class="form-control" name="td_hm" id="td_hm" min="0" step="0.5" value="0">
                                </div>
                                <div class="input-group mt-2">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" title="Heures Programmées">HP</span>
                                    </div>
                                    <input type="number" class="form-control" name="td_hp" id="td_hp" min="0" step="0.5" value="0">
                                </div>
                                <div class="input-group mt-2">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" title="Heures Réalisées">HR</span>
                                    </div>
                                    <input type="number" class="form-control" name="td_hr" id="td_hr" min="0" step="0.5" value="0">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Heures TP</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" title="Heures Maquette">HM</span>
                                    </div>
                                    <input type="number" class="form-control" name="tp_hm" id="tp_hm" min="0" step="0.5" value="0">
                                </div>
                                <div class="input-group mt-2">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" title="Heures Programmées">HP</span>
                                    </div>
                                    <input type="number" class="form-control" name="tp_hp" id="tp_hp" min="0" step="0.5" value="0">
                                </div>
                                <div class="input-group mt-2">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" title="Heures Réalisées">HR</span>
                                    </div>
                                    <input type="number" class="form-control" name="tp_hr" id="tp_hr" min="0" step="0.5" value="0">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary-custom">
                        <i class="fas fa-save mr-1"></i>Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Upload CSV/Excel -->
<div class="modal fade" id="uploadCSVModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title">Importer un fichier CSV/Excel</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="uploadForm" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group">
                        <label>Fichier CSV/Excel <span class="text-danger">*</span></label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="csvFile" name="file" accept=".csv,.xlsx,.xls" required>
                            <label class="custom-file-label" for="csvFile">Choisir un fichier...</label>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle mr-2"></i>Format attendu pour le CSV :</h6>
                        <p>Le fichier doit contenir les colonnes suivantes :</p>
                        <code>code_ue,nom_matiere,ects,intervenant,niveau,semestre,cm_hm,cm_hp,cm_hr,td_hm,td_hp,td_hr,tp_hm,tp_hp,tp_hr</code>
                        <p><small>Note: Le niveau et le semestre doivent être spécifiés dans le fichier CSV.</small></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload mr-1"></i>Importer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de confirmation de suppression -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirmer la suppression</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir supprimer ces données ?</p>
                <div id="deleteDetails"></div>
                <small class="text-muted">Cette action est irréversible.</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">
                    <i class="fas fa-trash mr-1"></i>Supprimer
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- DataTables JS -->
<script type="text/javascript" src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap4.min.js"></script>
<script>
// Variables globales
// Variables globales
let typesHeuresChart, evolutionHeuresChart, heuresNiveauChart, heuresSemestreChart;
let charts = {};
let heuresDataTable;
let deleteData = {
    annee_academique: null,
    niveau: null,
    semestre: null,
    code_ue: null
};
const chartColors = {
    // Bleu principal (violet foncé dans la charte)
    cm: 'rgba(47, 13, 115, 0.8)',      // RVB: 47-13-115, Hex: #2f0d73
    
    // Dégradé principal (violet dans la charte)
    td: 'rgba(124, 80, 222, 0.8)',      // RVB: 124-80-222, Hex: #7c50de
    
    // Dégradé principal (violet clair dans la charte)
    tp: 'rgba(172, 84, 199, 0.8)',      // RVB: 172-84-199, Hex: #ac54c7
    
    // Couleurs de bordure plus foncées pour améliorer le contraste
    border: {
        cm: 'rgba(47, 13, 115, 1)',     // RVB: 47-13-115
        td: 'rgba(124, 80, 222, 1)',    // RVB: 124-80-222
        tp: 'rgba(172, 84, 199, 1)'     // RVB: 172-84-199
    }
};
// Définir l'URL de base de l'API
const API_BASE_URL = '{{ settings.API_URL }}';

// Récupère le token API depuis la session Django
function getApiToken() {
    return '{{ request.session.api_token }}';
}

$(document).ready(function() {
    // Initialiser DataTable
    heuresDataTable = $('#heuresTable').DataTable({
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/French.json"
        },
        
        "order": [[0, "desc"], [1, "asc"], [2, "asc"]],
        "pageLength": 5,
        "responsive": true,
        "columns": [
            { "data": "annee", "width": "80px" },
            { "data": "niveau", "width": "60px" },
            { "data": "semestre", "width": "60px" },
            { "data": "ue", "width": "180px" },
            { "data": "intervenant", "width": "150px" },
            { "data": "cm", "width": "50px" },
            { "data": "td", "width": "50px" },
            { "data": "tp", "width": "50px" },
            { "data": "total", "width": "60px" },
            { "data": "actions", "width": "60px", "orderable": false }
        ],
    });

    // Initialiser les graphiques
    initCharts();

    // Charger les données initiales
    loadHeuresEnseignementStats();
    loadHeuresEnseignement();
    
    // Événement de changement de fichier pour afficher le nom
    $('.custom-file-input').on('change', function() {
        let fileName = $(this).val().split('\\').pop();
        $(this).siblings('.custom-file-label').addClass("selected").html(fileName);
    });
    
    // Gestion du bouton d'application des filtres
    $('#applyFilters').on('click', function() {
        loadHeuresEnseignementStats();
        loadHeuresEnseignement();
        loadChartData(); // Ajout: charger les données des graphiques
    });
    
    // Soumission du formulaire d'ajout de données
    $('#heuresForm').on('submit', function(e) {
        e.preventDefault();
        saveHeuresData();
    });
    
    // Soumission du formulaire d'importation CSV/Excel
    $('#uploadForm').on('submit', function(e) {
        e.preventDefault();
        uploadHeuresFile();
    });
    
    // Gestion du bouton de confirmation de suppression
    $('#confirmDelete').on('click', function() {
        deleteHeuresData();
    });

    $('#levelFilter').on('change', function() {
        const selectedNiveau = $(this).val();
        
        if (selectedNiveau === 'all') {
            heuresDataTable.column(1).search('').draw();
        } else {
            heuresDataTable.column(1).search(selectedNiveau, true, false).draw();
        }
    });

    // Ajouter les événements aux sélecteurs pour le chargement automatique des graphiques
    $('#anneesFilter').on('change', function() {
        loadChartData();
    });
    $('#niveauFilter').on('change', function() {
        loadChartData();
    });
    $('#semestreFilter').on('change', function() {
        loadChartData();
    });
});

// Charger les statistiques des heures d'enseignement
function loadHeuresEnseignementStats() {
    // Construction des paramètres de filtrage
    const anneeFilter = $('#anneesFilter').val();
    const niveauFilter = $('#niveauFilter').val();
    const semestreFilter = $('#semestreFilter').val();
    
    let urlParams = new URLSearchParams();
    
    if (anneeFilter) {
        const [anneeDebut, anneeFin] = anneeFilter.split('-');
        urlParams.append('annee_debut', anneeDebut);
        urlParams.append('annee_fin', anneeFin);
    }
    
    if (niveauFilter) {
        urlParams.append('niveau', niveauFilter);
    }
    
    // Appel à l'API
    $.ajax({
        url: `${API_BASE_URL}/heures-enseignement/stats?${urlParams.toString()}`,
        type: 'GET',
        headers: {
            'Authorization': `Bearer ${getApiToken()}`
        },
        success: function(response) {
            // Mettre à jour les statistiques
            updateStats(response);
            const tableData = transformDataForTable(response);
            heuresDataTable.clear();
            heuresDataTable.rows.add(tableData);
            heuresDataTable.draw();
            populateNiveauFilter();
            // Charger les graphiques
            prepareAndUpdateCharts(response);
        },
        error: function(xhr) {
            showNotification('error', 'Erreur lors du chargement des statistiques');
            console.error('Erreur API:', xhr.responseText);
        }
    });
}

// Préparer les données pour les graphiques et mettre à jour les graphiques
function prepareAndUpdateCharts(data) {
    // Préparer les données pour les graphiques à partir des statistiques
    if (!data) return;

    // Préparer les données pour le graphique en camembert (répartition des heures par type)
    const pieChartData = {
        labels: ['CM', 'TD', 'TP'],
        data: [
            data.heures_totales.cm.hm || 0,
            data.heures_totales.td.hm || 0,
            data.heures_totales.tp.hm || 0
        ]
    };

    // Préparer les données pour les graphiques d'évolution par année
    // Comme nous n'avons pas ces données dans la réponse, nous devons les calculer à partir des données brutes
    // Nous allons utiliser les données pour les autres graphiques aussi
    prepareChartDataFromAPI(data);
}

// Fonction pour charger les données des graphiques
function loadChartData() {
    // Récupérer les valeurs des filtres
    const anneeFilter = $('#anneesFilter').val();
    const niveau = $('#niveauFilter').val();
    const semestre = $('#semestreFilter').val();
    
    let anneeDebut = '';
    let anneeFin = '';
    
    if (anneeFilter) {
        [anneeDebut, anneeFin] = anneeFilter.split('-');
    }
    
    // Construire l'URL avec les paramètres
    let url = '/api/heures-enseignement/graph-data/?';
    const params = [];
    
    if (anneeDebut && anneeFin) {
        params.push(`annee_debut=${anneeDebut}`);
        params.push(`annee_fin=${anneeFin}`);
    }
    
    if (niveau) {
        params.push(`niveau=${niveau}`);
    }
    
    if (semestre) {
        params.push(`semestre=${semestre}`);
    }
    
    url += params.join('&');
    
    // Afficher un indicateur de chargement
    showLoader();
    
    // Appeler l'API
    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error('Erreur lors de la récupération des données');
            }
            return response.json();
        })
        .then(data => {
            // Mettre à jour les graphiques avec les données reçues
            updateCharts(data);
            // Cacher l'indicateur de chargement
            hideLoader();
        })
        .catch(error => {
            console.error('Erreur:', error);
            showNotification('error', 'Erreur lors du chargement des données des graphiques');
            hideLoader();
            
            // En cas d'erreur, préparer les graphiques à partir des statistiques déjà chargées
            // Cela permet d'avoir une visualisation même si l'API graph-data n'est pas disponible
            $.ajax({
                url: `${API_BASE_URL}/heures-enseignement?${new URLSearchParams(params).toString()}`,
                type: 'GET',
                headers: {
                    'Authorization': `Bearer ${getApiToken()}`
                },
                success: function(response) {
                    prepareChartDataFromAPI(response);
                },
                error: function(xhr) {
                    console.error('Erreur lors de la récupération des données alternatives:', xhr.responseText);
                }
            });
        });
}

// Préparer les données des graphiques à partir des données API brutes
function prepareChartDataFromAPI(data) {
    if (!Array.isArray(data)) return;
    
    // Préparer les données pour le graphique camembert
    let totalCM = 0;
    let totalTD = 0;
    let totalTP = 0;
    
    // Pour le graphique d'évolution par année
    const annees = {};
    
    // Pour le graphique par niveau
    const niveaux = {};
    
    // Pour le graphique par semestre
    const semestres = {};
    
    // Parcourir les données
    data.forEach(record => {
        const anneeAcademique = record.annee_academique;
        const niveau = record.niveau;
        const semestre = record.semestre;
        
        // Initialiser les structures si nécessaire
        if (!annees[anneeAcademique]) {
            annees[anneeAcademique] = { cm: 0, td: 0, tp: 0 };
        }
        
        if (!niveaux[niveau]) {
            niveaux[niveau] = { cm: 0, td: 0, tp: 0 };
        }
        
        if (!semestres[semestre]) {
            semestres[semestre] = { cm: 0, td: 0, tp: 0 };
        }
        
        // Parcourir les matières pour accumuler les heures
        const ue = record.unite_enseignement;
        ue.matieres.forEach(matiere => {
            const cmHeures = matiere.heures_cm.hm || 0;
            const tdHeures = matiere.heures_td.hm || 0;
            const tpHeures = matiere.heures_tp.hm || 0;
            
            // Ajouter aux totaux globaux
            totalCM += cmHeures;
            totalTD += tdHeures;
            totalTP += tpHeures;
            
            // Ajouter aux données par année
            annees[anneeAcademique].cm += cmHeures;
            annees[anneeAcademique].td += tdHeures;
            annees[anneeAcademique].tp += tpHeures;
            
            // Ajouter aux données par niveau
            niveaux[niveau].cm += cmHeures;
            niveaux[niveau].td += tdHeures;
            niveaux[niveau].tp += tpHeures;
            
            // Ajouter aux données par semestre
            semestres[semestre].cm += cmHeures;
            semestres[semestre].td += tdHeures;
            semestres[semestre].tp += tpHeures;
        });
    });
    
    // Formater les données pour le graphique camembert
    const pieChartData = {
        labels: ['CM', 'TD', 'TP'],
        data: [totalCM, totalTD, totalTP]
    };
    
    // Formater les données pour le graphique d'évolution par année
    const anneesKeys = Object.keys(annees).sort();
    const lineChartData = {
        labels: anneesKeys,
        datasets: [
            {
                label: 'CM',
                data: anneesKeys.map(annee => annees[annee].cm)
            },
            {
                label: 'TD',
                data: anneesKeys.map(annee => annees[annee].td)
            },
            {
                label: 'TP',
                data: anneesKeys.map(annee => annees[annee].tp)
            }
        ]
    };
    
    // Formater les données pour le graphique par niveau
    const niveauxKeys = Object.keys(niveaux).sort();
    const barChartNiveauData = {
        labels: niveauxKeys,
        datasets: [
            {
                label: 'CM',
                data: niveauxKeys.map(niveau => niveaux[niveau].cm)
            },
            {
                label: 'TD',
                data: niveauxKeys.map(niveau => niveaux[niveau].td)
            },
            {
                label: 'TP',
                data: niveauxKeys.map(niveau => niveaux[niveau].tp)
            }
        ]
    };
    
    // Formater les données pour le graphique par semestre
    const semestresKeys = Object.keys(semestres).sort();
    const barChartSemestreData = {
        labels: semestresKeys,
        datasets: [
            {
                label: 'CM',
                data: semestresKeys.map(semestre => semestres[semestre].cm)
            },
            {
                label: 'TD',
                data: semestresKeys.map(semestre => semestres[semestre].td)
            },
            {
                label: 'TP',
                data: semestresKeys.map(semestre => semestres[semestre].tp)
            }
        ]
    };
    
    // Mise à jour des graphiques avec les données préparées
    updateCharts({
        pie_chart: pieChartData,
        line_chart: lineChartData,
        bar_chart_niveau: barChartNiveauData,
        bar_chart_semestre: barChartSemestreData
    });
}

// Mettre à jour les statistiques affichées
function updateStats(stats) {
    // Mettre à jour les cartes de statistiques
    $('#statCM').text(stats.heures_totales.cm.hm);
    $('#statTD').text(stats.heures_totales.td.hm);
    $('#statTP').text(stats.heures_totales.tp.hm);
    $('#statUE').text(stats.nombre_ue);
    $('#statMatieres').text(stats.nombre_matieres);
    $('#statIntervenants').text(stats.nombre_intervenants);
}

// Charger les données des heures d'enseignement
function loadHeuresEnseignement() {
    // Construction des paramètres de filtrage
    const anneeFilter = $('#anneesFilter').val();
    const niveauFilter = $('#niveauFilter').val();
    const semestreFilter = $('#semestreFilter').val();
    
    let urlParams = new URLSearchParams();
    
    if (anneeFilter) {
        const [anneeDebut, anneeFin] = anneeFilter.split('-');
        urlParams.append('annee_debut', anneeDebut);
        urlParams.append('annee_fin', anneeFin);
    }
    
    if (niveauFilter) {
        urlParams.append('niveau', niveauFilter);
    }
    
    if (semestreFilter) {
        urlParams.append('semestre', semestreFilter);
    }
    
    // Appel à l'API
    $.ajax({
        url: `${API_BASE_URL}/heures-enseignement?${urlParams.toString()}`,
        type: 'GET',
        headers: {
            'Authorization': `Bearer ${getApiToken()}`
        },
        success: function(response) {
            // Transformer les données pour le tableau
            const tableData = transformDataForTable(response);
            
            // Mettre à jour le DataTable
            heuresDataTable.clear();
            heuresDataTable.rows.add(tableData);
            heuresDataTable.draw();
        },
        error: function(xhr) {
            showNotification('error', 'Erreur lors du chargement des données');
            console.error('Erreur API:', xhr.responseText);
        }
    });
}

// Transformer les données pour le tableau
function transformDataForTable(data) {
    let tableData = [];
    
    data.forEach(record => {
        const anneeAcademique = record.annee_academique;
        const niveau = record.niveau;
        const semestre = record.semestre;
        const ue = record.unite_enseignement;
        
        // Ajouter une ligne par matière
        ue.matieres.forEach(matiere => {
            // Calculer les totaux par type d'heures
            const totalCM = matiere.heures_cm.hm || 0;
            const totalTD = matiere.heures_td.hm || 0;
            const totalTP = matiere.heures_tp.hm || 0;
            const total = totalCM + totalTD + totalTP;
            
            tableData.push({
                annee: `<span class="text-ellipsis col-annee">${anneeAcademique}</span>`,
                niveau: `<span class="text-ellipsis col-niveau">${niveau}</span>`,
                semestre: `<span class="text-ellipsis col-semestre">${semestre}</span>`,
                ue: `<span class="text-ellipsis col-ue" title="${ue.code} - ${ue.nom}">${ue.code} - ${ue.nom}</span>`,
                matiere: `<span class="text-ellipsis col-matiere" title="${matiere.nom}">${matiere.nom}</span>`,
                intervenant: `<span class="text-ellipsis col-intervenant" title="${matiere.intervenant || '-'}">${matiere.intervenant || '-'}</span>`,
                cm: `<span class="col-heures">${totalCM}</span>`,
                td: `<span class="col-heures">${totalTD}</span>`,
                tp: `<span class="col-heures">${totalTP}</span>`,
                total: `<span class="col-total">${total}</span>`,
                actions: `
                    <div class="col-actions">
                        <button class="btn btn-sm btn-outline-primary edit-btn" 
                                data-ue="${ue.code}" 
                                data-matiere="${matiere.nom}"
                                data-annee="${anneeAcademique}"
                                data-niveau="${niveau}"
                                data-semestre="${semestre}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-btn"
                                data-ue="${ue.code}" 
                                data-annee="${anneeAcademique}"
                                data-niveau="${niveau}"
                                data-semestre="${semestre}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `
            });
        });
    });
    
    return tableData;
}

// Fonction d'initialisation des graphiques
function initCharts() {
    // Graphique 1: Répartition des heures par type (Camembert)
    const typesHeuresCtx = document.getElementById('typesHeuresChart').getContext('2d');
    typesHeuresChart = new Chart(typesHeuresCtx, {
        type: 'pie',
        data: {
            labels: ['CM', 'TD', 'TP'],
            datasets: [{
                data: [0, 0, 0],
                backgroundColor: [
                    chartColors.cm,
                    chartColors.td,
                    chartColors.tp
                ],
                borderColor: [
                    chartColors.border.cm,
                    chartColors.border.td,
                    chartColors.border.tp
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const value = context.raw;
                            const percentage = Math.round((value / total) * 100);
                            return `${context.label}: ${value.toFixed(1)}h (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    
    // Graphique 2: Évolution des heures par année (Courbe)
    const evolutionHeuresCtx = document.getElementById('evolutionHeuresChart').getContext('2d');
    evolutionHeuresChart = new Chart(evolutionHeuresCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'CM',
                    data: [],
                    backgroundColor: chartColors.cm,
                    borderColor: chartColors.border.cm,
                    borderWidth: 2,
                    tension: 0.3
                },
                {
                    label: 'TD',
                    data: [],
                    backgroundColor: chartColors.td,
                    borderColor: chartColors.border.td,
                    borderWidth: 2,
                    tension: 0.3
                },
                {
                    label: 'TP',
                    data: [],
                    backgroundColor: chartColors.tp,
                    borderColor: chartColors.border.tp,
                    borderWidth: 2,
                    tension: 0.3
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.raw.toFixed(1)}h`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Nombre d\'heures'
                    }
                }
            }
        }
    });
    
    // Graphique 3: Répartition des heures par niveau (Histogramme)
    const heuresNiveauCtx = document.getElementById('heuresNiveauChart').getContext('2d');
    heuresNiveauChart = new Chart(heuresNiveauCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'CM',
                    data: [],
                    backgroundColor: chartColors.cm,
                    borderColor: chartColors.border.cm,
                    borderWidth: 1
                },
                {
                    label: 'TD',
                    data: [],
                    backgroundColor: chartColors.td,
                    borderColor: chartColors.border.td,
                    borderWidth: 1
                },
                {
                    label: 'TP',
                    data: [],
                    backgroundColor: chartColors.tp,
                    borderColor: chartColors.border.tp,
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.raw.toFixed(1)}h`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Nombre d\'heures'
                    }
                }
            }
        }
    });
    
    // Graphique 4: Types d'heures par semestre (Barres groupées)
    const heuresSemestreCtx = document.getElementById('heuresSemestreChart').getContext('2d');
    heuresSemestreChart = new Chart(heuresSemestreCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'CM',
                    data: [],
                    backgroundColor: chartColors.cm,
                    borderColor: chartColors.border.cm,
                    borderWidth: 1
                },
                {
                    label: 'TD',
                    data: [],
                    backgroundColor: chartColors.td,
                    borderColor: chartColors.border.td,
                    borderWidth: 1
                },
                {
                    label: 'TP',
                    data: [],
                    backgroundColor: chartColors.tp,
                    borderColor: chartColors.border.tp,
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.raw.toFixed(1)}h`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Nombre d\'heures'
                    }
                }
            }
        }
    });
}

// Fonction pour mettre à jour les graphiques avec les données reçues
function updateCharts(data) {
    // Mettre à jour le graphique camembert (Types d'heures)
    if (data.pie_chart) {
        typesHeuresChart.data.labels = data.pie_chart.labels;
        typesHeuresChart.data.datasets[0].data = data.pie_chart.data;
        typesHeuresChart.update();
    }
    
    // Mettre à jour le graphique de ligne (Évolution par année)
    if (data.line_chart) {
        evolutionHeuresChart.data.labels = data.line_chart.labels;
        
        // Mettre à jour chaque dataset
        data.line_chart.datasets.forEach((dataset, index) => {
            evolutionHeuresChart.data.datasets[index].data = dataset.data;
        });
        
        evolutionHeuresChart.update();
    }
    
    // Mettre à jour le graphique à barres (Par niveau)
    if (data.bar_chart_niveau) {
        heuresNiveauChart.data.labels = data.bar_chart_niveau.labels;
        
        // Mettre à jour chaque dataset
        data.bar_chart_niveau.datasets.forEach((dataset, index) => {
            heuresNiveauChart.data.datasets[index].data = dataset.data;
        });
        
        heuresNiveauChart.update();
    }
    
    // Mettre à jour le graphique à barres (Par semestre)
    if (data.bar_chart_semestre) {
        heuresSemestreChart.data.labels = data.bar_chart_semestre.labels;
        
        // Mettre à jour chaque dataset
        data.bar_chart_semestre.datasets.forEach((dataset, index) => {
            heuresSemestreChart.data.datasets[index].data = dataset.data;
        });
        
        heuresSemestreChart.update();
    }
}

// Afficher un indicateur de chargement
function showLoader() {
    // Implémenter selon votre design
    console.log('Chargement...');
    // Vous pourriez ajouter un spinner ou autre indicateur visuel ici
}

// Cacher l'indicateur de chargement
function hideLoader() {
    // Implémenter selon votre design
    console.log('Chargement terminé');
    // Supprimer le spinner ou autre indicateur visuel ici
}

// Sauvegarder les données du formulaire
function saveHeuresData() {
    // Récupérer les données du formulaire
    const annee_debut = $('#annee_debut').val();
    const annee_fin = $('#annee_fin').val();
    const niveau = $('#niveau').val();
    const semestre = $('#semestre').val();
    const ue_code = $('#ue_code').val();
    const ue_nom = $('#ue_nom').val();
    const matiere_nom = $('#matiere_nom').val();
    const ects = $('#ects').val();
    const intervenant = $('#intervenant').val();
    
    // Heures CM
    const cm_hm = $('#cm_hm').val();
    const cm_hp = $('#cm_hp').val();
    const cm_hr = $('#cm_hr').val();
    
    // Heures TD
    const td_hm = $('#td_hm').val();
    const td_hp = $('#td_hp').val();
    const td_hr = $('#td_hr').val();
    
    // Heures TP
    const tp_hm = $('#tp_hm').val();
    const tp_hp = $('#tp_hp').val();
    const tp_hr = $('#tp_hr').val();
    
    // Construire l'objet de données
    const data = {
        annee_debut: parseInt(annee_debut),
        annee_fin: parseInt(annee_fin),
        niveau: niveau,
        semestre: semestre,
        unite_enseignement: {
            code: ue_code,
            nom: ue_nom,
            matieres: [
                {
                    nom: matiere_nom,
                    ects: parseFloat(ects),
                    intervenant: intervenant,
                    heures_cm: {
                        hm: parseFloat(cm_hm),
                        hp: parseFloat(cm_hp),
                        hr: parseFloat(cm_hr)
                    },
                    heures_td: {
                        hm: parseFloat(td_hm),
                        hp: parseFloat(td_hp),
                        hr: parseFloat(td_hr)
                    },
                    heures_tp: {
                        hm: parseFloat(tp_hm),
                        hp: parseFloat(tp_hp),
                        hr: parseFloat(tp_hr)
                    }
                }
            ]
        }
    };
    
    // Envoyer les données à l'API
// Envoyer les données à l'API
    $.ajax({
        url: `${API_BASE_URL}/heures-enseignement/form`,
        type: 'POST',
        data: JSON.stringify(data),
        contentType: 'application/json',
        headers: {
            'Authorization': `Bearer ${getApiToken()}`
        },
        success: function(response) {
            $('#addDataModal').modal('hide');
            showNotification('success', 'Données enregistrées avec succès!');
            
            // Actualiser les données
            loadHeuresEnseignementStats();
            loadHeuresEnseignement();
            // Recharger les données des graphiques
            loadChartData();
        },
        error: function(xhr) {
            let message = 'Erreur lors de l\'enregistrement des données';
            
            try {
                const response = JSON.parse(xhr.responseText);
                message = response.error || message;
            } catch (e) {}
            
            showNotification('error', message);
        }
    });
}

// Uploader un fichier CSV/Excel
function uploadHeuresFile() {
    // Récupérer le formulaire
    const form = $('#uploadForm')[0];
    const formData = new FormData(form);
    
    // Récupérer le token d'authentification
    const token = getApiToken();
    console.log("Token utilisé:", token); // Pour le débogage
    
    // Envoyer les données à l'API
    $.ajax({
        url: `${API_BASE_URL}/heures-enseignement/upload`,
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'Authorization': `Bearer ${token}`
        },
        success: function(response) {
            $('#uploadCSVModal').modal('hide');
            showNotification('success', `Fichier importé avec succès! ${response.records_inserted} enregistrements insérés.`);
            
            // Réinitialiser le formulaire
            $('#uploadForm')[0].reset();
            $('.custom-file-label').text('Choisir un fichier...');
            
            // Actualiser les données
            loadHeuresEnseignementStats();
            loadHeuresEnseignement();
            // Recharger les données des graphiques
            loadChartData();
        },
        error: function(xhr, status, error) {
            console.log("Erreur AJAX:", status, error);
            console.log("Réponse:", xhr.responseText);
            
            let message = 'Erreur lors de l\'importation du fichier';
            
            if (xhr.status === 401) {
                message = 'Erreur d\'authentification. Veuillez vous reconnecter.';
                // Optionnel : rediriger vers la page de connexion
                // window.location.href = '/login/';
            } else {
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.warning) {
                        message = response.warning;
                    } else if (response.error) {
                        message = response.error;
                    }
                } catch (e) {
                    console.log("Erreur de parsing de la réponse:", e);
                }
            }
            
            showNotification('error', message);
        }
    });
}

// Supprimer des données
function deleteHeuresData() {
    // Vérifier que les données de suppression sont définies
    if (!deleteData.annee_academique) {
        showNotification('error', 'Données de suppression incomplètes');
        return;
    }
    
    // Envoyer la requête de suppression
    $.ajax({
        url: `${API_BASE_URL}/heures-enseignement/delete`,
        type: 'DELETE',
        data: JSON.stringify(deleteData),
        contentType: 'application/json',
        headers: {
            'Authorization': `Bearer ${getApiToken()}`
        },
        success: function(response) {
            $('#deleteModal').modal('hide');
            showNotification('success', 'Données supprimées avec succès!');
            
            // Actualiser les données
            loadHeuresEnseignementStats();
            loadHeuresEnseignement();
            // Recharger les données des graphiques
            loadChartData();
        },
        error: function(xhr) {
            let message = 'Erreur lors de la suppression des données';
            
            try {
                const response = JSON.parse(xhr.responseText);
                message = response.error || message;
            } catch (e) {}
            
            showNotification('error', message);
        }
    });
}

// Fonction pour éditer les données (remplir le formulaire)
function editHeuresData(anneeAcademique, niveau, semestre, ueCode, matiere) {
    // Récupérer les données détaillées
    $.ajax({
        url: `${API_BASE_URL}/heures-enseignement?annee_academique=${anneeAcademique}&niveau=${niveau}&semestre=${semestre}`,
        type: 'GET',
        headers: {
            'Authorization': `Bearer ${getApiToken()}`
        },
        success: function(response) {
            // Trouver l'UE et la matière correspondantes
            const record = response.find(r => r.unite_enseignement.code === ueCode);
            
            if (record) {
                const ue = record.unite_enseignement;
                const matiereObj = ue.matieres.find(m => m.nom === matiere);
                
                if (matiereObj) {
                    // Extraire l'année de début et de fin
                    const [anneeDebut, anneeFin] = anneeAcademique.split('-');
                    
                    // Remplir le formulaire
                    $('#annee_debut').val(anneeDebut);
                    $('#annee_fin').val(anneeFin);
                    $('#niveau').val(niveau);
                    $('#semestre').val(semestre);
                    $('#ue_code').val(ue.code);
                    $('#ue_nom').val(ue.nom);
                    $('#matiere_nom').val(matiereObj.nom);
                    $('#ects').val(matiereObj.ects || 0);
                    $('#intervenant').val(matiereObj.intervenant || '');
                    
                    // Heures CM
                    $('#cm_hm').val(matiereObj.heures_cm.hm || 0);
                    $('#cm_hp').val(matiereObj.heures_cm.hp || 0);
                    $('#cm_hr').val(matiereObj.heures_cm.hr || 0);
                    
                    // Heures TD
                    $('#td_hm').val(matiereObj.heures_td.hm || 0);
                    $('#td_hp').val(matiereObj.heures_td.hp || 0);
                    $('#td_hr').val(matiereObj.heures_td.hr || 0);
                    
                    // Heures TP
                    $('#tp_hm').val(matiereObj.heures_tp.hm || 0);
                    $('#tp_hp').val(matiereObj.heures_tp.hp || 0);
                    $('#tp_hr').val(matiereObj.heures_tp.hr || 0);
                    
                    // Mettre à jour le titre du modal
                    $('#addDataModalTitle').text('Modifier des heures d\'enseignement');
                    
                    // Afficher le modal
                    $('#addDataModal').modal('show');
                } else {
                    showNotification('error', 'Matière non trouvée');
                }
            } else {
                showNotification('error', 'UE non trouvée');
            }
        },
        error: function(xhr) {
            showNotification('error', 'Erreur lors de la récupération des données à éditer');
        }
    });
}

// Fonction pour préparer la suppression
function prepareDelete(anneeAcademique, niveau, semestre, ueCode) {
    // Stocker les données de suppression
    deleteData = {
        annee_academique: anneeAcademique,
        niveau: niveau,
        semestre: semestre,
        code_ue: ueCode
    };
    
    // Préparer les détails pour l'affichage
    let details = `
        <ul class="list-group mt-3 mb-3">
            <li class="list-group-item d-flex justify-content-between align-items-center">
                Année académique
                <span class="badge badge-primary badge-pill">${anneeAcademique}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                Niveau
                <span class="badge badge-primary badge-pill">${niveau}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                Semestre
                <span class="badge badge-primary badge-pill">${semestre}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                Code UE
                <span class="badge badge-primary badge-pill">${ueCode}</span>
            </li>
        </ul>
    `;
    
    // Mettre à jour le modal
    $('#deleteDetails').html(details);
    
    // Afficher le modal
    $('#deleteModal').modal('show');
}

// Actualiser tous les graphiques
function refreshAllCharts() {
    loadHeuresEnseignementStats();
    loadHeuresEnseignement();
    loadChartData();
    showNotification('success', 'Données actualisées!');
}

// Événements pour les boutons d'édition et de suppression dans le tableau
$(document).on('click', '.edit-btn', function() {
    const anneeAcademique = $(this).data('annee');
    const niveau = $(this).data('niveau');
    const semestre = $(this).data('semestre');
    const ueCode = $(this).data('ue');
    const matiere = $(this).data('matiere');
    
    editHeuresData(anneeAcademique, niveau, semestre, ueCode, matiere);
});

$(document).on('click', '.delete-btn', function() {
    const anneeAcademique = $(this).data('annee');
    const niveau = $(this).data('niveau');
    const semestre = $(this).data('semestre');
    const ueCode = $(this).data('ue');
    
    prepareDelete(anneeAcademique, niveau, semestre, ueCode);
});

// Réinitialiser le formulaire quand on ferme le modal
$('#addDataModal').on('hidden.bs.modal', function () {
    $('#addDataModalTitle').text('Ajouter des heures d\'enseignement');
    $('#heuresForm')[0].reset();
});

// Réinitialiser le formulaire d'upload quand on ferme le modal
$('#uploadCSVModal').on('hidden.bs.modal', function () {
    $('#uploadForm')[0].reset();
    $('.custom-file-label').text('Choisir un fichier...');
});

function loadHeuresData() {
    // Récupérer le token d'authentification (à adapter selon votre méthode de stockage)
    const token = sessionStorage.getItem('api_token') || localStorage.getItem('api_token');
    
    // Appel à l'API pour récupérer les données
    fetch('/api/heures-enseignement/data', {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log("Données récupérées:", data);
        afficherDonnees(data);
        populerFiltre(data);
    })
    .catch(error => {
        console.error('Erreur lors de la récupération des données:', error);
        // Afficher un message d'erreur à l'utilisateur
        document.getElementById('heuresTableBody').innerHTML = `
            <tr>
                <td colspan="11" class="text-center">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        Impossible de charger les données. Veuillez réessayer plus tard.
                    </div>
                </td>
            </tr>
        `;
    });
}

// Fonction pour afficher les données dans le tableau
function afficherDonnees(data) {
    const tableBody = document.getElementById('heuresTableBody');
    tableBody.innerHTML = '';
    
    let totalCM = 0;
    let totalTD = 0;
    let totalTP = 0;
    
    // Vérifier si les données sont vides
    if (!data || data.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="11" class="text-center">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Aucune donnée disponible. Veuillez ajouter des heures d'enseignement.
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    // Parcourir les données et créer les lignes du tableau
    data.forEach(item => {
        const ue = item.unite_enseignement;
        
        ue.matieres.forEach(matiere => {
            // Calculer les totaux pour CM, TD, TP
            const cmTotal = (matiere.heures_cm.hm || 0) + (matiere.heures_cm.hp || 0) + (matiere.heures_cm.hr || 0);
            const tdTotal = (matiere.heures_td.hm || 0) + (matiere.heures_td.hp || 0) + (matiere.heures_td.hr || 0);
            const tpTotal = (matiere.heures_tp.hm || 0) + (matiere.heures_tp.hp || 0) + (matiere.heures_tp.hr || 0);
            const rowTotal = cmTotal + tdTotal + tpTotal;
            
            // Créer la ligne du tableau
            const row = document.createElement('tr');
            row.dataset.niveau = item.niveau; // Ajouter l'attribut pour le filtrage
            
            row.innerHTML = `
                <td>${item.annee || '-'}</td>
                <td>${item.niveau || '-'}</td>
                <td>${item.semestre || '-'}</td>
                <td title="${ue.code || ''}">
                    ${ue.nom || '-'}
                </td>
                <td>${matiere.nom || '-'}</td>
                <td>${matiere.intervenant || '-'}</td>
                <td>${cmTotal}</td>
                <td>${tdTotal}</td>
                <td>${tpTotal}</td>
                <td>${rowTotal}</td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="editRow(this)" title="Modifier">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteRow(this)" title="Supprimer">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            tableBody.appendChild(row);
            
            // Mettre à jour les statistiques
            totalCM += cmTotal;
            totalTD += tdTotal;
            totalTP += tpTotal;
        });
    });
    
    // Mettre à jour les cartes de statistiques si elles existent
    if (document.getElementById('statCM')) document.getElementById('statCM').textContent = totalCM;
    if (document.getElementById('statTD')) document.getElementById('statTD').textContent = totalTD;
    if (document.getElementById('statTP')) document.getElementById('statTP').textContent = totalTP;
}

function populateNiveauFilter() {
    // Récupérer les données du DataTable
    const data = heuresDataTable.data().toArray();
    
    // Extraire les niveaux uniques
    const niveaux = new Set();
    data.forEach(item => {
        if (item.niveau) {
            // Extraire le texte du HTML
            const niveau = $(item.niveau).text();
            if (niveau) {
                niveaux.add(niveau);
            }
        }
    });
    
    // Remplir le filtre
    const levelFilter = $('#levelFilter');
    
    // Conserver l'option "Tous les niveaux"
    levelFilter.empty().append('<option value="all">Tous les niveaux</option>');
    
    // Ajouter les options de niveau
    Array.from(niveaux).sort().forEach(niveau => {
        levelFilter.append(`<option value="${niveau}">${niveau}</option>`);
    });
}

// Fonctions pour les actions sur les lignes
function editRow(button) {
    const row = button.closest('tr');
    console.log("Éditer ligne:", row);
    // Implémenter la fonctionnalité d'édition
}

function deleteRow(button) {
    const row = button.closest('tr');
    console.log("Supprimer ligne:", row);
    
    if (confirm('Êtes-vous sûr de vouloir supprimer cette entrée ?')) {
        // Implémenter la suppression
    }
}

// Fonction pour afficher une notification
function showNotification(type, message) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const iconClass = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
    
    const notification = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;">
            <i class="fas ${iconClass} mr-2"></i>
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    `;
    
    $('body').append(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        $('.alert').fadeOut('slow', function() {
            $(this).remove();
        });
    }, 2000);
}
</script>
{% endblock %}