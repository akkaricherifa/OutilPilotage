{% extends 'statistiques/base.html' %}

{% block title %}Heures d'Enseignement - AppISIS{% endblock %}

{% block extra_css %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap4.min.css">

<style>
    :root {
        /* Couleurs ISIS basées sur la charte graphique */
        --isis-purple-dark: #2f0d73;    /* Violet foncé principal */
        --isis-purple: #7c50de;         /* Violet principal */
        --isis-purple-light: #ac54c7;   /* Violet clair */
        --isis-coral: #f56960;          /* Corail/rouge */
        --isis-coral-light: #ffb43c;    /* Orange/jaune */
        --isis-teal: #3cbebe;           /* Turquoise */
    }
    
    .stat-card {
        transition: transform 0.2s;
        border-left: 4px solid;
        margin-bottom: 20px;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .stat-card-cm { border-left-color: var(--isis-purple-dark); }
    .stat-card-td { border-left-color: var(--isis-purple); }
    .stat-card-tp { border-left-color: var(--isis-purple-light); }
    .stat-card-ue { border-left-color: var(--isis-coral); }
    .stat-card-matieres { border-left-color: var(--isis-coral-light); }
    .stat-card-intervenants { border-left-color: var(--isis-teal); }
    
    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        border: 1px solid #e9ecef;
        height: 400px;
    }
    
    .chart-container h5 {
        color: var(--isis-purple-dark);
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    
    .dashboard-header {
        background: linear-gradient(135deg, var(--isis-purple-dark) 0%, var(--isis-purple) 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
    }
    
    .dashboard-header h1 {
        margin: 0;
        font-weight: 300;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 30px;
    }
    
    .modal-header-custom {
        background: linear-gradient(135deg, var(--isis-purple-dark) 0%, var(--isis-purple) 100%);
        color: white;
    }
    
    .form-control:focus {
        border-color: var(--isis-purple);
        box-shadow: 0 0 0 0.2rem rgba(124, 80, 222, 0.25);
    }
    
    .btn-primary-custom {
        background: linear-gradient(135deg, var(--isis-purple-dark) 0%, var(--isis-purple) 100%);
        border: none;
        color: white;
    }
    
    .btn-primary-custom:hover {
        background: linear-gradient(135deg, var(--isis-purple) 0%, var(--isis-purple-light) 100%);
    }

    canvas {
        max-height: 300px;
    }
    
    .filter-container {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        border: 1px solid #e9ecef;
    }
    
    .filter-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: var(--isis-purple-dark);
    }
    
    .filter-form .form-group {
        margin-bottom: 0;
    }
    
    .filter-form .form-control {
        border-radius: 10px;
    }
    
    .filter-form .btn {
        border-radius: 10px;
    }

    .heures-table th {
        background: linear-gradient(135deg, var(--isis-purple-dark) 0%, var(--isis-purple) 100%);
        color: white;
    }
    
    @media (max-width: 768px) {
        .chart-grid {
            grid-template-columns: 1fr;
        }
        
        .filter-container {
            padding: 15px;
        }
        
        .filter-form .form-group {
            margin-bottom: 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- En-tête du dashboard -->
<div class="dashboard-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1><i class="fas fa-clock mr-3"></i>Heures d'Enseignement</h1>
            <p class="mb-0">Analyse détaillée des heures d'enseignement par catégorie</p>
        </div>
        <div class="action-buttons d-flex flex-wrap">
            <button class="btn btn-light btn-lg mr-2" data-toggle="modal" data-target="#addDataModal">
                <i class="fas fa-plus mr-2"></i>Ajouter des données
            </button>
            <button class="btn btn-success btn-lg mr-2" data-toggle="modal" data-target="#uploadCSVModal">
                <i class="fas fa-file-upload mr-2"></i>Importer CSV/Excel
            </button>
            <button class="btn btn-warning btn-lg" onclick="refreshAllCharts()">
                <i class="fas fa-sync mr-2"></i>Actualiser
            </button>
        </div>
    </div>
</div>

<!-- Filtres -->
<div class="filter-container">
    <div class="filter-title">
        <i class="fas fa-filter mr-2"></i>Filtres
    </div>
    <form class="filter-form row" id="filterForm">
        <div class="form-group col-md-3">
            <label for="anneesFilter">Année académique</label>
            <select class="form-control" id="anneesFilter">
                <option value="">Toutes les années</option>
                <option value="2024-2025">2024-2025</option>
                <option value="2023-2024">2023-2024</option>
                <option value="2022-2023">2022-2023</option>
                <option value="2021-2022">2021-2022</option>
                <option value="2020-2021">2020-2021</option>
            </select>
        </div>
        <div class="form-group col-md-3">
            <label for="niveauFilter">Niveau</label>
            <select class="form-control" id="niveauFilter">
                <option value="">Tous les niveaux</option>
                <option value="FIE1">FIE1</option>
                <option value="FIE2">FIE2</option>
                <option value="FIE3">FIE3</option>
                <option value="FIE4">FIE4</option>
                <option value="FIE5">FIE5</option>
                <option value="FIA3">FIA3</option>
                <option value="FIA5">FIA5</option>
            </select>
        </div>
        <div class="form-group col-md-3">
            <label for="semestreFilter">Semestre</label>
            <select class="form-control" id="semestreFilter">
                <option value="">Tous les semestres</option>
                <option value="S1">S1</option>
                <option value="S2">S2</option>
                <option value="S3">S3</option>
                <option value="S4">S4</option>
                <option value="S5">S5</option>
                <option value="S6">S6</option>
                <option value="S7">S7</option>
                <option value="S8">S8</option>
                <option value="S9">S9</option>
                <option value="S10">S10</option>
            </select>
        </div>
        <div class="form-group col-md-3 d-flex align-items-end">
            <button type="button" class="btn btn-primary-custom w-100" id="applyFilters">
                <i class="fas fa-search mr-2"></i>Appliquer les filtres
            </button>
        </div>
    </form>
</div>

<!-- Statistiques résumées -->
<div class="stats-grid">
    <div class="card stat-card stat-card-cm">
        <div class="card-body text-center">
            <h3 style="color: var(--isis-purple-dark);" id="statCM">0</h3>
            <p class="mb-0">Heures CM</p>
        </div>
    </div>
    <div class="card stat-card stat-card-td">
        <div class="card-body text-center">
            <h3 style="color: var(--isis-purple);" id="statTD">0</h3>
            <p class="mb-0">Heures TD</p>
        </div>
    </div>
    <div class="card stat-card stat-card-tp">
        <div class="card-body text-center">
            <h3 style="color: var(--isis-purple-light);" id="statTP">0</h3>
            <p class="mb-0">Heures TP</p>
        </div>
    </div>
    <div class="card stat-card stat-card-ue">
        <div class="card-body text-center">
            <h3 style="color: var(--isis-coral);" id="statUE">0</h3>
            <p class="mb-0">Unités d'Enseignement</p>
        </div>
    </div>
    <div class="card stat-card stat-card-matieres">
        <div class="card-body text-center">
            <h3 style="color: var(--isis-coral-light);" id="statMatieres">0</h3>
            <p class="mb-0">Matières</p>
        </div>
    </div>
    <div class="card stat-card stat-card-intervenants">
        <div class="card-body text-center">
            <h3 style="color: var(--isis-teal);" id="statIntervenants">0</h3>
            <p class="mb-0">Intervenants</p>
        </div>
    </div>
</div>

<!-- Graphiques -->
<div class="chart-grid">
    <!-- Graphique 1: Répartition des heures par type (Camembert) -->
    <div class="chart-container">
        <h5><i class="fas fa-chart-pie mr-2"></i>Répartition des Heures par Type</h5>
        <canvas id="typesHeuresChart"></canvas>
    </div>

    <!-- Graphique 2: Évolution des heures par année académique (Courbe) -->
    <div class="chart-container">
        <h5><i class="fas fa-chart-line mr-2"></i>Évolution des Heures par Année</h5>
        <canvas id="evolutionHeuresChart"></canvas>
    </div>

    <!-- Graphique 3: Répartition des heures par niveau (Histogramme) -->
    <div class="chart-container">
        <h5><i class="fas fa-chart-bar mr-2"></i>Répartition des Heures par Niveau</h5>
        <canvas id="heuresNiveauChart"></canvas>
    </div>

    <!-- Graphique 4: Types d'heures par semestre (Barres groupées) -->
    <div class="chart-container">
        <h5><i class="fas fa-bars mr-2"></i>Types d'Heures par Semestre</h5>
        <canvas id="heuresSemestreChart"></canvas>
    </div>
</div>

<!-- Tableau des données -->
<div class="chart-container" style="height: auto;">
    <h5><i class="fas fa-table mr-2"></i>Données Détaillées des Heures d'Enseignement</h5>
    <div class="table-responsive">
        <table class="table table-striped table-hover heures-table" id="heuresTable">
            <thead>
                <tr>
                    <th>Année</th>
                    <th>Niveau</th>
                    <th>Semestre</th>
                    <th>UE</th>
                    <th>Matière</th>
                    <th>Intervenant</th>
                    <th>CM</th>
                    <th>TD</th>
                    <th>TP</th>
                    <th>Total</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="heuresTableBody">
                <!-- Les données seront chargées dynamiquement via JavaScript -->
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Ajouter des données -->
<div class="modal fade" id="addDataModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title" id="addDataModalTitle">Ajouter des heures d'enseignement</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="heuresForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Année de début <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" name="annee_debut" id="annee_debut" required min="2000" max="2030" value="2024">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Année de fin <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" name="annee_fin" id="annee_fin" required min="2000" max="2030" value="2025">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Niveau <span class="text-danger">*</span></label>
                                <select class="form-control" name="niveau" id="niveau" required>
                                    <option value="">Sélectionnez un niveau</option>
                                    <option value="FIE1">FIE1</option>
                                    <option value="FIE2">FIE2</option>
                                    <option value="FIE3">FIE3</option>
                                    <option value="FIE4">FIE4</option>
                                    <option value="FIE5">FIE5</option>
                                    <option value="FIA3">FIA3</option>
                                    <option value="FIA5">FIA5</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Semestre <span class="text-danger">*</span></label>
                                <select class="form-control" name="semestre" id="semestre" required>
                                    <option value="">Sélectionnez un semestre</option>
                                    <option value="S1">S1</option>
                                    <option value="S2">S2</option>
                                    <option value="S3">S3</option>
                                    <option value="S4">S4</option>
                                    <option value="S5">S5</option>
                                    <option value="S6">S6</option>
                                    <option value="S7">S7</option>
                                    <option value="S8">S8</option>
                                    <option value="S9">S9</option>
                                    <option value="S10">S10</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="form-group">
                                <label>Unité d'Enseignement (UE) <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">Code</span>
                                    </div>
                                    <input type="text" class="form-control" name="ue_code" id="ue_code" placeholder="Ex: E1-INFO" required>
                                    <div class="input-group-prepend ml-2">
                                        <span class="input-group-text">Nom</span>
                                    </div>
                                    <input type="text" class="form-control" name="ue_nom" id="ue_nom" placeholder="Ex: Informatique Fondamentale" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>
                    <h6 class="text-primary"><i class="fas fa-book mr-2"></i>Informations Matière</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Nom de la matière <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="matiere_nom" id="matiere_nom" placeholder="Ex: Programmation Objet" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>ECTS</label>
                                <input type="number" class="form-control" name="ects" id="ects" min="0" max="30" step="0.5" value="3">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>Intervenant</label>
                                <input type="text" class="form-control" name="intervenant" id="intervenant" placeholder="Nom de l'intervenant">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Heures CM</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" title="Heures Maquette">HM</span>
                                    </div>
                                    <input type="number" class="form-control" name="cm_hm" id="cm_hm" min="0" step="0.5" value="0">
                                </div>
                                <div class="input-group mt-2">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" title="Heures Programmées">HP</span>
                                    </div>
                                    <input type="number" class="form-control" name="cm_hp" id="cm_hp" min="0" step="0.5" value="0">
                                </div>
                                <div class="input-group mt-2">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" title="Heures Réalisées">HR</span>
                                    </div>
                                    <input type="number" class="form-control" name="cm_hr" id="cm_hr" min="0" step="0.5" value="0">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Heures TD</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" title="Heures Maquette">HM</span>
                                    </div>
                                    <input type="number" class="form-control" name="td_hm" id="td_hm" min="0" step="0.5" value="0">
                                </div>
                                <div class="input-group mt-2">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" title="Heures Programmées">HP</span>
                                    </div>
                                    <input type="number" class="form-control" name="td_hp" id="td_hp" min="0" step="0.5" value="0">
                                </div>
                                <div class="input-group mt-2">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" title="Heures Réalisées">HR</span>
                                    </div>
                                    <input type="number" class="form-control" name="td_hr" id="td_hr" min="0" step="0.5" value="0">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Heures TP</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" title="Heures Maquette">HM</span>
                                    </div>
                                    <input type="number" class="form-control" name="tp_hm" id="tp_hm" min="0" step="0.5" value="0">
                                </div>
                                <div class="input-group mt-2">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" title="Heures Programmées">HP</span>
                                    </div>
                                    <input type="number" class="form-control" name="tp_hp" id="tp_hp" min="0" step="0.5" value="0">
                                </div>
                                <div class="input-group mt-2">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text" title="Heures Réalisées">HR</span>
                                    </div>
                                    <input type="number" class="form-control" name="tp_hr" id="tp_hr" min="0" step="0.5" value="0">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary-custom">
                        <i class="fas fa-save mr-1"></i>Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Upload CSV/Excel -->
<div class="modal fade" id="uploadCSVModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title">Importer un fichier CSV/Excel</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Fichier CSV/Excel <span class="text-danger">*</span></label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="csvFile" name="file" accept=".csv,.xlsx,.xls" required>
                            <label class="custom-file-label" for="csvFile">Choisir un fichier...</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Année de début <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" name="annee_debut" required min="2000" max="2030" value="2024">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Année de fin <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" name="annee_fin" required min="2000" max="2030" value="2025">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Niveau <span class="text-danger">*</span></label>
                                <select class="form-control" name="niveau" required>
                                    <option value="">Sélectionnez un niveau</option>
                                    <option value="FIE1">FIE1</option>
                                    <option value="FIE2">FIE2</option>
                                    <option value="FIE3">FIE3</option>
                                    <option value="FIE4">FIE4</option>
                                    <option value="FIE5">FIE5</option>
                                    <option value="FIA3">FIA3</option>
                                    <option value="FIA5">FIA5</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Semestre <span class="text-danger">*</span></label>
                                <select class="form-control" name="semestre" required>
                                    <option value="">Sélectionnez un semestre</option>
                                    <option value="S1">S1</option>
                                    <option value="S2">S2</option>
                                    <option value="S3">S3</option>
                                    <option value="S4">S4</option>
                                    <option value="S5">S5</option>
                                    <option value="S6">S6</option>
                                    <option value="S7">S7</option>
                                    <option value="S8">S8</option>
                                    <option value="S9">S9</option>
                                    <option value="S10">S10</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Description (optionnelle)</label>
                                <textarea class="form-control" name="description" rows="2" placeholder="Description des données importées..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle mr-2"></i>Format attendu pour Excel :</h6>
                        <p>Le fichier doit contenir les colonnes suivantes :</p>
                        <ul>
                            <li>Colonne 1: Code UE (ex: E1-INFO1)</li>
                            <li>Colonne 2: Nom UE/Matière</li>
                            <li>Colonne 3: ECTS</li>
                            <li>Colonne 4: Intervenant</li>
                            <li>Colonnes 5-7: Heures CM (HM, HP, HR)</li>
                            <li>Colonnes 9-11: Heures TD (HM, HP, HR)</li>
                            <li>Colonnes 13-15: Heures TP (HM, HP, HR)</li>
                        </ul>
                        <p><small>Note: Le système détecte automatiquement les UE (lignes commençant par "E1-", "E2-", etc.) et les matières qui leur sont associées.</small></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload mr-1"></i>Importer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de confirmation de suppression -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirmer la suppression</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir supprimer ces données ?</p>
                <div id="deleteDetails"></div>
                <small class="text-muted">Cette action est irréversible.</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">
                    <i class="fas fa-trash mr-1"></i>Supprimer
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- DataTables JS -->
<script type="text/javascript" src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap4.min.js"></script>

<script>
// Variables globales
let charts = {};
let heuresDataTable;
let deleteData = {
    annee_academique: null,
    niveau: null,
    semestre: null,
    code_ue: null
};

// Définir l'URL de base de l'API
const API_BASE_URL = '{{ settings.API_URL }}';

// Récupère le token API depuis la session Django
function getApiToken() {
    return '{{ request.session.api_token }}';
}

$(document).ready(function() {
    // Initialiser DataTable
    heuresDataTable = $('#heuresTable').DataTable({
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/French.json"
        },
        "order": [[0, "desc"], [1, "asc"], [2, "asc"]],
        "pageLength": 10,
        "responsive": true,
        "columns": [
            { "data": "annee" },
            { "data": "niveau" },
            { "data": "semestre" },
            { "data": "ue" },
            { "data": "matiere" },
            { "data": "intervenant" },
            { "data": "cm" },
            { "data": "td" },
            { "data": "tp" },
            { "data": "total" },
            { "data": "actions", "orderable": false }
        ]
    });

    // Charger les données initiales
    loadHeuresEnseignementStats();
    loadHeuresEnseignement();
    
    // Événement de changement de fichier pour afficher le nom
    $('.custom-file-input').on('change', function() {
        let fileName = $(this).val().split('\\').pop();
        $(this).siblings('.custom-file-label').addClass("selected").html(fileName);
    });
    
    // Gestion du bouton d'application des filtres
    $('#applyFilters').on('click', function() {
        loadHeuresEnseignementStats();
        loadHeuresEnseignement();
    });
    
    // Soumission du formulaire d'ajout de données
    $('#heuresForm').on('submit', function(e) {
        e.preventDefault();
        saveHeuresData();
    });
    
    // Soumission du formulaire d'importation CSV/Excel
    $('#uploadForm').on('submit', function(e) {
        e.preventDefault();
        uploadHeuresFile();
    });
    
    // Gestion du bouton de confirmation de suppression
    $('#confirmDelete').on('click', function() {
        deleteHeuresData();
    });
});

// Charger les statistiques des heures d'enseignement
function loadHeuresEnseignementStats() {
    // Construction des paramètres de filtrage
    const anneeFilter = $('#anneesFilter').val();
    const niveauFilter = $('#niveauFilter').val();
    const semestreFilter = $('#semestreFilter').val();
    
    let urlParams = new URLSearchParams();
    
    if (anneeFilter) {
        const [anneeDebut, anneeFin] = anneeFilter.split('-');
        urlParams.append('annee_debut', anneeDebut);
        urlParams.append('annee_fin', anneeFin);
    }
    
    if (niveauFilter) {
        urlParams.append('niveau', niveauFilter);
    }
    
    // Appel à l'API
    $.ajax({
        url: `${API_BASE_URL}/heures-enseignement/stats?${urlParams.toString()}`,
        type: 'GET',
        headers: {
            'Authorization': `Bearer ${getApiToken()}`
        },
        success: function(response) {
            // Mettre à jour les statistiques
            updateStats(response);
            
            // Charger les graphiques
            loadCharts(response);
        },
        error: function(xhr) {
            showNotification('error', 'Erreur lors du chargement des statistiques');
            console.error('Erreur API:', xhr.responseText);
        }
    });
}

// Mettre à jour les statistiques affichées
function updateStats(stats) {
    // Mettre à jour les cartes de statistiques
    $('#statCM').text(stats.heures_totales.cm.hm);
    $('#statTD').text(stats.heures_totales.td.hm);
    $('#statTP').text(stats.heures_totales.tp.hm);
    $('#statUE').text(stats.nombre_ue);
    $('#statMatieres').text(stats.nombre_matieres);
    $('#statIntervenants').text(stats.nombre_intervenants);
}

// Charger les données des heures d'enseignement
function loadHeuresEnseignement() {
    // Construction des paramètres de filtrage
    const anneeFilter = $('#anneesFilter').val();
    const niveauFilter = $('#niveauFilter').val();
    const semestreFilter = $('#semestreFilter').val();
    
    let urlParams = new URLSearchParams();
    
    if (anneeFilter) {
        const [anneeDebut, anneeFin] = anneeFilter.split('-');
        urlParams.append('annee_debut', anneeDebut);
        urlParams.append('annee_fin', anneeFin);
    }
    
    if (niveauFilter) {
        urlParams.append('niveau', niveauFilter);
    }
    
    if (semestreFilter) {
        urlParams.append('semestre', semestreFilter);
    }
    
    // Appel à l'API
    $.ajax({
        url: `${API_BASE_URL}/heures-enseignement?${urlParams.toString()}`,
        type: 'GET',
        headers: {
            'Authorization': `Bearer ${getApiToken()}`
        },
        success: function(response) {
            // Transformer les données pour le tableau
            const tableData = transformDataForTable(response);
            
            // Mettre à jour le DataTable
            heuresDataTable.clear();
            heuresDataTable.rows.add(tableData);
            heuresDataTable.draw();
        },
        error: function(xhr) {
            showNotification('error', 'Erreur lors du chargement des données');
            console.error('Erreur API:', xhr.responseText);
        }
    });
}

// Transformer les données pour le tableau
function transformDataForTable(data) {
    let tableData = [];
    
    data.forEach(record => {
        const anneeAcademique = record.annee_academique;
        const niveau = record.niveau;
        const semestre = record.semestre;
        const ue = record.unite_enseignement;
        
        // Ajouter une ligne par matière
        ue.matieres.forEach(matiere => {
            // Calculer les totaux par type d'heures
            const totalCM = matiere.heures_cm.hm || 0;
            const totalTD = matiere.heures_td.hm || 0;
            const totalTP = matiere.heures_tp.hm || 0;
            const total = totalCM + totalTD + totalTP;
            
            tableData.push({
                annee: anneeAcademique,
                niveau: niveau,
                semestre: semestre,
                ue: `${ue.code} - ${ue.nom}`,
                matiere: matiere.nom,
                intervenant: matiere.intervenant || '-',
                cm: totalCM,
                td: totalTD,
                tp: totalTP,
                total: total,
                actions: `
                    <button class="btn btn-sm btn-outline-primary edit-btn" 
                            data-ue="${ue.code}" 
                            data-matiere="${matiere.nom}"
                            data-annee="${anneeAcademique}"
                            data-niveau="${niveau}"
                            data-semestre="${semestre}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-btn"
                            data-ue="${ue.code}" 
                            data-annee="${anneeAcademique}"
                            data-niveau="${niveau}"
                            data-semestre="${semestre}">
                        <i class="fas fa-trash"></i>
                    </button>
                `
            });
        });
    });
    
    return tableData;
}

// Charger les graphiques
function loadCharts(stats) {
    // Détruire les graphiques existants s'ils existent
    Object.values(charts).forEach(chart => {
        if (chart && typeof chart.destroy === 'function') {
            chart.destroy();
        }
    });
    
    // Réinitialiser l'objet charts
    charts = {};
    
    // 1. Graphique camembert - Répartition des types d'heures
    const ctxTypes = document.getElementById('typesHeuresChart').getContext('2d');
    charts.types = new Chart(ctxTypes, {
        type: 'pie',
        data: {
            labels: ['Cours Magistraux (CM)', 'Travaux Dirigés (TD)', 'Travaux Pratiques (TP)'],
            datasets: [{
                data: [
                    stats.heures_totales.cm.hm,
                    stats.heures_totales.td.hm,
                    stats.heures_totales.tp.hm
                ],
                backgroundColor: ['#2f0d73', '#7c50de', '#ac54c7']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((acc, val) => acc + val, 0);
                            const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                            return `${label}: ${value}h (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    
    // 2. Graphique en courbe - Évolution des heures par année académique
    // Pour ce graphique, nous aurions besoin de données d'évolution par année
    // Mais comme nous n'avons pas ces données dans la réponse actuelle, nous créons un graphique fictif
    const ctxEvolution = document.getElementById('evolutionHeuresChart').getContext('2d');
    
    // Données fictives pour l'exemple
    // En production, ces données devraient être récupérées via une API dédiée
    const annees = ['2020-2021', '2021-2022', '2022-2023', '2023-2024', '2024-2025'];
    const heuresCM = [320, 350, 380, 360, 400];
    const heuresTD = [450, 480, 500, 520, 530];
    const heuresTP = [280, 300, 320, 350, 370];
    
    charts.evolution = new Chart(ctxEvolution, {
        type: 'line',
        data: {
            labels: annees,
            datasets: [
                {
                    label: 'CM',
                    data: heuresCM,
                    borderColor: '#2f0d73',
                    backgroundColor: 'rgba(47, 13, 115, 0.1)',
                    tension: 0.3,
                    fill: true
                },
                {
                    label: 'TD',
                    data: heuresTD,
                    borderColor: '#7c50de',
                    backgroundColor: 'rgba(124, 80, 222, 0.1)',
                    tension: 0.3,
                    fill: true
                },
                {
                    label: 'TP',
                    data: heuresTP,
                    borderColor: '#ac54c7',
                    backgroundColor: 'rgba(172, 84, 199, 0.1)',
                    tension: 0.3,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Nombre d\'heures'
                    }
                }
            }
        }
    });
    
    // 3. Graphique en barres - Répartition des heures par niveau
    // Données fictives pour l'exemple
    const niveaux = ['FIE1', 'FIE2', 'FIE3', 'FIE4', 'FIE5', 'FIA3', 'FIA5'];
    const heuresParNiveau = [
        {
            cm: 150,
            td: 200,
            tp: 150
        },
        {
            cm: 180,
            td: 230,
            tp: 170
        },
        {
            cm: 200,
            td: 250,
            tp: 200
        },
        {
            cm: 170,
            td: 220,
            tp: 180
        },
        {
            cm: 120,
            td: 180,
            tp: 150
        },
        {
            cm: 100,
            td: 120,
            tp: 100
        },
        {
            cm: 80,
            td: 100,
            tp: 80
        }
    ];
    
    const ctxNiveau = document.getElementById('heuresNiveauChart').getContext('2d');
    charts.niveaux = new Chart(ctxNiveau, {
        type: 'bar',
        data: {
            labels: niveaux,
            datasets: [
                {
                    label: 'CM',
                    data: heuresParNiveau.map(item => item.cm),
                    backgroundColor: '#2f0d73'
                },
                {
                    label: 'TD',
                    data: heuresParNiveau.map(item => item.td),
                    backgroundColor: '#7c50de'
                },
                {
                    label: 'TP',
                    data: heuresParNiveau.map(item => item.tp),
                    backgroundColor: '#ac54c7'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                x: {
                    stacked: false,
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Nombre d\'heures'
                    }
                }
            }
        }
    });
    
    // 4. Graphique en barres - Types d'heures par semestre
    const semestres = ['S1', 'S2', 'S3', 'S4', 'S5', 'S6', 'S7', 'S8', 'S9', 'S10'];
    const heuresParSemestre = [
        {
            cm: 120,
            td: 150,
            tp: 120
        },
        {
            cm: 130,
            td: 160,
            tp: 130
        },
        {
            cm: 140,
            td: 170,
            tp: 140
        },
        {
            cm: 150,
            td: 180,
            tp: 150
        },
        {
            cm: 160,
            td: 190,
            tp: 160
        },
        {
            cm: 150,
            td: 180,
            tp: 150
        },
        {
            cm: 140,
            td: 170,
            tp: 140
        },
        {
            cm: 130,
            td: 160,
            tp: 130
        },
        {
            cm: 120,
            td: 150,
            tp: 120
        },
        {
            cm: 110,
            td: 140,
            tp: 110
        }
    ];
    
    const ctxSemestre = document.getElementById('heuresSemestreChart').getContext('2d');
    charts.semestres = new Chart(ctxSemestre, {
        type: 'bar',
        data: {
            labels: semestres,
            datasets: [
                {
                    label: 'CM',
                    data: heuresParSemestre.map(item => item.cm),
                    backgroundColor: '#2f0d73'
                },
                {
                    label: 'TD',
                    data: heuresParSemestre.map(item => item.td),
                    backgroundColor: '#7c50de'
                },
                {
                    label: 'TP',
                    data: heuresParSemestre.map(item => item.tp),
                    backgroundColor: '#ac54c7'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                x: {
                    stacked: false,
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Nombre d\'heures'
                    }
                }
            }
        }
    });
}

// Sauvegarder les données du formulaire
function saveHeuresData() {
    // Récupérer les données du formulaire
    const annee_debut = $('#annee_debut').val();
    const annee_fin = $('#annee_fin').val();
    const niveau = $('#niveau').val();
    const semestre = $('#semestre').val();
    const ue_code = $('#ue_code').val();
    const ue_nom = $('#ue_nom').val();
    const matiere_nom = $('#matiere_nom').val();
    const ects = $('#ects').val();
    const intervenant = $('#intervenant').val();
    
    // Heures CM
    const cm_hm = $('#cm_hm').val();
    const cm_hp = $('#cm_hp').val();
    const cm_hr = $('#cm_hr').val();
    
    // Heures TD
    const td_hm = $('#td_hm').val();
    const td_hp = $('#td_hp').val();
    const td_hr = $('#td_hr').val();
    
    // Heures TP
    const tp_hm = $('#tp_hm').val();
    const tp_hp = $('#tp_hp').val();
    const tp_hr = $('#tp_hr').val();
    
    // Construire l'objet de données
    const data = {
        annee_debut: parseInt(annee_debut),
        annee_fin: parseInt(annee_fin),
        niveau: niveau,
        semestre: semestre,
        unite_enseignement: {
            code: ue_code,
            nom: ue_nom,
            matieres: [
                {
                    nom: matiere_nom,
                    ects: parseFloat(ects),
                    intervenant: intervenant,
                    heures_cm: {
                        hm: parseFloat(cm_hm),
                        hp: parseFloat(cm_hp),
                        hr: parseFloat(cm_hr)
                    },
                    heures_td: {
                        hm: parseFloat(td_hm),
                        hp: parseFloat(td_hp),
                        hr: parseFloat(td_hr)
                    },
                    heures_tp: {
                        hm: parseFloat(tp_hm),
                        hp: parseFloat(tp_hp),
                        hr: parseFloat(tp_hr)
                    }
                }
            ]
        }
    };
    
    // Envoyer les données à l'API
    $.ajax({
        url: `${API_BASE_URL}/heures-enseignement/form`,
        type: 'POST',
        data: JSON.stringify(data),
        contentType: 'application/json',
        headers: {
            'Authorization': `Bearer ${getApiToken()}`
        },
        success: function(response) {
            $('#addDataModal').modal('hide');
            showNotification('success', 'Données enregistrées avec succès!');
            
            // Actualiser les données
            loadHeuresEnseignementStats();
            loadHeuresEnseignement();
        },
        error: function(xhr) {
            let message = 'Erreur lors de l\'enregistrement des données';
            
            try {
                const response = JSON.parse(xhr.responseText);
                message = response.error || message;
            } catch (e) {}
            
            showNotification('error', message);
        }
    });
}

// Uploader un fichier CSV/Excel
function uploadHeuresFile() {
    // Récupérer le formulaire
    const form = $('#uploadForm')[0];
    const formData = new FormData(form);
    
    // Envoyer les données à l'API
    $.ajax({
        url: `${API_BASE_URL}/heures-enseignement/upload`,
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'Authorization': `Bearer ${getApiToken()}`
        },
        success: function(response) {
            $('#uploadCSVModal').modal('hide');
            showNotification('success', 'Fichier importé avec succès!');
            
            // Actualiser les données
            loadHeuresEnseignementStats();
            loadHeuresEnseignement();
        },
        error: function(xhr) {
            let message = 'Erreur lors de l\'importation du fichier';
            
            try {
                const response = JSON.parse(xhr.responseText);
                message = response.error || message;
            } catch (e) {}
            
            showNotification('error', message);
        }
    });
}

// Supprimer des données
function deleteHeuresData() {
    // Vérifier que les données de suppression sont définies
    if (!deleteData.annee_academique) {
        showNotification('error', 'Données de suppression incomplètes');
        return;
    }
    
    // Envoyer la requête de suppression
    $.ajax({
        url: `${API_BASE_URL}/heures-enseignement/delete`,
        type: 'DELETE',
        data: JSON.stringify(deleteData),
        contentType: 'application/json',
        headers: {
            'Authorization': `Bearer ${getApiToken()}`
        },
        success: function(response) {
            $('#deleteModal').modal('hide');
            showNotification('success', 'Données supprimées avec succès!');
            
            // Actualiser les données
            loadHeuresEnseignementStats();
            loadHeuresEnseignement();
        },
        error: function(xhr) {
            let message = 'Erreur lors de la suppression des données';
            
            try {
                const response = JSON.parse(xhr.responseText);
                message = response.error || message;
            } catch (e) {}
            
            showNotification('error', message);
        }
    });
}

// Fonction pour éditer les données (remplir le formulaire)
function editHeuresData(anneeAcademique, niveau, semestre, ueCode, matiere) {
    // Récupérer les données détaillées
    $.ajax({
        url: `${API_BASE_URL}/heures-enseignement?annee_academique=${anneeAcademique}&niveau=${niveau}&semestre=${semestre}`,
        type: 'GET',
        headers: {
            'Authorization': `Bearer ${getApiToken()}`
        },
        success: function(response) {
            // Trouver l'UE et la matière correspondantes
            const record = response.find(r => r.unite_enseignement.code === ueCode);
            
            if (record) {
                const ue = record.unite_enseignement;
                const matiereObj = ue.matieres.find(m => m.nom === matiere);
                
                if (matiereObj) {
                    // Extraire l'année de début et de fin
                    const [anneeDebut, anneeFin] = anneeAcademique.split('-');
                    
                    // Remplir le formulaire
                    $('#annee_debut').val(anneeDebut);
                    $('#annee_fin').val(anneeFin);
                    $('#niveau').val(niveau);
                    $('#semestre').val(semestre);
                    $('#ue_code').val(ue.code);
                    $('#ue_nom').val(ue.nom);
                    $('#matiere_nom').val(matiereObj.nom);
                    $('#ects').val(matiereObj.ects || 0);
                    $('#intervenant').val(matiereObj.intervenant || '');
                    
                    // Heures CM
                    $('#cm_hm').val(matiereObj.heures_cm.hm || 0);
                    $('#cm_hp').val(matiereObj.heures_cm.hp || 0);
                    $('#cm_hr').val(matiereObj.heures_cm.hr || 0);
                    
                    // Heures TD
                    $('#td_hm').val(matiereObj.heures_td.hm || 0);
                    $('#td_hp').val(matiereObj.heures_td.hp || 0);
                    $('#td_hr').val(matiereObj.heures_td.hr || 0);
                    
                    // Heures TP
                    $('#tp_hm').val(matiereObj.heures_tp.hm || 0);
                    $('#tp_hp').val(matiereObj.heures_tp.hp || 0);
                    $('#tp_hr').val(matiereObj.heures_tp.hr || 0);
                    
                    // Mettre à jour le titre du modal
                    $('#addDataModalTitle').text('Modifier des heures d\'enseignement');
                    
                    // Afficher le modal
                    $('#addDataModal').modal('show');
                } else {
                    showNotification('error', 'Matière non trouvée');
                }
            } else {
                showNotification('error', 'UE non trouvée');
            }
        },
        error: function(xhr) {
            showNotification('error', 'Erreur lors de la récupération des données à éditer');
        }
    });
}

// Fonction pour préparer la suppression
function prepareDelete(anneeAcademique, niveau, semestre, ueCode) {
    // Stocker les données de suppression
    deleteData = {
        annee_academique: anneeAcademique,
        niveau: niveau,
        semestre: semestre,
        code_ue: ueCode
    };
    
    // Préparer les détails pour l'affichage
    let details = `
        <ul class="list-group mt-3 mb-3">
            <li class="list-group-item d-flex justify-content-between align-items-center">
                Année académique
                <span class="badge badge-primary badge-pill">${anneeAcademique}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                Niveau
                <span class="badge badge-primary badge-pill">${niveau}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                Semestre
                <span class="badge badge-primary badge-pill">${semestre}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                Code UE
                <span class="badge badge-primary badge-pill">${ueCode}</span>
            </li>
        </ul>
    `;
    
    // Mettre à jour le modal
    $('#deleteDetails').html(details);
    
    // Afficher le modal
    $('#deleteModal').modal('show');
}

// Actualiser tous les graphiques
function refreshAllCharts() {
    loadHeuresEnseignementStats();
    loadHeuresEnseignement();
    showNotification('success', 'Données actualisées!');
}

// Événements pour les boutons d'édition et de suppression dans le tableau
$(document).on('click', '.edit-btn', function() {
    const anneeAcademique = $(this).data('annee');
    const niveau = $(this).data('niveau');
    const semestre = $(this).data('semestre');
    const ueCode = $(this).data('ue');
    const matiere = $(this).data('matiere');
    
    editHeuresData(anneeAcademique, niveau, semestre, ueCode, matiere);
});

$(document).on('click', '.delete-btn', function() {
    const anneeAcademique = $(this).data('annee');
    const niveau = $(this).data('niveau');
    const semestre = $(this).data('semestre');
    const ueCode = $(this).data('ue');
    
    prepareDelete(anneeAcademique, niveau, semestre, ueCode);
});

// Réinitialiser le formulaire quand on ferme le modal
$('#addDataModal').on('hidden.bs.modal', function () {
    $('#addDataModalTitle').text('Ajouter des heures d\'enseignement');
    $('#heuresForm')[0].reset();
});

// Réinitialiser le formulaire d'upload quand on ferme le modal
$('#uploadCSVModal').on('hidden.bs.modal', function () {
    $('#uploadForm')[0].reset();
    $('.custom-file-label').text('Choisir un fichier...');
});

// Fonction pour afficher une notification
function showNotification(type, message) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const iconClass = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
    
    const notification = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;">
            <i class="fas ${iconClass} mr-2"></i>
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    `;
    
    $('body').append(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        $('.alert').fadeOut('slow', function() {
            $(this).remove();
        });
    }, 2000);
}
</script>
{% endblock %}