{% extends 'statistiques/base.html' %}

{% block title %}Liste des Étudiants{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css">
<style>
    .header-custom {
        background: linear-gradient(135deg, #2f0d73 0%, #7c50de 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    
    .filter-container {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    
    .btn-primary-custom {
        background: linear-gradient(135deg, #2f0d73 0%, #7c50de 100%);
        border: none;
        color: white;
    }
    
    .btn-primary-custom:hover {
        background: linear-gradient(135deg, #7c50de 0%, #ac54c7 100%);
        color: white;
    }
    .header-custom {
        background: linear-gradient(135deg, #2f0d73 0%, #7c50de 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    
    .filter-container {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    
    .btn-primary-custom {
        background: linear-gradient(135deg, #2f0d73 0%, #7c50de 100%);
        border: none;
        color: white;
    }
    
    .btn-primary-custom:hover {
        background: linear-gradient(135deg, #7c50de 0%, #ac54c7 100%);
        color: white;
    }
    
    /* Ajoutez ces styles pour les graphiques */
    .card {
        border-radius: 10px;
        overflow: hidden;
        transition: transform 0.3s;
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .card-header {
        background: linear-gradient(135deg, #2f0d73 0%, #7c50de 100%);
        color: white;
    }
    
    canvas {
        max-width: 100%;
    }
    .modal-header {
    background: linear-gradient(135deg, #2f0d73 0%, #7c50de 100%);
    color: white;
    border-bottom: none;
    border-radius: 10px 10px 0 0;
     }

     .modal-content {
    border: none;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(47, 13, 115, 0.2);
     }

     .modal-footer {
    border-top: none;
    background-color: #f8f9fa;
    border-radius: 0 0 10px 10px;
     }

     /* Boutons dans les couleurs de la charte */
     .btn-primary {
    background: #2f0d73;
    border-color: #2f0d73;
      }

     .btn-primary:hover {
    background: #7c50de;
    border-color: #7c50de;
     }

     .btn-success {
    background: #3cbebe; /* La couleur turquoise de votre charte */
    border-color: #3cbebe;
     }

     .btn-success:hover {
    background: #60d0d0;
    border-color: #60d0d0;
     }

     .btn-danger {
    background: #f5696d; /* La couleur rouge de votre charte */
    border-color: #f5696d;
     }

     .btn-danger:hover {
    background: #ff7c80;
    border-color: #ff7c80;
     }

     /* Design pour les formulaires */
     .form-control:focus {
    border-color: #7c50de;
    box-shadow: 0 0 0 0.2rem rgba(124, 80, 222, 0.25);
      }

     /* Custom file input */
     .custom-file-label::after {
     background-color: #2f0d73;
    color: white;
       }

     /* Animations pour les modals */
     .modal.fade .modal-dialog {
    transform: scale(0.8);
    transition: transform 0.3s ease;
     }

     .modal.show .modal-dialog {
    transform: scale(1);
      }

     /* Style pour la pagination DataTables */
     .page-item.active .page-link {
    background-color: #2f0d73;
    border-color: #2f0d73;
     }

    .page-link {
    color: #2f0d73;
     }

     .page-link:hover {
    color: #7c50de;
     }

     /* Couleurs pour les notifications */
     .alert-success {
    background-color: rgba(60, 190, 190, 0.2);
    border-color: #3cbebe;
    color: #2a8a8a;
     }

     .alert-danger {
    background-color: rgba(245, 105, 109, 0.2);
    border-color: #f5696d;
    color: #c54548;
     }
     #etudiantsTable {
    border-collapse: separate;
    border-spacing: 0;
     }

      #etudiantsTable thead th {
    background-color: #2f0d73;
    color: white;
    border: none;
    padding: 12px 15px;
    font-weight: 500;
      }

     #etudiantsTable thead th:first-child {
    border-radius: 10px 0 0 0;
     }

     #etudiantsTable thead th:last-child {
    border-radius: 0 10px 0 0;
     }

     #etudiantsTable tbody tr {
    transition: all 0.2s ease;
     }

    #etudiantsTable tbody tr:hover {
    background-color: rgba(124, 80, 222, 0.1);
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
     }

     #etudiantsTable tbody td {
    padding: 12px 15px;
    vertical-align: middle;
     }

     /* Pagination améliorée */
     .dataTables_paginate {
    margin-top: 15px !important;
     }

     .dataTables_paginate .paginate_button {
    margin: 0 3px;
    border-radius: 4px;
    transition: all 0.2s ease;
     }

     .dataTables_paginate .paginate_button.current {
    background: linear-gradient(135deg, #2f0d73 0%, #7c50de 100%) !important;
    border: none !important;
    color: white !important;
     }

     .dataTables_paginate .paginate_button:hover {
    background: rgba(124, 80, 222, 0.2) !important;
    border: 1px solid #7c50de !important;
     }

     /* Badge pour les statuts (boursiers, etc) */
     .badge-boursier {
    background-color: #3cbebe;
    color: white;
    padding: 5px 8px;
    border-radius: 20px;
    font-weight: 500;
     }

     .badge-non-boursier {
    background-color: #f5696d;
    color: white;
    padding: 5px 8px;
    border-radius: 20px;
    font-weight: 500;
     }

     /* Info-bulles améliorées */
     .tooltip-inner {
    background-color: #2f0d73;
    border-radius: 4px;
    padding: 8px 12px;
     }

     .tooltip.bs-tooltip-top .arrow::before {
    border-top-color: #2f0d73;
     }
     .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    transition: opacity 0.5s ease;
     }

     .loading-spinner {
    width: 50px;
    height: 50px;
    border: 5px solid rgba(124, 80, 222, 0.2);
    border-radius: 50%;
    border-top: 5px solid #2f0d73;
    animation: spin 1s linear infinite;
     }

     @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
     }

    /* Animations d'entrée pour les graphiques */
     .chart-container {
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.5s ease;
     }

     .chart-container.visible {
    opacity: 1;
    transform: translateY(0);
     }

     /* Animation pour les notifications */
     @keyframes slideDown {
    from {
        transform: translateY(-50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
     } 

     .alert {
    animation: slideDown 0.3s ease forwards;
     }
     .card-header select.form-control-sm {
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
    transition: all 0.3s;
      }

     .card-header select.form-control-sm:hover, 
     .card-header select.form-control-sm:focus {
    background-color: rgba(255, 255, 255, 0.3);
    box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.5);
     }

     .card-header select.form-control-sm option {
    background-color: #2f0d73;
    color: white;
      }
</style>
{% endblock %}

{% block content %}
<!-- En-tête -->
<div class="header-custom">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1><i class="fas fa-users mr-3"></i>Liste des Étudiants</h1>
            <p class="mb-0">Affichage des étudiants existants dans la base de données</p>
        </div>
        <div>
            <button class="btn btn-success btn-lg mr-2" data-toggle="modal" data-target="#uploadCSVModal">
                <i class="fas fa-file-upload mr-2"></i>Importer CSV
            </button>
            <button class="btn btn-primary btn-lg mr-2" id="addNewBtn">
                <i class="fas fa-plus mr-2"></i>Ajouter un étudiant
            </button>
            <button class="btn btn-warning btn-lg" onclick="window.location.reload()">
                <i class="fas fa-sync mr-2"></i>Actualiser
            </button>
        </div>
    </div>
</div>

<!-- Messages d'alerte -->
<div class="alert-container mb-4">
    {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        {% endfor %}
    {% endif %}
</div>

<!-- Ajoutez ce bloc après la table des étudiants -->
<div class="row mt-4">
    <div class="col-12">
        <h3 class="mb-4"><i class="fas fa-chart-bar mr-2"></i>Visualisations des données</h3>
    </div>
</div>
<div class="modal fade" id="addDataModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addDataModalTitle">Ajouter un étudiant</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="dataForm" method="post" action="{% url 'update_data' %}">
                {% csrf_token %}
                <input type="hidden" name="source" value="effectifs">
                <input type="hidden" name="id" id="etudiantId">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Nom <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="Nom" id="nom" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Prénom <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="Prénom" id="prenom" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Genre <span class="text-danger">*</span></label>
                                <select class="form-control" name="Genre" id="genre" required>
                                    <option value="">Sélectionner...</option>
                                    <option value="Masculin">Masculin</option>
                                    <option value="Féminin">Féminin</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Niveau <span class="text-danger">*</span></label>
                                <select class="form-control" name="niveau" id="niveau" required>
                                    <option value="">Sélectionner...</option>
                                    <option value="FIE1">FIE1</option>
                                    <option value="FIE2">FIE2</option>
                                    <option value="FIE3">FIE3</option>
                                    <option value="FIE4">FIE4</option>
                                    <option value="FIE5">FIE5</option>
                                    <option value="FIA3">FIA3</option>
                                    <option value="FIA4">FIA4</option>
                                    <option value="FIA5">FIA5</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Année académique <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="annee" id="annee" required placeholder="2024-2025">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Nationalité <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="Nationalité" id="nationalite" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Boursier(ère)</label>
                                <select class="form-control" name="Boursier(ère)" id="boursier">
                                    <option value="Non">Non</option>
                                    <option value="Oui">Oui</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Étranger(ère)</label>
                                <select class="form-control" name="Etranger(ère)" id="etranger">
                                    <option value="Non">Non</option>
                                    <option value="Oui">Oui</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Pays</label>
                                <input type="text" class="form-control" name="Pays" id="pays">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Téléphone</label>
                                <input type="tel" class="form-control" name="tél" id="tel">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" class="form-control" name="mail" id="mail">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Établissement précédent</label>
                                <input type="text" class="form-control" name="Etablissement" id="etablissement">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save mr-1"></i>Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="uploadCSVModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-file-csv mr-2"></i>Importer un fichier CSV</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="uploadForm" method="post" enctype="multipart/form-data" action="{% url 'upload_csv_etudiants' %}">
                {% csrf_token %}
                <input type="hidden" name="source" value="effectifs">
                <div class="modal-body">
                    <div class="form-group">
                        <label><i class="fas fa-upload mr-1"></i>Fichier CSV <span class="text-danger">*</span></label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="csvFile" name="file" accept=".csv" required>
                            <label class="custom-file-label" for="csvFile">Choisir un fichier...</label>
                        </div>
                        <small class="form-text text-muted">Format accepté: .csv uniquement</small>
                    </div>
                    <div class="alert alert-info">
                        <h6 class="alert-heading"><i class="fas fa-info-circle mr-2"></i>Format attendu du fichier CSV</h6>
                        <p class="mb-0">Le système accepte les fichiers CSV contenant les données individuelles des étudiants avec les colonnes suivantes:</p>
                        <div class="mt-2 p-2 bg-light rounded">
                            <code>Nom,Prénom,Genre,Date de naissance,Nationalité,Unnamed:6,Etranger(ère),Boursier(ère),Adresse fixe,Code postal,Ville,Pays,Formation,...</code>
                        </div>
                        <hr>
                        <p class="mb-0"><strong>Note:</strong> Le système détectera automatiquement les informations pertinentes comme le niveau (FIE1, FIE2, FIE3), le genre, et si l'étudiant est boursier ou étranger.</p>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-tag mr-1"></i>Nom du fichier</label>
                        <input type="text" class="form-control" name="name" placeholder="Effectifs 2025" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-align-left mr-1"></i>Description (optionnel)</label>
                        <textarea class="form-control" name="description" rows="3" 
                                  placeholder="Description du fichier importé..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload mr-1"></i>Importer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Modal de confirmation de suppression -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-trash mr-2"></i>Confirmer la suppression</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir supprimer l'étudiant <span id="deleteYear" class="font-weight-bold"></span> ?</p>
                <p class="text-danger mb-0"><small>Cette action est irréversible.</small></p>
                <input type="hidden" id="deleteId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                    <i class="fas fa-trash mr-1"></i>Supprimer
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Graphiques principaux en 2 colonnes -->
<div class="row">
    <!-- Évolution du nombre total d'étudiants par année -->
    <div class="col-md-6 mb-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Évolution des effectifs par année</h5>
            </div>
            <div class="card-body">
                <canvas id="evolutionChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Taux de boursiers par année -->
    <div class="col-md-6 mb-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Répartition des boursiers</h5>
                <select id="boursierAnneeSelect" class="form-control form-control-sm" style="width: auto;">
                    <option value="">Toutes les années</option>
                    <!-- Les options seront remplies dynamiquement -->
                </select>
            </div>
            <div class="card-body">
                <canvas id="boursiersPieChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Deuxième rangée de graphiques -->
<div class="row">
    <!-- Nombre d'étudiants par niveau (par année) -->
    <div class="col-md-6 mb-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Nombre d'étudiants par niveau</h5>
                <select id="niveauAnneeSelect" class="form-control form-control-sm" style="width: auto;">
                    <option value="">Toutes les années</option>
                    <!-- Les options seront remplies dynamiquement -->
                </select>
            </div>
            <div class="card-body">
                <canvas id="niveauxBarChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Répartition par nationalité -->
    <div class="col-md-6 mb-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Répartition par nationalité</h5>
            </div>
            <div class="card-body">
                <canvas id="nationalitePieChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>
<!-- Troisième rangée de graphiques -->
<div class="row">
    <!-- Répartition par genre (donut chart) -->
    <div class="col-md-6 mb-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Répartition par genre (étudiants uniques)</h5>
                <select id="genreDonutAnneeSelect" class="form-control form-control-sm" style="width: auto;">
                    <option value="">Toutes les années</option>
                    <!-- Les options seront remplies dynamiquement -->
                </select>
            </div>
            <div class="card-body">
                <canvas id="genreDonutChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Nationalités étrangères par niveau -->
    <div class="col-md-6 mb-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Répartition des étudiants étrangers par niveau</h5>
                <select id="etrangersBarAnneeSelect" class="form-control form-control-sm" style="width: auto;">
                    <option value="">Toutes les années</option>
                    <!-- Les options seront remplies dynamiquement -->
                </select>
            </div>
            <div class="card-body">
                <canvas id="etrangersBarChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>
<!-- Graphique 2: Répartition des diplômés par niveau -->
    <div class="col-md-6 mb-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Répartition des diplômés par niveau</h5>
            </div>
            <div class="card-body">
                <canvas id="diplomesNiveauChart" height="300"></canvas>
            </div>
        </div>
    </div>
<!-- Filtres -->
<div class="filter-container">
    <h5><i class="fas fa-filter mr-2"></i>Filtres</h5>
    <div class="row">
        <div class="col-md-4">
            <div class="form-group">
                <label for="anneeFilter">Année académique:</label>
                <select class="form-control" id="anneeFilter">
                    <option value="">Toutes les années</option>
                    {% for annee in annees %}
                    <option value="{{ annee }}">{{ annee }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
         <div class="col-md-4">
            <div class="form-group">
                <label for="niveauFilter">Niveau:</label>
                <select class="form-control" id="niveauFilter">
                    <option value="">Tous les niveaux</option>
                    {% for niveau in niveaux %}
                    <option value="{{ niveau }}">{{ niveau }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="col-md-4">
            <div class="form-group">
                <label for="genreFilter">Genre:</label>
                <select class="form-control" id="genreFilter">
                    <option value="">Tous les genres</option>
                    <option value="Masculin">Masculin</option>
                    <option value="Féminin">Féminin</option>
                </select>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12 text-right">
            <button class="btn btn-primary-custom" id="applyFilters">
                <i class="fas fa-search mr-2"></i>Appliquer les filtres
            </button>
            <button class="btn btn-secondary" id="resetFilters">
                <i class="fas fa-undo mr-2"></i>Réinitialiser
            </button>
        </div>
    </div>
</div>

<!-- Tableau des étudiants -->
<div class="card">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="fas fa-table mr-2"></i>Liste des étudiants</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="etudiantsTable">
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Prénom</th>
                        <th>Genre</th>
                        <th>Niveau</th>
                        <th>Année</th>
                        <th>Nationalité</th>
                        <th>Boursier</th>
                        <th>Téléphone</th>
                        <th>Email</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Les données seront chargées par JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>
<!-- Tableau des diplômés -->
<div class="card mt-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="fas fa-graduation-cap mr-2"></i>Liste des étudiants diplômés</h5>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-4">
                <div class="form-group">
                    <label for="diplomesFilter">Filtrer par niveau:</label>
                    <select class="form-control" id="diplomesFilter">
                        <option value="">Tous les diplômés</option>
                        <option value="FIE5">Diplômés FIE5</option>
                        <option value="FIA5">Diplômés FIA5</option>
                    </select>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="diplomesAnneeFilter">Année de diplôme:</label>
                    <select class="form-control" id="diplomesAnneeFilter">
                        <option value="">Toutes les années</option>
                        <!-- Options générées dynamiquement -->
                    </select>
                </div>
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button class="btn btn-primary-custom w-100" id="applyDiplomesFilters">
                    <i class="fas fa-search mr-2"></i>Appliquer les filtres
                </button>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="diplomesTable">
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Prénom</th>
                        <th>Genre</th>
                        <th>Niveau</th>
                        <th>Année</th>
                        <th>Nationalité</th>
                        <th>Boursier</th>
                        
                    </tr>
                </thead>
                <tbody>
                    <!-- Les données seront chargées par JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- DataTables JS -->
<script type="text/javascript" src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

<script>
// Variables globales
let dataTable;
let etudiants = [];
let charts = {};
let diplomesTable;
let diplomes = [];
let diplomesCharts = {};

// Définir les couleurs pour respecter la charte graphique
const chartColors = {
    primary: [
        'rgba(47, 13, 115, 0.8)',  // Violet foncé
        'rgba(124, 80, 222, 0.8)', // Violet clair
        'rgba(172, 84, 199, 0.8)',  // Mauve
        'rgba(199, 84, 172, 0.8)',  // Rose
        'rgba(222, 80, 124, 0.8)',  // Rose foncé
    ],
    secondary: [
        'rgba(33, 150, 243, 0.8)', // Bleu
        'rgba(0, 188, 212, 0.8)',  // Cyan
        'rgba(76, 175, 80, 0.8)',  // Vert
        'rgba(255, 152, 0, 0.8)',  // Orange
        'rgba(255, 87, 34, 0.8)',  // Orange foncé
    ],
    borders: [
        'rgba(47, 13, 115, 1)',    // Violet foncé
        'rgba(124, 80, 222, 1)',   // Violet clair
        'rgba(172, 84, 199, 1)',   // Mauve
        'rgba(199, 84, 172, 1)',   // Rose
        'rgba(222, 80, 124, 1)',   // Rose foncé
        'rgba(33, 150, 243, 1)',   // Bleu
        'rgba(0, 188, 212, 1)',    // Cyan
        'rgba(76, 175, 80, 1)',    // Vert
        'rgba(255, 152, 0, 1)',    // Orange
        'rgba(255, 87, 34, 1)',    // Orange foncé
    ]
};

$(document).ready(function() {
    // Log pour déboguer l'URL de l'API
    console.log("URL de l'API:", "{{ api_url }}");
    
    // Récupérer les données depuis la variable Django
    try {
        // Récupérer et parser les données JSON
        etudiants = JSON.parse('{{ etudiants|escapejs }}');
        console.log("Données étudiants chargées:", etudiants);
        // Séparer les étudiants normaux et les diplômés
        diplomes = extractDiplomes(etudiants);
        const nonDiplomes = filterNonDiplomes(etudiants);
        console.log("Nombre d'étudiants:", etudiants.length);
        etudiants = nonDiplomes;
        // Afficher les propriétés du premier étudiant pour débogage
        if (etudiants.length > 0) {
            console.log("Premier étudiant:", etudiants[0]);
            console.log("Propriétés disponibles:", Object.keys(etudiants[0]));
        }
        if (diplomes.length > 0) {
        // Si vous avez une fonction qui initialise tous les graphiques
        initializeDiplomesCharts();
        
        // Ou appelez directement la fonction spécifique
        // initializeDiplomesNiveauChart();
          }
        // Initialiser DataTable avec les données
        initializeDataTable();
        
        // Initialiser les graphiques
        initializeCharts();
        
        // Remplir les sélecteurs d'années
        populateYearSelectors();
        initializeAnimations();
        
        // Gestionnaire pour le filtre
        $('#applyFilters').click(function() {
            applyFilters();
        });
        
        // Gestionnaire pour la réinitialisation des filtres
        $('#resetFilters').click(function() {
            $('#anneeFilter').val('');
            $('#niveauFilter').val('');
            $('#genreFilter').val('');
            applyFilters();
        });

        $('#addNewBtn').click(function() {
        // Réinitialiser le formulaire
        $('#dataForm')[0].reset();
        $('#etudiantId').val('');
    
        // Changer le titre du modal
        $('#addDataModalTitle').text('Ajouter un étudiant');
    
        // Afficher le modal
        $('#addDataModal').modal('show');
        });

        // Gestionnaire pour le fichier CSV
        $('#csvFile').on('change', function() {
         const fileName = $(this).val().split('\\').pop();
        $(this).next('.custom-file-label').html(fileName || 'Choisir un fichier...');
        });

        // Gestionnaires pour les sélecteurs d'années des graphiques
        $('#boursierAnneeSelect').change(function() {
            updateBoursiersPieChart($(this).val());
        });
        
        $('#niveauAnneeSelect').change(function() {
            updateNiveauxBarChart($(this).val());
        });
    } catch (e) {
        console.error("Erreur lors du chargement des données:", e);
        // Afficher un message d'erreur dans le tableau
        $('#etudiantsTable tbody').html(`
            <tr>
                <td colspan="9" class="text-center">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Erreur lors du chargement des données: ${e.message}
                    </div>
                </td>
            </tr>
        `);
    }

    // Soumission du formulaire de données via AJAX
    $('#dataForm').on('submit', function(e) {
        e.preventDefault();
        
        // Afficher un indicateur de chargement
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.html('<i class="fas fa-spinner fa-spin mr-1"></i>Enregistrement...').prop('disabled', true);
        
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: $(this).serialize(),
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                $('#addDataModal').modal('hide');
                showNotification('success', 'Données enregistrées avec succès !');
                
                // Redirection vers la même page après un court délai
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            },
            error: function(xhr, status, error) {
                console.error("Erreur AJAX:", xhr.responseText);
                try {
                    const response = JSON.parse(xhr.responseText);
                    showNotification('error', response.message || response.error || 'Erreur lors de l\'enregistrement des données.');
                } catch (e) {
                    showNotification('error', 'Erreur lors de l\'enregistrement des données.');
                }
            },
            complete: function() {
                // Restaurer le bouton
                submitBtn.html(originalText).prop('disabled', false);
            }
        });
    });

    // Soumission du formulaire CSV via AJAX
    $('#uploadForm').on('submit', function(e) {
        e.preventDefault();
        
        // Afficher un indicateur de chargement
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.html('<i class="fas fa-spinner fa-spin mr-1"></i>Importation...').prop('disabled', true);
        
        let formData = new FormData(this);
        
        $.ajax({
            url: "{% url 'upload_csv_etudiants' %}",
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                $('#uploadCSVModal').modal('hide');
                showNotification('success', 'Fichier CSV importé avec succès !');
                
                // Redirection vers la même page après un court délai
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            },
            error: function(xhr, status, error) {
                console.error("Erreur AJAX:", xhr.responseText);
                try {
                    const response = JSON.parse(xhr.responseText);
                    showNotification('error', response.message || response.error || 'Erreur lors de l\'importation du fichier CSV.');
                } catch (e) {
                    showNotification('error', 'Erreur lors de l\'importation du fichier CSV.');
                }
            },
            complete: function() {
                // Restaurer le bouton
                submitBtn.html(originalText).prop('disabled', false);
            }
        });
    });
    // Initialiser le tableau des diplômés
    initializeDiplomesTable();
    loadDiplomesTableData(diplomes);
    
    // Remplir le sélecteur d'années pour les diplômés
    populateDiplomeYearSelector();
    
    // Gestionnaire pour le filtre des diplômés
    $('#applyDiplomesFilters').click(function() {
        applyDiplomesFilters();
    });
    
    // Réinitialiser les filtres des diplômés
    $('#resetDiplomesFilters').click(function() {
        $('#diplomesFilter').val('');
        $('#diplomesAnneeFilter').val('');
        applyDiplomesFilters();
    });
});
function initializeDiplomesCharts() {
    initializeDiplomesNiveauChart();
    // Autres initialisations de graphiques...
}
// Fonction pour initialiser DataTable
function initializeDataTable() {
    // Vérifier si les données sont disponibles
    if (!etudiants || etudiants.length === 0) {
        $('#etudiantsTable tbody').html(`
            <tr>
                <td colspan="10" class="text-center">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Aucune donnée disponible. Veuillez ajouter des étudiants ou vérifier la connexion à l'API.
                    </div>
                </td>
            </tr>
        `);
        return;
    }
    
    // Fonction de tri personnalisée pour les niveaux
    $.fn.dataTable.ext.type.order['niveau-pre'] = function(data) {
        // Ordre des niveaux
        const niveauOrder = {
            'FIE1': 1, 'FIE2': 2, 'FIE3': 3, 'FIE4': 4, 'FIE5': 5,
            'FIA3': 6, 'FIA4': 7, 'FIA5': 8
        };
        
        // Extraire le niveau du badge HTML
        const match = data.match(/badge[^>]+>([^<]+)</);
        const niveau = match ? match[1] : '';
        
        return niveauOrder[niveau] || 999;
    };
    
    // Fonction de tri personnalisée pour les années académiques
    $.fn.dataTable.ext.type.order['annee-pre'] = function(data) {
        // Extraire l'année de début (par exemple "2021" de "2021-2022")
        const match = data.match(/(\d{4})/);
        if (match) {
            return parseInt(match[1], 10);
        }
        return 0; // Valeur par défaut si le format n'est pas reconnu
    };
    
    // Initialiser DataTable
    dataTable = $('#etudiantsTable').DataTable({
        language: {
            url: "//cdn.datatables.net/plug-ins/1.10.25/i18n/French.json"
        },
        responsive: true,
        paging: true,
        pageLength: 6,
        pagingType: "full_numbers",
        ordering: true,
        searching: true,
        info: true,
        lengthChange: true,
        lengthMenu: [[6, 12, 24, 48, -1], [6, 12, 24, 48, "Tous"]],
        dom: '<"top"lf>rt<"bottom"ip>',
        columnDefs: [
            {
                orderDataType: "niveau-pre",
                targets: 3
            },
            {
                orderDataType: "annee-pre",
                targets: 4
            },
            { orderable: false, targets: 9 }
        ],
        order: [
            [3, 'asc'],  // Trier d'abord par niveau (colonne 3)
            [4, 'desc'], // Puis par année décroissante (colonne 4)
            [0, 'asc']   // Enfin par nom (colonne 0)
        ]
    });
    
    // Remplir le tableau avec les données
    loadTableData(etudiants);
}

// Fonction pour charger les données dans le tableau
function loadTableData(data) {
    // Vider le tableau si déjà initialisé
    if (dataTable) {
        dataTable.clear();
    }
    
    // Ajouter chaque étudiant au tableau
    data.forEach(function(etudiant) {
        // Corriger les noms de champs pour correspondre à ceux de MongoDB
        // Utiliser des valeurs par défaut pour les champs qui pourraient être manquants
        const nom = etudiant.Nom || '';
        const prenom = etudiant.Prénom || '';
        const genre = etudiant.Genre || '';
        const niveau = etudiant.niveau || '';
        const annee = etudiant.annee || '';
        const nationalite = etudiant.Nationalité || '';
        // Gérer les différentes façons dont le champ Boursier pourrait être nommé
        const boursier = etudiant['Boursier(ère)'] || etudiant.Boursier || 'Non';
        // Gérer les différentes façons dont le téléphone pourrait être nommé
        const tel = etudiant.tél || etudiant.tel || '';
        const mail = etudiant.mail || etudiant.email || '';
        // Créer un badge pour le statut boursier
        let boursierBadge = '';
        if (boursier.toLowerCase() === 'oui') {
            boursierBadge = `<span class="badge badge-boursier">Boursier</span>`;
        } else {
            boursierBadge = `<span class="badge badge-non-boursier">Non-boursier</span>`;
        }
        // Créer les boutons d'action
        const actionsHtml = `
    <div class="btn-group btn-group-sm">
        <button type="button" class="btn btn-primary btn-sm edit-btn" data-id="${etudiant.id || ''}" data-nom="${nom}" data-prenom="${prenom}">
            <i class="fas fa-edit"></i>
        </button>
        <button type="button" class="btn btn-danger btn-sm delete-btn" data-id="${etudiant.id || ''}" data-nom="${nom}" data-prenom="${prenom}">
            <i class="fas fa-trash"></i>
        </button>
    </div>
`;

        // Ajouter la ligne au tableau avec des cellules améliorées
         {
            dataTable.row.add([
                `<span class="font-weight-bold">${nom}</span>`, 
                prenom, 
                genre === 'Masculin' ? `<i class="fas fa-mars text-primary mr-1"></i> ${genre}` : 
                                    `<i class="fas fa-venus text-danger mr-1"></i> ${genre}`, 
                `<span class="badge badge-primary">${niveau}</span>`, 
                annee, 
                `<span>${nationalite}</span>`, 
                boursierBadge, 
                tel ? `<a href="tel:${tel}" class="text-primary"><i class="fas fa-phone-alt mr-1"></i>${tel}</a>` : '', 
                mail ? `<a href="mailto:${mail}" class="text-primary"><i class="fas fa-envelope mr-1"></i>${mail}</a>` : '',
                actionsHtml
            ]);
        }
    });
    
    // Redessiner le tableau avec les nouvelles données
    if (dataTable) {
        dataTable.draw();
        // Initialiser les tooltips après avoir dessiné le tableau
        $('[data-toggle="tooltip"]').tooltip();
    }
}

// Fonction pour appliquer les filtres
function applyFilters() {
    const anneeFilter = $('#anneeFilter').val();
    const niveauFilter = $('#niveauFilter').val();
    const genreFilter = $('#genreFilter').val();
    
    // Filtrer les données
    let filteredData = etudiants.filter(function(etudiant) {
        let matchAnnee = true;
        let matchNiveau = true;
        let matchGenre = true;
        
        if (anneeFilter && etudiant.annee !== anneeFilter) {
            matchAnnee = false;
        }
        
        if (niveauFilter && etudiant.niveau !== niveauFilter) {
            matchNiveau = false;
        }
        
        if (genreFilter && etudiant.Genre !== genreFilter) {
            matchGenre = false;
        }
        
        return matchAnnee && matchNiveau && matchGenre;
    });
    
    // Mettre à jour le tableau avec les données filtrées
    loadTableData(filteredData);
}
// Fonction pour obtenir les années uniques des étudiants
function getUniqueYears() {
    const years = [];
    etudiants.forEach(function(etudiant) {
        if (etudiant.annee && !years.includes(etudiant.annee)) {
            years.push(etudiant.annee);
        }
    });
    return years.sort();
}

// Fonction pour obtenir les niveaux uniques des étudiants
function getUniqueNiveaux() {
    const niveaux = [];
    etudiants.forEach(function(etudiant) {
        if (etudiant.niveau && !niveaux.includes(etudiant.niveau)) {
            niveaux.push(etudiant.niveau);
        }
    });
    return niveaux.sort();
}

// Fonction pour obtenir les nationalités uniques des étudiants
function getUniqueNationalites() {
    const nationalites = [];
    etudiants.forEach(function(etudiant) {
        if (etudiant.Nationalité && !nationalites.includes(etudiant.Nationalité)) {
            nationalites.push(etudiant.Nationalité);
        }
    });
    return nationalites.sort();
}

// Fonction pour remplir les sélecteurs d'années
function populateYearSelectors() {
    const years = getUniqueYears();
    
    // Remplir tous les sélecteurs d'années
    const selectors = [
        $('#boursierAnneeSelect'),
        $('#niveauAnneeSelect'),
        $('#genreDonutAnneeSelect'),
        $('#etrangersBarAnneeSelect')
    ];
    
    selectors.forEach(selector => {
        // Vider d'abord le sélecteur sauf l'option par défaut
        selector.find('option:not(:first)').remove();
        
        // Ajouter les années dans l'ordre décroissant (plus récent en premier)
        years.sort((a, b) => {
            // Extraire les années de début pour le tri
            const yearA = parseInt(a.split('-')[0]);
            const yearB = parseInt(b.split('-')[0]);
            return yearB - yearA;  // Tri décroissant
        }).forEach(year => {
            selector.append(`<option value="${year}">${year}</option>`);
        });
    });
}

// Fonction pour initialiser tous les graphiques
function initializeCharts() {
    initializeEvolutionChart();
    initializeBoursiersPieChart();
    initializeNiveauxBarChart();
    initializeNationalitePieChart();
    initializeGenreDonutChart();   
    initializeEtrangersBarChart();
}

// Fonction pour initialiser le graphique d'évolution des effectifs
function initializeEvolutionChart() {
    // Obtenir les années et calculer le nombre total d'étudiants par année
    const years = getUniqueYears();
    const totalsByYear = {};
    
    // Initialiser les totaux à 0 pour chaque année
    years.forEach(function(year) {
        totalsByYear[year] = 0;
    });
    
    // Calculer le nombre d'étudiants par année
    etudiants.forEach(function(etudiant) {
        if (etudiant.annee && totalsByYear.hasOwnProperty(etudiant.annee)) {
            totalsByYear[etudiant.annee]++;
        }
    });
    
    // Créer les données pour le graphique
    const labels = Object.keys(totalsByYear).sort();
    const data = labels.map(year => totalsByYear[year]);
    
    // Créer le graphique
    const ctx = document.getElementById('evolutionChart').getContext('2d');
    charts.evolution = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Nombre total d\'étudiants',
                data: data,
                backgroundColor: chartColors.primary[0],
                borderColor: chartColors.borders[0],
                borderWidth: 2,
                tension: 0.3,
                fill: true,
                pointBackgroundColor: chartColors.borders[0],
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: false,
                    text: 'Évolution des effectifs par année'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Nombre d\'étudiants'
                    },
                    ticks: {
                        precision: 0 // Afficher des nombres entiers uniquement
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Année académique'
                    }
                }
            },
        }
    });
}

// Fonction pour initialiser le graphique camembert des boursiers
function initializeBoursiersPieChart() {
    // Compter les boursiers et non-boursiers (toutes années confondues initialement)
    updateBoursiersPieChart('');
}

// Fonction pour mettre à jour le graphique des boursiers en fonction de l'année sélectionnée
function updateBoursiersPieChart(selectedYear) {
    // Filtrer les étudiants par année si nécessaire
    let filteredData = etudiants;
    if (selectedYear) {
        filteredData = etudiants.filter(etudiant => etudiant.annee === selectedYear);
    }
    
    // Compter les boursiers et non-boursiers
    let boursiers = 0;
    let nonBoursiers = 0;
    
    filteredData.forEach(function(etudiant) {
        const boursierValue = etudiant['Boursier(ère)'] || etudiant.Boursier || 'Non';
        if (boursierValue.toLowerCase() === 'oui') {
            boursiers++;
        } else {
            nonBoursiers++;
        }
    });
    
    // Créer ou mettre à jour le graphique
    const ctx = document.getElementById('boursiersPieChart').getContext('2d');
    
    if (charts.boursiers) {
        charts.boursiers.data.datasets[0].data = [boursiers, nonBoursiers];
        charts.boursiers.update();
    } else {
        charts.boursiers = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Boursiers', 'Non-boursiers'],
                datasets: [{
                    data: [boursiers, nonBoursiers],
                    backgroundColor: [chartColors.primary[0], chartColors.primary[1]],
                    borderColor: chartColors.borders.slice(0, 2),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    title: {
                        display: true,
                        text: selectedYear ? `Boursiers ${selectedYear}` : 'Répartition des boursiers (toutes années)'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
}

// Fonction pour initialiser le graphique à barres des niveaux
function initializeNiveauxBarChart() {
    // Initialiser avec toutes les années
    updateNiveauxBarChart('');
}

// Fonction pour mettre à jour le graphique des niveaux en fonction de l'année sélectionnée
function updateNiveauxBarChart(selectedYear) {
    // Filtrer les étudiants par année si nécessaire
    let filteredData = etudiants;
    if (selectedYear) {
        filteredData = etudiants.filter(etudiant => etudiant.annee === selectedYear);
    }
    
    // Compter les étudiants par niveau
    const niveauxCounts = {};
    const niveaux = getUniqueNiveaux();
    
    // Initialiser les compteurs à 0
    niveaux.forEach(function(niveau) {
        niveauxCounts[niveau] = 0;
    });
    
    // Compter les étudiants par niveau
    filteredData.forEach(function(etudiant) {
        if (etudiant.niveau && niveauxCounts.hasOwnProperty(etudiant.niveau)) {
            niveauxCounts[etudiant.niveau]++;
        }
    });
    
    // Créer les données pour le graphique
    const labels = Object.keys(niveauxCounts).sort();
    const data = labels.map(niveau => niveauxCounts[niveau]);
    
    // Créer ou mettre à jour le graphique
    const ctx = document.getElementById('niveauxBarChart').getContext('2d');
    
    if (charts.niveaux) {
        charts.niveaux.data.labels = labels;
        charts.niveaux.data.datasets[0].data = data;
        charts.niveaux.options.plugins.title.text = selectedYear ? 
            `Effectifs par niveau - ${selectedYear}` : 
            'Effectifs par niveau (toutes années)';
        charts.niveaux.update();
    } else {
        charts.niveaux = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Nombre d\'étudiants',
                    data: data,
                    backgroundColor: chartColors.primary,
                    borderColor: chartColors.borders.slice(0, niveaux.length),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: selectedYear ? 
                            `Effectifs par niveau - ${selectedYear}` : 
                            'Effectifs par niveau (toutes années)'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Nombre d\'étudiants'
                        },
                        ticks: {
                            precision: 0
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Niveau d\'études'
                        }
                    }
                }
            }
        });
    }
}

// Fonction pour initialiser le graphique camembert des nationalités
function initializeNationalitePieChart() {
    // Compter les étudiants par nationalité
    const nationalitesCounts = {};
    const nationalites = getUniqueNationalites();
    
    // Initialiser les compteurs à 0
    nationalites.forEach(function(nationalite) {
        nationalitesCounts[nationalite] = 0;
    });
    
    // Compter les étudiants par nationalité
    etudiants.forEach(function(etudiant) {
        if (etudiant.Nationalité && nationalitesCounts.hasOwnProperty(etudiant.Nationalité)) {
            nationalitesCounts[etudiant.Nationalité]++;
        }
    });
    
    // Créer les données pour le graphique
    const labels = Object.keys(nationalitesCounts).filter(n => nationalitesCounts[n] > 0).sort();
    const data = labels.map(nationalite => nationalitesCounts[nationalite]);
    
    // Limite le nombre de nationalités affichées directement (regrouper les moins fréquentes)
    const maxNationalitesToShow = 8;
    if (labels.length > maxNationalitesToShow) {
        // Trier par fréquence
        const sortedData = labels.map((label, i) => ({ label, count: data[i] }))
            .sort((a, b) => b.count - a.count);
        
        // Prendre les N premières nationalités les plus fréquentes
        const topLabels = sortedData.slice(0, maxNationalitesToShow - 1).map(item => item.label);
        const topData = sortedData.slice(0, maxNationalitesToShow - 1).map(item => item.count);
        
        // Regrouper les autres
        const otherSum = sortedData.slice(maxNationalitesToShow - 1).reduce((sum, item) => sum + item.count, 0);
        
        // Créer les nouveaux tableaux de données
        const finalLabels = [...topLabels, 'Autres'];
        const finalData = [...topData, otherSum];
        
        // Créer le graphique
        createNationalitePieChart(finalLabels, finalData);
    } else {
        // Si nous avons moins de nationalités que le maximum, afficher toutes
        createNationalitePieChart(labels, data);
    }
}

// Fonction pour créer le graphique camembert des nationalités
function createNationalitePieChart(labels, data) {
    const ctx = document.getElementById('nationalitePieChart').getContext('2d');
    
    // Générer des couleurs pour chaque nationalité
    const backgroundColors = labels.map((_, i) => chartColors.primary[i % chartColors.primary.length]);
    const borderColors = labels.map((_, i) => chartColors.borders[i % chartColors.borders.length]);
    
    charts.nationalites = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: backgroundColors,
                borderColor: borderColors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        boxWidth: 15,
                        padding: 10,
                        font: {
                            size: 11
                        }
                    }
                },
                title: {
                    display: true,
                    text: 'Répartition par nationalité'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}
// Fonction pour initialiser le graphique donut des genres (étudiants uniques)
// Fonction pour initialiser le graphique donut des genres (étudiants uniques)
function initializeGenreDonutChart() {
    // Initialiser avec toutes les années
    updateGenreDonutChart('');
    
    // Ajouter un gestionnaire d'événements pour le changement d'année
    $('#genreDonutAnneeSelect').change(function() {
        updateGenreDonutChart($(this).val());
    });
}

// Fonction pour mettre à jour le graphique des genres en fonction de l'année sélectionnée
function updateGenreDonutChart(selectedYear) {
    // Créer un ensemble (Set) pour suivre les étudiants uniques par un identifiant composite
    const uniqueStudents = new Map();
    
    // Filtrer d'abord par année si nécessaire
    let filteredData = etudiants;
    if (selectedYear) {
        filteredData = etudiants.filter(etudiant => etudiant.annee === selectedYear);
    }
    
    // Parcourir les étudiants filtrés et conserver uniquement le plus récent pour chaque étudiant
    filteredData.forEach(function(etudiant) {
        // Créer une clé unique avec nom+prénom
        const nomPrenom = `${etudiant.Nom || ''}-${etudiant.Prénom || ''}`.toLowerCase();
        
        // Si l'étudiant n'existe pas encore OU si cet enregistrement est plus récent (année supérieure)
        if (!uniqueStudents.has(nomPrenom) || 
            (etudiant.annee && uniqueStudents.get(nomPrenom).annee && 
             etudiant.annee > uniqueStudents.get(nomPrenom).annee)) {
            uniqueStudents.set(nomPrenom, etudiant);
        }
    });
    
    // Compter les genres parmi les étudiants uniques
    let masculin = 0;
    let feminin = 0;
    let totalComptés = 0;
    
    uniqueStudents.forEach(function(etudiant) {
        const genre = etudiant.Genre ? etudiant.Genre.toLowerCase() : '';
        if (genre === 'masculin') {
            masculin++;
            totalComptés++;
        } else if (genre === 'féminin') {
            feminin++;
            totalComptés++;
        }
        // Les autres genres sont ignorés comme demandé
    });
    
    // Préparer les données pour le graphique
    const data = [masculin, feminin];
    const labels = ['Masculin', 'Féminin'];
    
    // Créer ou mettre à jour le graphique
    const ctx = document.getElementById('genreDonutChart').getContext('2d');
    
    if (charts.genreDonut) {
        charts.genreDonut.data.datasets[0].data = data;
        charts.genreDonut.options.plugins.title.text = 
            `Répartition par genre (${totalComptés} étudiants uniques comptabilisés)${selectedYear ? ' - ' + selectedYear : ''}`;
        charts.genreDonut.update();
    } else {
        charts.genreDonut = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        chartColors.primary[0], 
                        chartColors.primary[2]
                    ],
                    borderColor: [
                        chartColors.borders[0], 
                        chartColors.borders[2]
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%', // Taille du trou central (pour le doughnut)
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    title: {
                        display: true,
                        text: `Répartition par genre (${totalComptés} étudiants uniques comptabilisés)${selectedYear ? ' - ' + selectedYear : ''}`
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
}

// Fonction pour initialiser le graphique à barres des étudiants étrangers par niveau
function initializeEtrangersBarChart() {
    // Initialiser avec toutes les années
    updateEtrangersBarChart('');
    
    // Ajouter un gestionnaire d'événements pour le changement d'année
    $('#etrangersBarAnneeSelect').change(function() {
        updateEtrangersBarChart($(this).val());
    });
}

// Fonction pour mettre à jour le graphique des étudiants étrangers par niveau en fonction de l'année sélectionnée
function updateEtrangersBarChart(selectedYear) {
    // Obtenir les niveaux uniques
    const niveaux = getUniqueNiveaux();
    
    // Filtrer d'abord par année si nécessaire
    let filteredData = etudiants;
    if (selectedYear) {
        filteredData = etudiants.filter(etudiant => etudiant.annee === selectedYear);
    }
    
    // Structure pour stocker les comptages par nationalité et niveau
    const nationaliteCounts = {};
    
    // Parcourir les étudiants filtrés
    filteredData.forEach(function(etudiant) {
        const nationalite = etudiant.Nationalité || '';
        const niveau = etudiant.niveau || '';
        
        // Ignorer les étudiants français et ceux sans nationalité ou niveau
        if (!nationalite || !niveau || nationalite.toLowerCase() === 'française' || nationalite.toLowerCase() === 'francaise') {
            return;
        }
        
        // Initialiser le compteur pour cette nationalité si nécessaire
        if (!nationaliteCounts[nationalite]) {
            nationaliteCounts[nationalite] = {};
            niveaux.forEach(n => nationaliteCounts[nationalite][n] = 0);
        }
        
        // Incrémenter le compteur pour cette nationalité et ce niveau
        nationaliteCounts[nationalite][niveau]++;
    });
    
    // Limiter aux 6 nationalités les plus représentées (pour la lisibilité)
    const nationaliteTotals = {};
    Object.keys(nationaliteCounts).forEach(nat => {
        nationaliteTotals[nat] = Object.values(nationaliteCounts[nat]).reduce((a, b) => a + b, 0);
    });
    
    // Trier les nationalités par nombre total d'étudiants
    const topNationalites = Object.keys(nationaliteTotals)
        .sort((a, b) => nationaliteTotals[b] - nationaliteTotals[a])
        .slice(0, 6); // Prendre les 6 premières
    
    // Préparer les données pour le graphique
    const datasets = [];
    
    topNationalites.forEach((nationalite, index) => {
        // Données pour cette nationalité par niveau
        const data = niveaux.map(niveau => nationaliteCounts[nationalite][niveau]);
        
        // Couleur pour cette nationalité
        const color = chartColors.primary[index % chartColors.primary.length];
        const borderColor = chartColors.borders[index % chartColors.borders.length];
        
        datasets.push({
            label: nationalite,
            data: data,
            backgroundColor: color,
            borderColor: borderColor,
            borderWidth: 1
        });
    });
    
    // Créer ou mettre à jour le graphique
    const ctx = document.getElementById('etrangersBarChart').getContext('2d');
    
    if (charts.etrangersBar) {
        charts.etrangersBar.data.datasets = datasets;
        charts.etrangersBar.options.plugins.title.text = 
            `Étudiants étrangers par niveau${selectedYear ? ' - ' + selectedYear : ''}`;
        charts.etrangersBar.update();
    } else {
        charts.etrangersBar = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: niveaux,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    title: {
                        display: true,
                        text: `Étudiants étrangers par niveau${selectedYear ? ' - ' + selectedYear : ''}`
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Niveau d\'études'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Nombre d\'étudiants'
                        },
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    }
}
function editEtudiant(id, nom, prenom) {
    // Récupérer les données de l'étudiant
    const etudiant = etudiants.find(e => e.id === id);
    if (!etudiant) {
        showNotification('error', 'Étudiant non trouvé');
        return;
    }
    
    // Remplir le formulaire avec les données de l'étudiant
    $('#etudiantId').val(etudiant.id || '');
    $('#nom').val(etudiant.Nom || '');
    $('#prenom').val(etudiant.Prénom || '');
    $('#genre').val(etudiant.Genre || '');
    $('#niveau').val(etudiant.niveau || '');
    $('#annee').val(etudiant.annee || '');
    $('#nationalite').val(etudiant.Nationalité || '');
    $('#boursier').val(etudiant['Boursier(ère)'] || etudiant.Boursier || 'Non');
    $('#etranger').val(etudiant['Etranger(ère)'] || 'Non');
    $('#pays').val(etudiant.Pays || '');
    $('#tel').val(etudiant.tél || etudiant.tel || '');
    $('#mail').val(etudiant.mail || etudiant.email || '');
    $('#etablissement').val(etudiant.Etablissement || '');
    
    // Changer le titre du modal
    $('#addDataModalTitle').text('Modifier un étudiant');
    
    // Afficher le modal
    $('#addDataModal').modal('show');
}

// Fonction pour supprimer un étudiant
function deleteEtudiant(id, nom, prenom) {
    if (!id) {
        showNotification('error', 'ID étudiant manquant');
        return;
    }
    
    // Remplir le modal de confirmation
    $('#deleteYear').text(`${nom} ${prenom}`);
    $('#deleteId').val(id);
    
    // Afficher le modal de confirmation
    $('#deleteModal').modal('show');
}

// Fonction pour confirmer la suppression
function confirmDelete() {
    const id = $('#deleteId').val();
    
    if (!id) {
        showNotification('error', 'ID étudiant manquant');
        return;
    }
    
    // Fermer le modal de confirmation
    $('#deleteModal').modal('hide');
    
    // Envoyer la requête de suppression
    $.ajax({
        url: `/api/etudiants/delete/${id}/`,
        type: 'DELETE',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            showNotification('success', 'Étudiant supprimé avec succès');
            // Rafraîchir la page après un court délai
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        },
        error: function(xhr, status, error) {
            console.error("Erreur lors de la suppression:", xhr.responseText);
            showNotification('error', 'Erreur lors de la suppression de l\'étudiant');
        }
    });
}
function initializeAnimations() {
    // Animation des cartes graphiques au survol
    $('.card').hover(
        function() {
            $(this).find('canvas').css('transition', 'all 0.3s ease');
            $(this).find('canvas').css('transform', 'scale(1.02)');
        },
        function() {
            $(this).find('canvas').css('transform', 'scale(1)');
        }
    );
    
    // Animation d'entrée pour le tableau
    $('#etudiantsTable').css('opacity', '0');
    $('#etudiantsTable').css('transform', 'translateY(20px)');
    
    setTimeout(function() {
        $('#etudiantsTable').css({
            'transition': 'all 0.5s ease',
            'opacity': '1',
            'transform': 'translateY(0)'
        });
    }, 300);
    
    // Animation pour les boutons
    $('.btn').hover(
        function() {
            $(this).css('transition', 'all 0.3s ease');
            $(this).css('transform', 'translateY(-2px)');
            $(this).css('box-shadow', '0 4px 8px rgba(0,0,0,0.1)');
        },
        function() {
            $(this).css('transform', 'translateY(0)');
            $(this).css('box-shadow', 'none');
        }
    );
    
    // Animation pour l'ouverture des modals
    $('.modal').on('show.bs.modal', function() {
        $(this).find('.modal-content').css('opacity', '0');
        $(this).find('.modal-content').css('transform', 'translateY(-20px)');
        
        setTimeout(() => {
            $(this).find('.modal-content').css({
                'transition': 'all 0.3s ease',
                'opacity': '1',
                'transform': 'translateY(0)'
            });
        }, 150);
    });
}

// Fonction pour afficher les notifications
function showNotification(type, message) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
    
    const notification = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <i class="fas ${icon} mr-2"></i> ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    `;
    
    // Ajouter la notification en haut de la page
    const alertContainer = $('.alert-container');
    if (alertContainer.length) {
        alertContainer.append(notification);
    } else {
        $('<div class="alert-container mb-4"></div>').insertAfter('.header-custom').append(notification);
    }
    
    // Faire disparaître la notification après 5 secondes
    setTimeout(() => {
        $('.alert').alert('close');
    }, 5000);
}
// Fonction pour filtrer les données des étudiants pour exclure les diplômés
function filterNonDiplomes(allStudents) {
    // Retourne seulement les étudiants qui n'ont PAS de statut de diplômé
    return allStudents.filter(etudiant => {
        const statut = etudiant.statut || '';
        return !statut.startsWith('Diplômé');
    });
}
// Fonction pour initialiser le graphique de répartition des diplômés par niveau (camembert)
function initializeDiplomesNiveauChart() {
    // Compter les diplômés par niveau
    let fie5Count = 0;
    let fia5Count = 0;
    
    diplomes.forEach(function(etudiant) {
        const statut = etudiant.statut || '';
        if (statut.includes('FIE5')) fie5Count++;
        if (statut.includes('FIA5')) fia5Count++;
    });
    
    // Créer le graphique
    const ctx = document.getElementById('diplomesNiveauChart').getContext('2d');
    diplomesCharts.niveau = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['FIE5', 'FIA5'],
            datasets: [{
                data: [fie5Count, fia5Count],
                backgroundColor: [
                    chartColors.primary[0],
                    chartColors.primary[1]
                ],
                borderColor: [
                    chartColors.borders[0],
                    chartColors.borders[1]
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}
// Fonction pour extraire les diplômés
function extractDiplomes(allStudents) {
    // Retourne seulement les étudiants qui ont un statut de diplômé
    return allStudents.filter(etudiant => {
        const statut = etudiant.statut || '';
        return statut.startsWith('Diplômé');
    });
}

// Fonction pour obtenir les années de diplôme uniques
function getDiplomeYears() {
    const years = new Set();
    
    diplomes.forEach(function(etudiant) {
        const statut = etudiant.statut || '';
        // Extraire l'année de la chaîne "Diplômé FIXX 2024"
        const match = statut.match(/\d{4}/);
        if (match) {
            years.add(match[0]);
        }
    });
    
    return Array.from(years).sort().reverse(); // Tri décroissant (plus récent d'abord)
}

// Fonction pour remplir le sélecteur d'années de diplôme
function populateDiplomeYearSelector() {
    const years = getDiplomeYears();
    const selector = $('#diplomesAnneeFilter');
    
    // Vider le sélecteur sauf l'option par défaut
    selector.find('option:not(:first)').remove();
    
    // Ajouter les années
    years.forEach(year => {
        selector.append(`<option value="${year}">${year}</option>`);
    });
}

// Fonction pour initialiser le tableau des diplômés
function initializeDiplomesTable() {
    diplomesTable = $('#diplomesTable').DataTable({
        language: {
            url: "//cdn.datatables.net/plug-ins/1.10.25/i18n/French.json"
        },
        responsive: true,
        paging: true,
        pageLength: 6,
        pagingType: "full_numbers",
        ordering: true,
        searching: true,
        info: true,
        lengthChange: true,
        lengthMenu: [[6, 12, 24, 48, -1], [6, 12, 24, 48, "Tous"]],
        dom: '<"top"lf>rt<"bottom"ip>',
        order: [
            [0, 'asc']  // Trier par nom
        ]
    });
}

// Fonction pour charger les données dans le tableau des diplômés
function loadDiplomesTableData(data) {
    // Vider le tableau si déjà initialisé
    if (diplomesTable) {
        diplomesTable.clear();
    }
    
    // Ajouter chaque diplômé au tableau
    data.forEach(function(etudiant) {
        const nom = etudiant.Nom || '';
        const prenom = etudiant.Prénom || '';
        const genre = etudiant.Genre || '';
        const niveau = etudiant.niveau || '';
        const annee = etudiant.annee || '';
        const nationalite = etudiant.Nationalité || '';
        const boursier = etudiant['Boursier(ère)'] || etudiant.Boursier || 'Non';
        const tel = etudiant.tél || etudiant.tel || '';
        const mail = etudiant.mail || etudiant.email || '';

        // Créer un badge pour le statut boursier
        let boursierBadge = '';
        if (boursier.toLowerCase() === 'oui') {
            boursierBadge = `<span class="badge badge-boursier">Boursier</span>`;
        } else {
            boursierBadge = `<span class="badge badge-non-boursier">Non-boursier</span>`;
        }

        // Ajouter la ligne au tableau avec des cellules améliorées
        if (diplomesTable) {
            diplomesTable.row.add([
                `<span class="font-weight-bold">${nom}</span>`, 
                prenom, 
                genre === 'Masculin' ? `<i class="fas fa-mars text-primary mr-1"></i> ${genre}` : 
                                    `<i class="fas fa-venus text-danger mr-1"></i> ${genre}`, 
                `<span class="badge badge-primary">${niveau}</span>`, 
                annee, 
                `<span>${nationalite}</span>`, 
                boursierBadge, 
                tel ? `<a href="tel:${tel}" class="text-primary"><i class="fas fa-phone-alt mr-1"></i>${tel}</a>` : '', 
                mail ? `<a href="mailto:${mail}" class="text-primary"><i class="fas fa-envelope mr-1"></i>${mail}</a>` : ''
            ]);
        }
    });
    
    // Redessiner le tableau avec les nouvelles données
    if (diplomesTable) {
        diplomesTable.draw();
        // Initialiser les tooltips après avoir dessiné le tableau
        $('[data-toggle="tooltip"]').tooltip();
    }
}

// Fonction pour filtrer les diplômés
function applyDiplomesFilters() {
    const niveauFilter = $('#diplomesFilter').val();
    const anneeFilter = $('#diplomesAnneeFilter').val();
    
    // Filtrer les données
    let filteredData = diplomes.filter(function(etudiant) {
        let matchNiveau = true;
        let matchAnnee = true;
        
        if (niveauFilter) {
            // Si le filtre est sur FIE5 ou FIA5, vérifier que le statut contient cette chaîne
            matchNiveau = etudiant.statut && etudiant.statut.includes(niveauFilter);
        }
        
        if (anneeFilter) {
            // Vérifier que le statut contient l'année spécifiée
            matchAnnee = etudiant.statut && etudiant.statut.includes(anneeFilter);
        }
        
        return matchNiveau && matchAnnee;
    });
    
    // Mettre à jour le tableau avec les données filtrées
    loadDiplomesTableData(filteredData);
}

</script>
{% endblock %}