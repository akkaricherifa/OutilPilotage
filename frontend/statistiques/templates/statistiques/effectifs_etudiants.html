{% extends 'statistiques/base.html' %}

{% block title %}Effectifs Étudiants - Statistiques{% endblock %}

{% block extra_css %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap4.min.css">

<style>
    .stat-card {
        transition: transform 0.2s;
        border-left: 4px solid;
        margin-bottom: 20px;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .stat-card-fie1 { border-left-color: #2f0d73; }
    .stat-card-fie2 { border-left-color: #7c50de; }
    .stat-card-fie3 { border-left-color: #ac54c7; }
    .stat-card-total { border-left-color: #f56960; }
    .stat-card-boursiers { border-left-color: #ffb43c; }
    .stat-card-diplomes { border-left-color: #3cbebe; }
    
    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        border: 1px solid #e9ecef;
        height: 400px;
    }
    
    .chart-container h5 {
        color: #2f0d73;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    
    .dashboard-header {
        background: linear-gradient(135deg, #2f0d73 0%, #7c50de 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
    }
    
    .dashboard-header h1 {
        margin: 0;
        font-weight: 300;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 30px;
    }
    
    .modal-header-custom {
        background: linear-gradient(135deg, #2f0d73 0%, #7c50de 100%);
        color: white;
    }
    
    .form-control:focus {
        border-color: #7c50de;
        box-shadow: 0 0 0 0.2rem rgba(124, 80, 222, 0.25);
    }
    
    .btn-primary-custom {
        background: linear-gradient(135deg, #2f0d73 0%, #7c50de 100%);
        border: none;
        color: white;
    }
    
    .btn-primary-custom:hover {
        background: linear-gradient(135deg, #7c50de 0%, #ac54c7 100%);
    }

    canvas {
        max-height: 300px;
    }
    
    @media (max-width: 768px) {
        .chart-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- En-tête du dashboard -->
<div class="dashboard-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1><i class="fas fa-users mr-3"></i>Effectifs Étudiants</h1>
            <p class="mb-0">Analyse complète des données d'effectifs par niveau</p>
        </div>
        <div class="action-buttons d-flex flex-wrap">
            <button class="btn btn-light btn-lg mr-2" data-toggle="modal" data-target="#addDataModal">
                <i class="fas fa-plus mr-2"></i>Ajouter des données
            </button>
            <button class="btn btn-success btn-lg mr-2" data-toggle="modal" data-target="#uploadCSVModal">
                <i class="fas fa-file-upload mr-2"></i>Importer CSV
            </button>
            <button class="btn btn-warning btn-lg" onclick="refreshAllCharts()">
                <i class="fas fa-sync mr-2"></i>Actualiser
            </button>
        </div>
    </div>
</div>

{% if stats %}
<!-- Statistiques résumées -->
<div class="stats-grid">
    <div class="card stat-card stat-card-fie1">
        <div class="card-body text-center">
            <h3 style="color: #2f0d73;">{{ stats.total_students.fie1 }}</h3>
            <p class="mb-0">Étudiants FIE1</p>
        </div>
    </div>
    <div class="card stat-card stat-card-fie2">
        <div class="card-body text-center">
            <h3 style="color: #7c50de;">{{ stats.total_students.fie2 }}</h3>
            <p class="mb-0">Étudiants FIE2</p>
        </div>
    </div>
    <div class="card stat-card stat-card-fie3">
        <div class="card-body text-center">
            <h3 style="color: #ac54c7;">{{ stats.total_students.fie3 }}</h3>
            <p class="mb-0">Étudiants FIE3</p>
        </div>
    </div>
    <div class="card stat-card stat-card-total">
        <div class="card-body text-center">
            <h3 style="color: #f56960;">{{ stats.total_students.fie1|add:stats.total_students.fie2|add:stats.total_students.fie3 }}</h3>
            <p class="mb-0">Total Étudiants</p>
        </div>
    </div>
    <div class="card stat-card stat-card-boursiers">
        <div class="card-body text-center">
            <h3 style="color: #ffb43c;">{{ stats.avg_taux_boursiers|floatformat:1 }}%</h3>
            <p class="mb-0">Taux moyen boursiers</p>
        </div>
    </div>
    <div class="card stat-card stat-card-diplomes">
        <div class="card-body text-center">
            <h3 style="color: #3cbebe;">{{ stats.total_diplomes }}</h3>
            <p class="mb-0">Total diplômés</p>
        </div>
    </div>
    <!-- Cartes statistiques pour le genre -->
    <div class="card stat-card" style="border-left-color: #ff6b94;">
        <div class="card-body text-center">
            <h3 style="color: #ff6b94;">
                {% for item in stats.evolution_annuelle %}
                    {% if forloop.last %}{{ item.nombre_femmes|default:0 }}{% endif %}
                {% endfor %}
            </h3>
            <p class="mb-0">Étudiantes (Dernière année)</p>
        </div>
    </div>
    <div class="card stat-card" style="border-left-color: #4dabf7;">
        <div class="card-body text-center">
            <h3 style="color: #4dabf7;">
                {% for item in stats.evolution_annuelle %}
                    {% if forloop.last %}{{ item.nombre_hommes|default:0 }}{% endif %}
                {% endfor %}
            </h3>
            <p class="mb-0">Étudiants (Dernière année)</p>
        </div>
    </div>
</div>

<!-- Graphiques -->
<div class="chart-grid">
    <!-- Graphique 1: Évolution des effectifs (Courbe) -->
    <div class="chart-container">
        <h5><i class="fas fa-chart-line mr-2"></i>Évolution des Effectifs par Niveau</h5>
        <canvas id="evolutionChart"></canvas>
    </div>

    <!-- Graphique 2: Répartition par niveau (Camembert) -->
    <div class="chart-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5><i class="fas fa-chart-pie mr-2"></i>Répartition par Niveau</h5>
            <select id="yearSelector" class="form-control" style="width: 150px;">
                <option value="">Toutes les années</option>
            </select>
        </div>
        <canvas id="pieChart"></canvas>
    </div>

    <!-- Graphique 3: Évolution du Total des Étudiants -->
    <div class="chart-container">
        <h5><i class="fas fa-chart-bar mr-2"></i>Évolution du Total des Étudiants</h5>
        <canvas id="totalStudentsChart"></canvas>
    </div>

    <!-- Graphique 4: Taux de boursiers (Histogramme) -->
    <div class="chart-container">
        <h5><i class="fas fa-chart-bar mr-2"></i>Évolution du Taux de Boursiers</h5>
        <canvas id="barChart"></canvas>
    </div>

    <!-- Graphique 5: Comparaison multicritères (Radar) -->
    <div class="chart-container">
        <h5><i class="fas fa-chart-area mr-2"></i>Comparaison Multicritères</h5>
        <canvas id="radarChart"></canvas>
    </div>

    <!-- Graphique 6: Répartition par genre -->
    <div class="chart-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5><i class="fas fa-venus-mars mr-2"></i>Répartition par Genre</h5>
            <select id="genderYearSelector" class="form-control" style="width: 150px;">
                <option value="">Toutes les années</option>
            </select>
        </div>
        <canvas id="genderChart"></canvas>
    </div>
</div>

<!-- Tableau des données -->
<div class="chart-container" style="height: auto;">
    <h5><i class="fas fa-table mr-2"></i>Données Détaillées par Année</h5>
    <div class="table-responsive">
        <table class="table table-striped table-hover" id="effectifsTable">
            <thead style="background: linear-gradient(135deg, #2f0d73 0%, #7c50de 100%); color: white;">
                <tr>
                    <th>Année</th>
                    <th>FIE1</th>
                    <th>FIE2</th>
                    <th>FIE3</th>
                    <th>Total</th>
                    <th>Taux Boursiers</th>
                    <th>Diplômés</th>
                    <th>Femmes</th>
                    <th>Hommes</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in stats.evolution_annuelle %}
                <tr>
                    <td><strong>{{ item.annee }}</strong></td>
                    <td>{{ item.nombre_fie1 }}</td>
                    <td>{{ item.nombre_fie2 }}</td>
                    <td>{{ item.nombre_fie3 }}</td>
                    <td><strong>{{ item.nombre_fie1|add:item.nombre_fie2|add:item.nombre_fie3 }}</strong></td>
                    <td>{{ item.taux_boursiers|floatformat:2 }}%</td>
                    <td>{{ item.nombre_diplomes }}</td>
                    <td>{{ item.nombre_femmes|default:0 }}</td>
                    <td>{{ item.nombre_hommes|default:0 }}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editData({{ item|safe }})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete({{ item.annee }})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% else %}
<!-- Message si pas de données -->
<div class="chart-container" style="height: auto;">
    <div class="text-center py-5">
        <i class="fas fa-chart-line fa-5x text-muted mb-4"></i>
        <h3>Aucune donnée disponible</h3>
        <p class="text-muted mb-4">Commencez par ajouter des données d'effectifs étudiants.</p>
        <div>
            <button class="btn btn-primary btn-lg mr-3" data-toggle="modal" data-target="#addDataModal">
                <i class="fas fa-plus mr-2"></i>Ajouter des données
            </button>
            <button class="btn btn-success btn-lg" data-toggle="modal" data-target="#uploadCSVModal">
                <i class="fas fa-file-upload mr-2"></i>Importer CSV
            </button>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal Ajouter/Modifier des données -->
<div class="modal fade" id="addDataModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title" id="addDataModalTitle">Ajouter des données</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="dataForm" method="post" action="{% url 'update_data' %}">
                {% csrf_token %}
                <input type="hidden" name="source" value="effectifs">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Année <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" name="annee" id="annee" required min="2000" max="2100">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Nombre FIE1 <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" name="nombre_fie1" id="nombre_fie1" required min="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Nombre FIE2 <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" name="nombre_fie2" id="nombre_fie2" required min="0">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Nombre FIE3 <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" name="nombre_fie3" id="nombre_fie3" required min="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Taux de boursiers (0-1) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" name="taux_boursiers" id="taux_boursiers" 
                                       required min="0" max="1" step="0.01">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Nombre de diplômés <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" name="nombre_diplomes" id="nombre_diplomes" required min="0">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Nombre d'étudiants handicapés</label>
                                <input type="number" class="form-control" name="nombre_handicapes" id="nombre_handicapes" min="0" value="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Nombre d'étudiants étrangers</label>
                                <input type="number" class="form-control" name="nombre_etrangers" id="nombre_etrangers" min="0" value="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Nombre de démissions</label>
                                <input type="number" class="form-control" name="nombre_demissionnes" id="nombre_demissionnes" min="0" value="0">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Nombre d'étudiantes (Femme)</label>
                                <input type="number" class="form-control" name="nombre_femmes" id="nombre_femmes" min="0" value="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Nombre d'étudiants (Homme)</label>
                                <input type="number" class="form-control" name="nombre_hommes" id="nombre_hommes" min="0" value="0">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary-custom">
                        <i class="fas fa-save mr-1"></i>Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Upload CSV -->
<div class="modal fade" id="uploadCSVModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title">Importer un fichier CSV</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="uploadForm" method="post" enctype="multipart/form-data" action="{% url 'upload_csv' %}">
                {% csrf_token %}
                <input type="hidden" name="source" value="effectifs">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Fichier CSV <span class="text-danger">*</span></label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="csvFile" name="file" accept=".csv" required>
                            <label class="custom-file-label" for="csvFile">Choisir un fichier...</label>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle mr-2"></i>Format attendu du fichier CSV :</h6>
                        <code>annee,nombre_fie1,nombre_fie2,nombre_fie3,taux_boursiers,nombre_diplomes,nombre_handicapes,nombre_etrangers,nombre_demissionnes,nombre_femmes,nombre_hommes</code>
                        <hr>
                        <h6>Exemple :</h6>
                        <pre class="mb-0">2023,133,102,94,0.2,70,11,11,7,150,179
2024,139,102,96,0.28,78,11,12,6,160,177
2025,116,91,80,0.34,81,12,15,4,140,147</pre>
                    </div>
                    <div class="form-group">
                        <label>Nom du fichier</label>
                        <input type="text" class="form-control" name="name" placeholder="Effectifs 2025" required>
                    </div>
                    <div class="form-group">
                        <label>Description (optionnel)</label>
                        <textarea class="form-control" name="description" rows="3" 
                                  placeholder="Description du fichier importé..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload mr-1"></i>Importer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de confirmation de suppression -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirmer la suppression</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Êtes-vous sûr de vouloir supprimer les données pour l'année <span id="deleteYear" class="font-weight-bold"></span> ?
                <br><small class="text-muted">Cette action est irréversible.</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" onclick="deleteData()">
                    <i class="fas fa-trash mr-1"></i>Supprimer
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- DataTables JS -->
<script type="text/javascript" src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap4.min.js"></script>

<script>
// Variables globales
let deleteYear = null;
let charts = {};

// Récupère le token API depuis la session Django
function getApiToken() {
    return '{{ request.session.api_token }}';
}

$(document).ready(function() {
    // Initialiser DataTable
    $('#effectifsTable').DataTable({
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/French.json"
        },
        "order": [[0, "desc"]],
        "pageLength": 10,
        "responsive": true
    });

    // Charger les graphiques
    {% if stats %}
    loadCharts();
    {% endif %}

    // Gestion du nom de fichier pour l'upload
    $('.custom-file-input').on('change', function() {
        let fileName = $(this).val().split('\\').pop();
        $(this).siblings('.custom-file-label').addClass("selected").html(fileName);
    });

    // Gestionnaire pour le changement d'année dans le pie chart
    $(document).on('change', '#yearSelector', function() {
        const evolutionData = {{ stats.evolution_annuelle|safe }};
        updatePieChart(evolutionData);
    });

    // Gestionnaire pour le changement d'année dans le graphique genre
    $(document).on('change', '#genderYearSelector', function() {
        const evolutionData = {{ stats.evolution_annuelle|safe }};
        updateGenderChart(evolutionData);
    });

    // Soumission du formulaire de données via AJAX
    $('#dataForm').on('submit', function(e) {
        e.preventDefault();
        
        // Afficher un indicateur de chargement
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.html('<i class="fas fa-spinner fa-spin mr-1"></i>Enregistrement...').prop('disabled', true);
        
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: $(this).serialize(),
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                $('#addDataModal').modal('hide');
                showNotification('success', 'Données enregistrées avec succès !');
                
                // Redirection vers la même page après un court délai
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            },
            error: function(xhr, status, error) {
                console.error("Erreur AJAX:", xhr.responseText);
                try {
                    const response = JSON.parse(xhr.responseText);
                    showNotification('error', response.message || response.error || 'Erreur lors de l\'enregistrement des données.');
                } catch (e) {
                    showNotification('error', 'Erreur lors de l\'enregistrement des données.');
                }
            },
            complete: function() {
                // Restaurer le bouton
                submitBtn.html(originalText).prop('disabled', false);
            }
        });
    });

    // Soumission du formulaire CSV via AJAX
    $('#uploadForm').on('submit', function(e) {
        e.preventDefault();
        
        // Afficher un indicateur de chargement
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.html('<i class="fas fa-spinner fa-spin mr-1"></i>Importation...').prop('disabled', true);
        
        let formData = new FormData(this);
        
        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                $('#uploadCSVModal').modal('hide');
                showNotification('success', 'Fichier CSV importé avec succès !');
                
                // Redirection vers la même page après un court délai
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            },
            error: function(xhr, status, error) {
                console.error("Erreur AJAX:", xhr.responseText);
                try {
                    const response = JSON.parse(xhr.responseText);
                    showNotification('error', response.message || response.error || 'Erreur lors de l\'importation du fichier CSV.');
                } catch (e) {
                    showNotification('error', 'Erreur lors de l\'importation du fichier CSV.');
                }
            },
            complete: function() {
                // Restaurer le bouton
                submitBtn.html(originalText).prop('disabled', false);
            }
        });
    });
});

// Charger tous les graphiques
function loadCharts() {
    // CORRECTION: Récupération sécurisée des données
    const evolutionData = {{ stats.evolution_annuelle|safe }};
    
    if (!evolutionData || evolutionData.length === 0) {
        console.warn('Aucune donnée disponible pour les graphiques');
        return;
    }

    // Peupler les sélecteurs d'années
    populateYearSelector(evolutionData);
    populateGenderYearSelector(evolutionData);

    // 1. Graphique en courbe - Évolution des effectifs
    const ctxEvolution = document.getElementById('evolutionChart').getContext('2d');
    charts.evolution = new Chart(ctxEvolution, {
        type: 'line',
        data: {
            labels: evolutionData.map(item => item.annee),
            datasets: [{
                label: 'FIE1',
                data: evolutionData.map(item => item.nombre_fie1),
                borderColor: '#2f0d73',
                backgroundColor: 'rgba(47, 13, 115, 0.1)',
                tension: 0.3
            }, {
                label: 'FIE2',
                data: evolutionData.map(item => item.nombre_fie2),
                borderColor: '#7c50de',
                backgroundColor: 'rgba(124, 80, 222, 0.1)',
                tension: 0.3
            }, {
                label: 'FIE3',
                data: evolutionData.map(item => item.nombre_fie3),
                borderColor: '#ac54c7',
                backgroundColor: 'rgba(172, 84, 199, 0.1)',
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            }
        }
    });

    // 2. Camembert - Répartition par niveau (données par défaut: dernière année)
    updatePieChart(evolutionData);

    // 3. Graphique du total des étudiants par année
    const ctxTotal = document.getElementById('totalStudentsChart').getContext('2d');
    charts.totalStudents = new Chart(ctxTotal, {
        type: 'bar',
        data: {
            labels: evolutionData.map(item => item.annee),
            datasets: [{
                label: 'Total Étudiants',
                data: evolutionData.map(item => 
                    (item.nombre_fie1 || 0) + (item.nombre_fie2 || 0) + (item.nombre_fie3 || 0)
                ),
                backgroundColor: 'rgba(47, 13, 115, 0.8)',
                borderColor: '#2f0d73',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // 4. Histogramme - Taux de boursiers
    const ctxBar = document.getElementById('barChart').getContext('2d');
    charts.bar = new Chart(ctxBar, {
        type: 'bar',
        data: {
            labels: evolutionData.map(item => item.annee),
            datasets: [{
                label: 'Taux de boursiers (%)',
                data: evolutionData.map(item => (item.taux_boursiers || 0) * 100),
                backgroundColor: '#ffb43c'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });

    // 5. Radar - Comparaison multicritères
    const lastThreeYears = evolutionData.slice(-3);
    const ctxRadar = document.getElementById('radarChart').getContext('2d');
    charts.radar = new Chart(ctxRadar, {
        type: 'radar',
        data: {
            labels: ['FIE1', 'FIE2', 'FIE3', 'Diplômés', 'Taux boursiers'],
            datasets: lastThreeYears.map((year, index) => ({
                label: year.annee.toString(),
                data: [
                    year.nombre_fie1,
                    year.nombre_fie2,
                    year.nombre_fie3,
                    year.nombre_diplomes,
                    (year.taux_boursiers || 0) * 100
                ],
                borderColor: ['#2f0d73', '#7c50de', '#ac54c7'][index],
                backgroundColor: ['rgba(47, 13, 115, 0.2)', 'rgba(124, 80, 222, 0.2)', 'rgba(172, 84, 199, 0.2)'][index]
            }))
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // 6. Graphique de répartition par genre
    updateGenderChart(evolutionData);
}

// Peupler le sélecteur d'années
function populateYearSelector(data) {
    const yearSelector = document.getElementById('yearSelector');
    
    // Vider le sélecteur
    yearSelector.innerHTML = '<option value="">Toutes les années</option>';
    
    // Ajouter les années disponibles
    const years = data.map(item => item.annee).sort((a, b) => b - a); // Tri décroissant
    years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelector.appendChild(option);
    });
    
    // Sélectionner la dernière année par défaut
    if (years.length > 0) {
        yearSelector.value = years[0];
    }
}

// Peupler le sélecteur d'années pour le graphique genre
function populateGenderYearSelector(data) {
    const yearSelector = document.getElementById('genderYearSelector');
    
    // Vider le sélecteur
    yearSelector.innerHTML = '<option value="">Toutes les années</option>';
    
    // Ajouter les années disponibles
    const years = data.map(item => item.annee).sort((a, b) => b - a); // Tri décroissant
    years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearSelector.appendChild(option);
    });
    
    // Sélectionner la dernière année par défaut
    if (years.length > 0) {
        yearSelector.value = years[0];
    }
}

// Mettre à jour le graphique pie en fonction de l'année sélectionnée
function updatePieChart(allData) {
    const yearSelector = document.getElementById('yearSelector');
    const selectedYear = yearSelector.value;
    
    let dataToShow;
    if (selectedYear === '') {
        // Toutes les années: calculer la somme
        const totals = allData.reduce((acc, item) => {
            acc.fie1 += item.nombre_fie1 || 0;
            acc.fie2 += item.nombre_fie2 || 0;
            acc.fie3 += item.nombre_fie3 || 0;
            return acc;
        }, { fie1: 0, fie2: 0, fie3: 0 });
        
        dataToShow = {
            labels: ['FIE1 (Total)', 'FIE2 (Total)', 'FIE3 (Total)'],
            data: [totals.fie1, totals.fie2, totals.fie3]
        };
    } else {
        // Année spécifique
        const yearData = allData.find(item => item.annee == selectedYear);
        if (yearData) {
            dataToShow = {
                labels: [`FIE1 (${selectedYear})`, `FIE2 (${selectedYear})`, `FIE3 (${selectedYear})`],
                data: [yearData.nombre_fie1 || 0, yearData.nombre_fie2 || 0, yearData.nombre_fie3 || 0]
            };
        }
    }
    
    // Détruire le graphique existant s'il existe
    if (charts.pie) {
        charts.pie.destroy();
    }
    
    // Créer le nouveau graphique pie
    const ctxPie = document.getElementById('pieChart').getContext('2d');
    charts.pie = new Chart(ctxPie, {
        type: 'pie',
        data: {
            labels: dataToShow.labels,
            datasets: [{
                data: dataToShow.data,
                backgroundColor: ['#2f0d73', '#7c50de', '#ac54c7']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                }
            }
        }
    });
}

// Mettre à jour le graphique genre en fonction de l'année sélectionnée
function updateGenderChart(allData) {
    const yearSelector = document.getElementById('genderYearSelector');
    const selectedYear = yearSelector.value;
    
    let dataToShow;
    if (selectedYear === '') {
        // Toutes les années: calculer la somme
        const totals = allData.reduce((acc, item) => {
            acc.femmes += item.nombre_femmes || 0;
            acc.hommes += item.nombre_hommes || 0;
            return acc;
        }, { femmes: 0, hommes: 0 });
        
        dataToShow = {
            labels: ['Femmes (Total)', 'Hommes (Total)'],
            data: [totals.femmes, totals.hommes],
            total: totals.femmes + totals.hommes
        };
    } else {
        // Année spécifique
        const yearData = allData.find(item => item.annee == selectedYear);
        if (yearData) {
            const femmes = yearData.nombre_femmes || 0;
            const hommes = yearData.nombre_hommes || 0;
            dataToShow = {
                labels: [`Femmes (${selectedYear})`, `Hommes (${selectedYear})`],
                data: [femmes, hommes],
                total: femmes + hommes
            };
        }
    }
    
    // Détruire le graphique existant s'il existe
    if (charts.gender) {
        charts.gender.destroy();
    }
    
    // Créer le nouveau graphique genre
    const ctxGender = document.getElementById('genderChart').getContext('2d');
    charts.gender = new Chart(ctxGender, {
        type: 'pie',
        data: {
            labels: dataToShow.labels,
            datasets: [{
                data: dataToShow.data,
                backgroundColor: ['#ff6b94', '#4dabf7'], // Rose pour femmes, bleu pour hommes
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            const percentage = dataToShow.total > 0 ? 
                                ((value / dataToShow.total) * 100).toFixed(1) : 0;
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Fonction pour éditer les données
function editData(data) {
    // Si les données sont passées en string, les parser
    if (typeof data === 'string') {
        try {
            data = JSON.parse(data);
        } catch (e) {
            console.error('Erreur parsing data:', e);
            return;
        }
    }
    
    $('#addDataModalTitle').text('Modifier les données - Année ' + data.annee);
    $('#annee').val(data.annee).prop('readonly', true);
    $('#nombre_fie1').val(data.nombre_fie1);
    $('#nombre_fie2').val(data.nombre_fie2);
    $('#nombre_fie3').val(data.nombre_fie3);
    $('#taux_boursiers').val(data.taux_boursiers);
    $('#nombre_diplomes').val(data.nombre_diplomes);
    $('#nombre_handicapes').val(data.nombre_handicapes || 0);
    $('#nombre_etrangers').val(data.nombre_etrangers || 0);
    $('#nombre_demissionnes').val(data.nombre_demissionnes || 0);
    $('#nombre_femmes').val(data.nombre_femmes || 0);
    $('#nombre_hommes').val(data.nombre_hommes || 0);
    
    $('#addDataModal').modal('show');
}

// Réinitialiser le formulaire quand on ferme la modal
$('#addDataModal').on('hidden.bs.modal', function () {
    $('#addDataModalTitle').text('Ajouter des données');
    $('#annee').prop('readonly', false);
    $('#dataForm')[0].reset();
});

// Confirmer la suppression
function confirmDelete(annee) {
    deleteYear = annee;
    $('#deleteYear').text(annee);
    $('#deleteModal').modal('show');
}

// Supprimer les données
function deleteData() {
    if (!deleteYear) return;
    
    // Obtenir le token JWT de la session
    const token = getApiToken();
    
    $.ajax({
        url: `/api/data/delete/${deleteYear}`,
        type: 'DELETE',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
            'Authorization': `Bearer ${token}`
        },
        success: function(response) {
            $('#deleteModal').modal('hide');
            showNotification('success', 'Données supprimées avec succès !');
            
            // Redirection vers la même page après un court délai
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        },
        error: function(xhr) {
            showNotification('error', 'Erreur lors de la suppression des données.');
        }
    });
}

// Actualiser tous les graphiques
function refreshAllCharts() {
    // Détruire les graphiques existants
    Object.values(charts).forEach(chart => {
        if (chart && typeof chart.destroy === 'function') {
            chart.destroy();
        }
    });
    // Vider l'objet charts
    charts = {};
    
    // Recharger les graphiques
    {% if stats %}
    loadCharts();
    {% endif %}
    showNotification('success', 'Graphiques actualisés !');
}

// Afficher une notification
function showNotification(type, message) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const icon = type === 'success' ? 'check-circle' : 'exclamation-triangle';
    
    // Créer la notification
    const notification = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <i class="fas fa-${icon} mr-2"></i>
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    `;
    
    // Ajouter à la page
    const container = document.createElement('div');
    container.style.position = 'fixed';
    container.style.top = '20px';
    container.style.right = '20px';
    container.style.zIndex = '9999';
    container.innerHTML = notification;
    document.body.appendChild(container);
    
    // Supprimer après 3 secondes
    setTimeout(() => {
        container.querySelector('.alert').classList.remove('show');
        setTimeout(() => container.remove(), 300);
    }, 3000);
}
</script>
{% endblock %}